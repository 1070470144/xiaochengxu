# 血染百科 v2.1 - 详细内容解析方案

## 🎯 升级目标

**从简单文本解析 → 完整结构化解析**

---

## 📋 需要解析的字段清单

### 1. 基础信息
- ✅ 角色名称（title）
- ✅ 角色Logo（icon_url）

### 2. 内容章节（按顺序）

#### 📖 背景故事（Background Story）
```
格式：单段文本，通常在引号内
示例："晚礼服上的血渍？才不是呢，这只是洒上了雪莉酒。真粗心！"
```

#### 🎯 角色能力（Ability）
```
格式：单段文本，描述角色的核心能力
示例："在你的首个夜晚，你会得知两名玩家和一个镇民角色：这两名玩家之一是该角色。"
```

#### 📝 角色简介（Introduction）
```
格式：多段文本数组
示例：
[
  "洗衣妇会得知一个特定的在场镇民角色，但不知道是谁在扮演该角色。",
  "在第一个夜晚，洗衣妇会被唤醒，得知两名玩家，并得知其中一人的角色。",
  "洗衣妇只会得知一次信息，之后便无法获取更多信息。"
]
```

#### 📌 范例（Examples）
```
格式：对象数组，每个包含场景和结果
示例：
[
  {
    scenario: "小文是厨师，小米是守鸦人。",
    result: "洗衣妇得知要么小文是厨师，要么小米是厨师。"
  },
  {
    scenario: "小佳是小恶魔，小艾是贞洁者。",
    result: "洗衣妇得知要么小佳是贞洁者，要么小艾是贞洁者。"
  }
]
```

#### ⚙️ 运作方式（Mechanics）
```
格式：字符串数组，描述说书人操作步骤
示例：
[
  "在为首个夜晚进行准备时，将洗衣妇的"镇民"提示标记放置在任意一个镇民角色标记旁...",
  "在首个夜晚里，唤醒洗衣妇，并指向标记有"镇民"和"错误"的玩家...",
  "让洗衣妇重新入睡。在说书人方便的时候，移除洗衣妇的提示标记。"
]
```

#### 🏷️ 提示标记（Reminder Tokens）
```
格式：对象数组，每个标记包含名称和详细说明
示例：
[
  {
    name: "镇民",
    icon: "🎯",
    details: [
      "放置时机：在为首个夜晚做准备时放置。",
      "放置条件：放置在一个镇民角色或能被当作镇民角色的角色标记旁边。",
      "移除时机：在洗衣妇获取信息后，说书人可以任由自己方便来进行移除。"
    ]
  },
  {
    name: "错误",
    icon: "❌",
    details: [
      "放置时机：在为首个夜晚做准备时放置。",
      "放置条件：放置在未放置"镇民"提示标记的其他任意一个角色标记旁边。",
      "移除时机：在洗衣妇获取信息后，说书人可以任由自己方便来进行移除。"
    ]
  }
]
```

#### 📜 规则细节（Rule Details）
```
格式：字符串数组
示例：
[
  "不同于图书管理员和调查员，洗衣妇永远不可能得知没有镇民在场...",
  "如果在首夜就中毒或醉酒，洗衣妇可能会得知错误的玩家...",
  "特定角色互动：间谍：洗衣妇能将间谍当作镇民..."
]
```

#### 💡 提示与技巧（Tips and Tricks）
```
格式：字符串数组
示例：
[
  "洗衣妇这个角色看起来非常强大。虽然你无法从邪恶阵营的玩家身上获取信息...",
  "与其他角色相比，处于醉酒或中毒状态的洗衣妇还是比较容易发现自己获取了错误信息的...",
  "要去识别这两位玩家中哪一位是镇民的方法..."
]
```

#### 🎭 伪装方法（Bluffing）
```
格式：字符串数组
示例：
[
  "声明自己是洗衣妇并指向至少一位邪恶阵营的玩家...",
  "如果一个善良阵营的玩家说自己是某个镇民角色...",
  "在大家刚醒来的时候，就立刻告诉大家在场有某个具体的角色..."
]
```

#### ℹ️ 角色信息（Character Info）
```
格式：对象，包含各种属性
示例：
{
  english_name: "Washerwoman",
  belongs_to_scripts: ["暗流涌动"],
  character_type: "镇民",
  ability_category: ["获取信息", "进场能力"],
  first_night_order: 23,
  other_nights_order: null
}
```

---

## 💻 解析算法设计

### 核心思路

**识别章节 → 提取内容 → 结构化存储**

### 章节识别规则

```javascript
const sectionPatterns = {
  背景故事: /背景故事[\s\S]*?"([^"]+)"/,
  角色能力: /角色能力\s+(.*?)(?=角色简介|$)/s,
  角色简介: /角色简介\s+([\s\S]*?)(?=范例|$)/,
  范例: /范例\s+([\s\S]*?)(?=运作方式|$)/,
  运作方式: /运作方式\s+([\s\S]*?)(?=提示标记|$)/,
  提示标记: /提示标记\s+([\s\S]*?)(?=规则细节|$)/,
  规则细节: /规则细节\s+([\s\S]*?)(?=提示与技巧|$)/,
  提示与技巧: /提示与技巧\s+([\s\S]*?)(?=伪装成|$)/,
  伪装成: /伪装成.*?\s+([\s\S]*?)(?=角色信息|$)/,
  角色信息: /角色信息\s+([\s\S]*?)$/
};
```

---

## 🔧 实施计划

### 阶段1：增强解析云函数（2天）

#### 文件修改：
- `wiki-admin-sync-all/index.js`
- `wiki-admin-sync-single/index.obj.js`

#### 新增函数：
```javascript
// 解析背景故事
function parseBackgroundStory(html)

// 解析角色能力
function parseAbility(html)

// 解析角色简介（多段）
function parseIntroduction(html)

// 解析范例（场景+结果）
function parseExamples(html)

// 解析运作方式（步骤）
function parseMechanics(html)

// 解析提示标记（标记名+详情）
function parseReminderTokens(html)

// 解析规则细节（多条）
function parseRuleDetails(html)

// 解析提示与技巧（多条）
function parseTips(html)

// 解析伪装方法（多条）
function parseBluffing(html)

// 解析角色信息（属性）
function parseCharacterInfo(html)
```

---

### 阶段2：优化数据结构（0.5天）

#### 更新 Schema：
- `wiki_entries.schema.json` 添加 `role_detail` 字段

---

### 阶段3：优化展示页面（2天）

#### 小程序端详情页：
- 分段展示内容
- 折叠/展开功能
- 美化UI

---

## 💰 成本分析

### 开发成本
- **时间**：5-7天
- **工作量**：30-40小时

### 收益
- ✅ 内容完整详细
- ✅ 结构清晰
- ✅ 用户体验极佳
- ✅ 可作为完整的角色查询工具

---

## 🎯 您的确认

请确认：
1. ✅ 需要完整的内容解析
2. ✅ 愿意投入5-7天开发时间
3. ✅ 需要我现在开始实施

回复 **/implement** 我将立即开始开发v2.1增强解析功能！

---

**升级版本**: v2.1.0  
**功能名称**: 详细内容结构化解析  
**开发时间**: 5-7天  
**优先级**: 🔴 高（极大提升用户体验）
