# 血染百科 - 用户端更新指南

## 📱 更新概述

### 版本
- **小程序端**: botc-miniprogram
- **更新日期**: 2025-10-18
- **功能**: 工具 → 血染百科

### 核心改进
1. ✅ **数据源改为管理端**：从 `wiki_entries` 数据库读取管理员同步的数据
2. ✅ **移除导入功能**：普通用户不再需要手动导入，由管理员统一管理
3. ✅ **无需登录即可查看**：所有用户都能浏览百科内容
4. ✅ **显示角色图标**：展示从百科同步的角色图标
5. ✅ **优化角色类型显示**：镇民/外来者/爪牙/恶魔带颜色标签

---

## 🎯 功能对比

### 之前（旧版）
- ❌ 用户需要手动复制百科链接导入
- ❌ 每个用户都要重复导入相同内容
- ❌ 数据不统一，可能有差异
- ❌ 导入过程复杂，用户体验差

### 现在（新版）
- ✅ 管理员统一同步，用户直接查看
- ✅ 数据统一，内容一致
- ✅ 无需登录，开箱即用
- ✅ 显示角色图标和类型
- ✅ 界面简洁，操作流畅

---

## 📋 页面结构

### wiki.vue（百科首页）

```
┌─────────────────────────────────┐
│ 血染百科                         │
│ Blood on the Clocktower...      │
├─────────────────────────────────┤
│ [78]  [12]  [90]                │
│ 角色  剧本  总词条              │
├─────────────────────────────────┤
│ 🔍 搜索角色、规则、术语...      │
├─────────────────────────────────┤
│ [角色大全] [游戏规则] [术语]    │
├─────────────────────────────────┤
│ [全部] [镇民] [外来者] ...      │
├─────────────────────────────────┤
│ ┌───────────────────────────┐  │
│ │ [图标] 图书管理员   [镇民]│ ›│
│ └───────────────────────────┘  │
│ ┌───────────────────────────┐  │
│ │ [图标] 哲学家       [镇民]│ ›│
│ └───────────────────────────┘  │
└─────────────────────────────────┘
```

### detail.vue（角色详情）

```
┌─────────────────────────────────┐
│ [图标] 图书管理员               │
│        [镇民]                   │
│ 来源：钟楼百科                  │
├─────────────────────────────────┤
│ 📖 背景故事                     │
│ "毫无疑问，这位女士..."         │
├─────────────────────────────────┤
│ 🎯 角色能力                     │
│ 在你的首个夜晚...               │
├─────────────────────────────────┤
│ 📝 角色简介 ▼                   │
│ • 图书管理员会得知...           │
├─────────────────────────────────┤
│ ℹ️ 角色信息                     │
│ 英文名    Librarian             │
│ 角色类型  镇民                  │
│ 所属剧本  暗流涌动              │
│ 能力类别  获取信息、进场能力    │
├─────────────────────────────────┤
│ [收藏] [分享] [原文]            │
└─────────────────────────────────┘
```

---

## 🔄 数据流程

### 管理端 → 用户端

```
管理员在后台同步角色
  ↓
存入 wiki_entries 数据库
  ↓
用户端直接查询显示
  ↓
无需登录即可查看
```

### 字段映射

**管理端同步的数据**：
```javascript
{
  _id: "xxx",
  title: "图书管理员",
  entry_type: "role",
  role_detail: {
    background_story: "...",
    ability: "...",
    character_info: {
      english_name: "Librarian",
      character_type: "镇民",
      belongs_to_scripts: ["暗流涌动"],
      ability_categories: ["获取信息", "进场能力"]
    }
  },
  media: {
    icon_url: "https://...",
    character_info: { ... }
  }
}
```

**用户端显示**：
- 标题: `title`
- 图标: `media.icon_url`
- 角色类型: `media.character_info.character_type`
- 背景故事: `role_detail.background_story`
- 角色能力: `role_detail.ability`
- 角色信息: `role_detail.character_info`

---

## 📝 主要修改

### wiki.vue
1. ✅ 删除导入功能区
2. ✅ 删除最近导入区域
3. ✅ 添加统计卡片（角色/剧本/总词条）
4. ✅ 从数据库加载角色列表
5. ✅ 显示角色图标
6. ✅ 显示角色类型标签
7. ✅ 优化搜索功能（直接查询数据库）

### detail.vue
1. ✅ 改为直接查询数据库
2. ✅ 移除导入相关功能
3. ✅ 添加浏览量统计
4. ✅ 收藏功能仅登录用户可用
5. ✅ 未登录用户可正常查看所有内容

---

## 🎨 界面优化

### 角色卡片（新设计）
```
┌─────────────────────────────────┐
│ [图标/占位] 图书管理员   [镇民] ›│
└─────────────────────────────────┘
```

**特点**：
- 左侧：角色图标（96x96rpx圆角）
- 中间：角色名称 + 类型标签
- 右侧：箭头
- 带颜色的类型徽章

### 统计卡片
```
┌──────┐ ┌──────┐ ┌──────┐
│  78  │ │  12  │ │  90  │
│ 角色 │ │ 剧本 │ │总词条│
└──────┘ └──────┘ └──────┘
```

---

## 🚀 使用流程

### 用户角度
1. **打开小程序** → 工具 → 血染百科
2. **浏览角色**：按类型筛选（镇民/外来者/爪牙/恶魔）
3. **搜索角色**：输入名称搜索
4. **查看详情**：点击角色查看完整信息
5. **收藏角色**：登录后可收藏（可选）

### 管理员角度
1. **后台添加角色**：百科同步管理 → 添加角色名称
2. **批量同步**：勾选角色 → 批量同步
3. **用户自动看到**：同步完成后，所有用户立即可见

---

## ✅ 功能清单

### wiki.vue（百科首页）
- ✅ 统计卡片（角色/剧本/总词条数量）
- ✅ 搜索功能（按标题搜索）
- ✅ 分类导航（角色/规则/术语）
- ✅ 角色类型筛选（全部/镇民/外来者/爪牙/恶魔）
- ✅ 角色列表展示（带图标和类型标签）
- ✅ 点击查看详情

### detail.vue（角色详情）
- ✅ 角色头部（图标、标题、类型）
- ✅ 背景故事
- ✅ 角色能力
- ✅ 角色简介（可折叠）
- ✅ 范例（可折叠）
- ✅ 运作方式（可折叠）
- ✅ 提示标记（可折叠）
- ✅ 规则细节（可折叠）
- ✅ 提示与技巧（可折叠）
- ✅ 伪装方法（可折叠）
- ✅ 角色信息（英文名/类型/剧本/能力类别）
- ✅ 收藏功能（登录用户）
- ✅ 分享功能
- ✅ 打开原文链接

---

## 🔐 权限说明

### 无需登录
- ✅ 浏览角色列表
- ✅ 搜索角色
- ✅ 查看角色详情
- ✅ 查看所有百科内容

### 需要登录
- 收藏角色（可选功能）

---

## 📊 数据库权限

需要确保 `wiki_entries` 表允许未登录用户读取：

```json
{
  "read": true,
  "create": "auth.uid != null",
  "update": "auth.uid != null",
  "delete": "auth.uid != null"
}
```

---

## 🎉 优势总结

### 用户体验
1. **零门槛**：无需登录即可查看
2. **零操作**：无需手动导入
3. **实时更新**：管理员同步后立即可见
4. **数据准确**：统一数据源，内容一致

### 管理效率
1. **集中管理**：管理员统一同步
2. **批量操作**：一次同步多个角色
3. **质量控制**：确保数据准确性

### 技术优势
1. **性能优化**：直接查询数据库，速度快
2. **数据一致**：单一数据源
3. **易于维护**：集中式管理

---

## 📝 测试清单

### 功能测试
- [ ] 打开血染百科页面
- [ ] 查看统计卡片数字是否正确
- [ ] 搜索角色功能
- [ ] 切换角色类型筛选
- [ ] 点击角色查看详情
- [ ] 查看角色图标是否显示
- [ ] 查看角色类型标签是否正确
- [ ] 折叠/展开各个章节
- [ ] 查看角色信息是否完整

### 权限测试
- [ ] 未登录状态能否查看列表
- [ ] 未登录状态能否查看详情
- [ ] 未登录状态能否搜索

### 数据测试
- [ ] 角色数量是否正确
- [ ] 角色信息是否完整
- [ ] 图标是否正常显示
- [ ] 背景故事是否正确

---

## 🚀 部署步骤

### 1. 确认数据库权限
在 uniCloud 控制台检查 `wiki_entries` 的Schema权限设置为：
```json
"read": true
```

### 2. 运行小程序
```bash
运行 → 运行到小程序模拟器
或
运行 → 运行到手机/预览
```

### 3. 测试功能
按照测试清单逐项验证

---

## 💡 使用说明

### 管理员
1. 在后台添加角色
2. 批量同步角色数据
3. 用户端自动显示

### 普通用户
1. 打开小程序
2. 进入"工具" → "血染百科"
3. 浏览或搜索角色
4. 点击查看详情

---

## 🎊 完成状态

- ✅ wiki.vue 已完成重构
- ✅ detail.vue 已优化
- ✅ 移除导入功能
- ✅ 改为查询数据库
- ✅ 支持未登录用户
- ✅ 显示角色图标和类型
- ✅ 所有功能正常

**用户端更新完成！可投入使用！** 🚀

