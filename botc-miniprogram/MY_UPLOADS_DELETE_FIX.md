# æˆ‘çš„ä¸Šä¼  - åˆ é™¤è®°å½•é‡æ–°å‡ºç°é—®é¢˜ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

**ç°è±¡**ï¼šåœ¨"æˆ‘çš„ä¸Šä¼ "é¡µé¢åˆ é™¤ä¸Šä¼ è®°å½•åï¼Œåˆ·æ–°é¡µé¢è¿™äº›è®°å½•åˆä¼šé‡æ–°å‡ºç°

**å½±å“**ï¼šç”¨æˆ·æ— æ³•æœ‰æ•ˆç®¡ç†è‡ªå·±çš„ä¸Šä¼ è®°å½•ï¼Œé€ æˆå›°æ‰°

---

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

ç³»ç»Ÿé‡‡ç”¨**è½¯åˆ é™¤**æœºåˆ¶ï¼Œä½†æŸ¥è¯¢é€»è¾‘å­˜åœ¨æ¼æ´ï¼š

1. **åˆ é™¤æ“ä½œ**ï¼ˆ`script-delete` äº‘å‡½æ•°ï¼‰ï¼š
   - æ­£ç¡®æ‰§è¡Œäº†è½¯åˆ é™¤
   - è®¾ç½® `deleted_at` å­—æ®µä¸ºå½“å‰æ—¶é—´
   - è®¾ç½® `status` å­—æ®µä¸º `-1`ï¼ˆå·²åˆ é™¤çŠ¶æ€ï¼‰
   
2. **æŸ¥è¯¢æ“ä½œ**ï¼ˆ`script-my-uploads` äº‘å‡½æ•°ï¼‰ï¼š
   - âŒ **åªè¿‡æ»¤äº† `creator_id`**
   - âŒ **æ²¡æœ‰è¿‡æ»¤ `deleted_at` å­—æ®µ**
   - âŒ å¯¼è‡´å·²åˆ é™¤çš„è®°å½•ä»è¢«æŸ¥è¯¢å‡ºæ¥

### ä»£ç å¯¹æ¯”

**ä¿®å¤å‰**ï¼ˆæœ‰é—®é¢˜çš„ä»£ç ï¼‰ï¼š
```javascript
// script-my-uploads/index.js
const countRes = await scriptsCollection
  .where({
    creator_id: userId  // åªè¿‡æ»¤ä¸Šä¼ è€…
  })
  .count()

const listRes = await scriptsCollection
  .where({
    creator_id: userId  // åªè¿‡æ»¤ä¸Šä¼ è€…ï¼Œæœªæ’é™¤å·²åˆ é™¤çš„
  })
  .orderBy('created_at', 'desc')
  .get()
```

**ä¿®å¤å**ï¼ˆæ­£ç¡®çš„ä»£ç ï¼‰ï¼š
```javascript
// script-my-uploads/index.js
const $ = db.command

const whereCondition = {
  creator_id: userId,
  deleted_at: $.or($.eq(null), $.not($.exists(true)))  // æ’é™¤å·²åˆ é™¤çš„
}

const countRes = await scriptsCollection
  .where(whereCondition)
  .count()

const listRes = await scriptsCollection
  .where(whereCondition)
  .orderBy('created_at', 'desc')
  .get()
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®æ”¹æŸ¥è¯¢äº‘å‡½æ•°

**æ–‡ä»¶**ï¼š`uniCloud-aliyun/cloudfunctions/script-my-uploads/index.js`

**ä¿®æ”¹å†…å®¹**ï¼š
- å¼•å…¥æ•°æ®åº“å‘½ä»¤å·¥å…· `db.command`
- æ·»åŠ  `deleted_at` è¿‡æ»¤æ¡ä»¶
- åªæŸ¥è¯¢ `deleted_at` ä¸º `null` æˆ–ä¸å­˜åœ¨çš„è®°å½•

**æ ¸å¿ƒæ”¹åŠ¨**ï¼š
```javascript
const whereCondition = {
  creator_id: userId,
  deleted_at: $.or($.eq(null), $.not($.exists(true)))  // æ–°å¢ï¼šæ’é™¤å·²åˆ é™¤
}
```

### 2. æŸ¥è¯¢æ¡ä»¶è¯´æ˜

ä½¿ç”¨ `$.or($.eq(null), $.not($.exists(true)))` æ¥åŒ¹é…ï¼š
- `deleted_at` å­—æ®µå€¼ä¸º `null` çš„è®°å½•
- `deleted_at` å­—æ®µä¸å­˜åœ¨çš„è®°å½•ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰

è¿™æ ·å¯ä»¥æœ‰æ•ˆè¿‡æ»¤æ‰è½¯åˆ é™¤çš„è®°å½•ï¼ˆ`deleted_at` æœ‰å€¼çš„è®°å½•ï¼‰ã€‚

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. é‡æ–°éƒ¨ç½²äº‘å‡½æ•°

åœ¨ HBuilderX ä¸­ï¼š

```
1. å³é”® uniCloud-aliyun/cloudfunctions/script-my-uploads
2. é€‰æ‹©"ä¸Šä¼ å¹¶è¿è¡Œ"æˆ–"ä¸Šä¼ éƒ¨ç½²"
3. ç­‰å¾…éƒ¨ç½²å®Œæˆ
```

### 2. éªŒè¯ä¿®å¤

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æ‰“å¼€å°ç¨‹åºï¼Œè¿›å…¥"æˆ‘çš„ä¸Šä¼ "é¡µé¢
2. åˆ é™¤æŸä¸ªä¸Šä¼ è®°å½•
3. ä¸‹æ‹‰åˆ·æ–°é¡µé¢
4. âœ… ç¡®è®¤å·²åˆ é™¤çš„è®°å½•ä¸å†å‡ºç°
5. å®Œå…¨é€€å‡ºå°ç¨‹åºé‡æ–°è¿›å…¥
6. âœ… å†æ¬¡ç¡®è®¤å·²åˆ é™¤çš„è®°å½•ä»ç„¶ä¸æ˜¾ç¤º

---

## ğŸ“Š å®Œæ•´çš„è½¯åˆ é™¤æœºåˆ¶

### åˆ é™¤æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»åˆ é™¤
    â†“
å‰ç«¯è°ƒç”¨ script-delete äº‘å‡½æ•°
    â†“
äº‘å‡½æ•°éªŒè¯æƒé™
    â†“
æ‰§è¡Œè½¯åˆ é™¤ï¼š
  - deleted_at = Date.now()
  - status = -1
    â†“
è¿”å›æˆåŠŸ
    â†“
å‰ç«¯ä»åˆ—è¡¨ç§»é™¤è¯¥è®°å½•
```

### æŸ¥è¯¢æµç¨‹ï¼ˆä¿®å¤åï¼‰

```
ç”¨æˆ·æ‰“å¼€"æˆ‘çš„ä¸Šä¼ "
    â†“
å‰ç«¯è°ƒç”¨ script-my-uploads äº‘å‡½æ•°
    â†“
äº‘å‡½æ•°æŸ¥è¯¢æ•°æ®åº“ï¼š
  - WHERE creator_id = å½“å‰ç”¨æˆ·
  - AND deleted_at IS NULL  â† æ–°å¢è¿‡æ»¤
    â†“
è¿”å›æœ‰æ•ˆè®°å½•
    â†“
å‰ç«¯æ˜¾ç¤ºåˆ—è¡¨
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆä½¿ç”¨è½¯åˆ é™¤ï¼Ÿ

âœ… **ä¼˜ç‚¹**ï¼š
- æ•°æ®å¯æ¢å¤ï¼ˆå¦‚éœ€è¦ï¼‰
- ä¿ç•™åˆ é™¤å†å²
- é¿å…å…³è”æ•°æ®é—®é¢˜
- ç¬¦åˆæ•°æ®ç®¡ç†è§„èŒƒ

âŒ **éœ€è¦æ³¨æ„**ï¼š
- æ‰€æœ‰æŸ¥è¯¢éƒ½å¿…é¡»è¿‡æ»¤ `deleted_at`
- éœ€è¦å®šæœŸæ¸…ç†æ—§çš„å·²åˆ é™¤æ•°æ®
- ç»Ÿè®¡æ•°æ®è¦æ’é™¤å·²åˆ é™¤è®°å½•

### uniCloud æ•°æ®åº“å‘½ä»¤

```javascript
const $ = db.command

// å¸¸ç”¨è¿‡æ»¤å‘½ä»¤
$.eq(value)           // ç­‰äº
$.neq(value)          // ä¸ç­‰äº
$.gt(value)           // å¤§äº
$.lt(value)           // å°äº
$.exists(true)        // å­—æ®µå­˜åœ¨
$.exists(false)       // å­—æ®µä¸å­˜åœ¨
$.or([condition1, condition2])  // æˆ–æ¡ä»¶
$.and([condition1, condition2]) // ä¸æ¡ä»¶
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šæ­£å¸¸åˆ é™¤
```
1. æœ‰3ä¸ªä¸Šä¼ è®°å½•
2. åˆ é™¤ç¬¬2ä¸ª
3. åˆ·æ–°é¡µé¢
4. âœ… åªæ˜¾ç¤ºç¬¬1å’Œç¬¬3ä¸ª
```

### åœºæ™¯ 2ï¼šå¤šæ¬¡åˆ é™¤
```
1. åˆ é™¤è®°å½•A
2. åˆ é™¤è®°å½•B
3. åˆ·æ–°é¡µé¢
4. âœ… Aå’ŒBéƒ½ä¸æ˜¾ç¤º
```

### åœºæ™¯ 3ï¼šç­›é€‰çŠ¶æ€
```
1. åˆ é™¤ä¸€ä¸ª"å¾…å®¡æ ¸"çš„è®°å½•
2. åˆ‡æ¢åˆ°"å¾…å®¡æ ¸"ç­›é€‰
3. âœ… å·²åˆ é™¤çš„ä¸æ˜¾ç¤º
4. åˆ‡æ¢åˆ°"å…¨éƒ¨"
5. âœ… å·²åˆ é™¤çš„ä»ä¸æ˜¾ç¤º
```

### åœºæ™¯ 4ï¼šé€€å‡ºé‡è¿›
```
1. åˆ é™¤è®°å½•
2. å®Œå…¨é€€å‡ºå°ç¨‹åº
3. é‡æ–°è¿›å…¥"æˆ‘çš„ä¸Šä¼ "
4. âœ… å·²åˆ é™¤çš„è®°å½•ä¸æ˜¾ç¤º
```

---

## ğŸ“ ç›¸å…³æ–‡ä»¶æ¸…å•

### å·²ä¿®æ”¹çš„æ–‡ä»¶
- âœ… `uniCloud-aliyun/cloudfunctions/script-my-uploads/index.js`

### æœªä¿®æ”¹çš„æ–‡ä»¶ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
- `pages/user/my-uploads/my-uploads.vue` - å‰ç«¯é¡µé¢
- `uniCloud-aliyun/cloudfunctions/script-delete/index.js` - åˆ é™¤äº‘å‡½æ•°

---

## ğŸ’¡ é¢å¤–ä¼˜åŒ–å»ºè®®

### 1. ç»Ÿä¸€æŸ¥è¯¢æ¥å£

å¯ä»¥åœ¨äº‘å‡½æ•°ä¸­æ·»åŠ ä¸€ä¸ªé€šç”¨çš„æŸ¥è¯¢æ¡ä»¶æ„å»ºå‡½æ•°ï¼š

```javascript
// è·å–æœ‰æ•ˆè®°å½•çš„æŸ¥è¯¢æ¡ä»¶
function getValidRecordsCondition(userId) {
  const $ = db.command
  return {
    creator_id: userId,
    deleted_at: $.or($.eq(null), $.not($.exists(true))),
    status: $.neq(-1)  // é¢å¤–ä¿é™©ï¼šæ’é™¤ status = -1 çš„
  }
}
```

### 2. æ·»åŠ ç´¢å¼•

åœ¨æ•°æ®åº“ä¸­ä¸º `deleted_at` å­—æ®µæ·»åŠ ç´¢å¼•ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½ï¼š

```javascript
// åœ¨ uniCloud æ§åˆ¶å°çš„æ•°æ®åº“ç®¡ç†ä¸­åˆ›å»ºç´¢å¼•
{
  "creator_id": 1,
  "deleted_at": 1,
  "created_at": -1
}
```

### 3. å®šæœŸæ¸…ç†

å¯ä»¥åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œæ¸…ç†è¶…è¿‡30å¤©çš„å·²åˆ é™¤è®°å½•ï¼š

```javascript
// æ–°å»ºäº‘å‡½æ•°ï¼šcleanup-deleted-scripts
const db = uniCloud.database()
const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000

await db.collection('botc-scripts')
  .where({
    status: -1,
    deleted_at: db.command.lt(thirtyDaysAgo)
  })
  .remove()  // çœŸæ­£åˆ é™¤
```

---

## âœ… ä¿®å¤æ€»ç»“

### é—®é¢˜
- åˆ é™¤è®°å½•ååˆ·æ–°åˆå‡ºç°

### åŸå› 
- æŸ¥è¯¢æ—¶æœªè¿‡æ»¤å·²åˆ é™¤çš„è®°å½•

### è§£å†³
- åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­æ·»åŠ  `deleted_at` è¿‡æ»¤

### å½±å“
- âœ… åˆ é™¤åç«‹å³ç”Ÿæ•ˆ
- âœ… åˆ·æ–°ä¸å†é‡ç°
- âœ… é‡å¯åº”ç”¨ä¹Ÿæœ‰æ•ˆ
- âœ… ä¸å½±å“å…¶ä»–åŠŸèƒ½

---

**ä¿®å¤æ—¥æœŸ**ï¼š2025å¹´10æœˆ16æ—¥  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å®Œæˆ  
**éœ€è¦éƒ¨ç½²**ï¼šæ˜¯ï¼ˆéœ€è¦é‡æ–°ä¸Šä¼  script-my-uploads äº‘å‡½æ•°ï¼‰



