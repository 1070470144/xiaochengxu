# 报名记录功能说明

## 功能概述

"报名记录"功能用于展示用户作为参与者报名的所有拼车活动，与"我的拼车"（用户作为发起者创建的拼车）相区分。

## 📊 功能对比

| 功能 | 我的拼车 | 报名记录 |
|-----|---------|---------|
| **用户角色** | 发起者 | 参与者 |
| **操作权限** | 管理拼车、审核报名、修改、取消 | 查看状态、取消报名、联系发起者 |
| **显示内容** | 自己创建的拼车活动 | 自己报名参加的拼车活动 |
| **主要用途** | 管理我发起的拼车 | 查看我报名的拼车 |

## 🎯 核心功能

### 1. 查看报名列表
- ✅ 显示所有报名的拼车活动
- ✅ 显示报名状态（待审核/已通过/已拒绝）
- ✅ 显示拼车详细信息（标题、时间、地点、人数）
- ✅ 显示发起者信息
- ✅ 显示报名时间

### 2. 取消报名
- ✅ 待审核状态可以取消
- ✅ 已通过状态可以取消（会减少拼车人数）
- ✅ 已拒绝状态不可操作

### 3. 联系发起者
- ✅ 已通过的报名可以联系发起者
- ✅ 直接跳转到私聊页面

### 4. 查看详情
- ✅ 点击卡片跳转到拼车详情页

## 📁 文件清单

### 新增文件

#### 1. 云函数
- ✅ `uniCloud-aliyun/cloudfunctions/carpool-applied-list/index.js`
  - 功能：查询用户报名的拼车列表
  - 支持分页加载
  - 自动关联拼车信息和发起者信息

- ✅ `uniCloud-aliyun/cloudfunctions/carpool-cancel-apply/index.js`
  - 功能：取消拼车报名
  - 验证用户权限
  - 自动更新拼车人数

#### 2. 前端页面
- ✅ `pages/user/applied-carpool/applied-carpool.vue`
  - 报名记录列表页面
  - 支持下拉刷新
  - 支持加载更多
  - 支持取消报名
  - 支持联系发起者

### 修改文件
- ✅ `pages.json` - 注册新页面
- ✅ `pages/user/profile/profile.vue` - 更新跳转方法

## 🎨 UI 设计

### 空状态
```
┌────────────────────────────┐
│        📋                  │
│    暂无报名记录             │
│  快去参加拼车活动吧~        │
│   [ 去拼车 ]               │
└────────────────────────────┘
```

### 报名卡片
```
┌────────────────────────────┐
│  [待审核]  ← 状态标签       │
│                            │
│  【剧本名称】               │
│  📅 2024-01-15 19:00       │
│  📍 血染钟楼店铺            │
│  👥 3/7人                   │
│                            │
│  ┌─────────────────────┐  │
│  │ 头像  发起者         │  │
│  │       用户昵称       │  │
│  └─────────────────────┘  │
│                            │
│  报名时间：2024-01-10 10:00│
│                            │
│  [ 取消报名 ] [ 联系发起者 ]│
└────────────────────────────┘
```

## 🔄 状态说明

### 报名状态

| 状态码 | 状态名称 | 颜色 | 可操作 |
|-------|---------|------|--------|
| 1 | 待审核 | 橙色 | 取消报名 |
| 2 | 已通过 | 绿色 | 取消报名、联系发起者 |
| 3 | 已拒绝 | 红色 | 无操作 |

### 状态流转

```
报名 → 待审核(1)
       ↓
   [发起者审核]
       ↓
    ┌──┴──┐
    ↓     ↓
已通过(2) 已拒绝(3)
    ↓
[可取消/联系]
```

## 🔧 使用方法

### 访问入口

**我的 → 拼车服务 → 报名记录**

### 操作流程

#### 1. 查看报名记录
1. 进入"我的"页面
2. 点击"拼车服务"下的"报名记录"
3. 查看所有报名的拼车活动

#### 2. 取消报名
1. 找到要取消的报名记录
2. 点击"取消报名"按钮
3. 确认取消
4. 系统自动更新拼车人数

#### 3. 联系发起者
1. 找到已通过的报名记录
2. 点击"联系发起者"按钮
3. 跳转到私聊页面

#### 4. 查看拼车详情
1. 点击报名卡片
2. 跳转到拼车详情页
3. 查看完整信息

## 📊 数据结构

### 报名申请表（botc-carpool-applications）

```javascript
{
  _id: 'application_id',
  carpool_id: 'carpool_room_id',  // 拼车房间ID
  user_id: 'user_id',              // 报名用户ID
  status: 1,                       // 1-待审核 2-已通过 3-已拒绝
  created_at: timestamp,           // 报名时间
  updated_at: timestamp            // 更新时间
}
```

### 云函数返回数据结构

```javascript
{
  code: 0,
  message: 'success',
  data: {
    list: [
      {
        application_id: 'xxx',      // 申请ID
        carpool_id: 'xxx',          // 拼车ID
        status: 2,                  // 状态
        created_at: timestamp,      // 报名时间
        carpool: {                  // 拼车信息
          title: '剧本名称',
          game_time: timestamp,
          location: '地点',
          current_count: 3,
          max_count: 7,
          status: 1
        },
        host: {                     // 发起者信息
          nickname: '昵称',
          avatar: 'url'
        }
      }
    ],
    total: 10                       // 总数
  }
}
```

## 🔒 权限控制

### 查询权限
- ✅ 只能查看自己的报名记录
- ✅ 云函数自动验证 token
- ✅ 根据 user_id 过滤数据

### 操作权限
- ✅ 只能取消自己的报名
- ✅ 云函数验证申请归属
- ✅ 拒绝非本人操作

## 🚀 部署步骤

### 1. 上传云函数

在 HBuilderX 中：
1. 右键 `carpool-applied-list` 云函数
2. 选择"上传部署"
3. 右键 `carpool-cancel-apply` 云函数
4. 选择"上传部署"

### 2. 运行项目

```bash
# 在 HBuilderX 中
运行 → 运行到浏览器
或
运行 → 运行到小程序模拟器
```

### 3. 测试功能

1. 登录账号
2. 进入"拼车"页面，报名一些拼车
3. 进入"我的" → "拼车服务" → "报名记录"
4. 查看报名列表
5. 测试取消报名
6. 测试联系发起者

## ⚠️ 注意事项

### 数据一致性
- 取消已通过的报名会自动减少拼车的 `current_count`
- 删除申请记录会同步更新拼车人数

### 状态判断
- 已拒绝的申请无法取消（已经失效）
- 待审核和已通过的申请可以取消

### 联系功能
- 仅已通过的报名显示"联系发起者"按钮
- 点击会跳转到私聊页面

## 🎯 后续优化建议

### 功能扩展
1. ✨ 添加报名原因字段
2. ✨ 支持报名备注编辑
3. ✨ 添加报名提醒通知
4. ✨ 支持批量取消报名

### 用户体验
1. ✨ 添加骨架屏加载动画
2. ✨ 支持筛选（按状态、时间）
3. ✨ 支持搜索拼车标题
4. ✨ 添加下拉刷新动画

### 数据统计
1. ✨ 统计报名成功率
2. ✨ 统计常去的店铺
3. ✨ 统计活跃时段

## 📸 效果预览

### 报名列表
```
┌──────────────────────────────┐
│ 📋 报名记录                   │
├──────────────────────────────┤
│  [已通过]                     │
│  暗流涌动                     │
│  📅 2024-01-15 19:00         │
│  📍 血染钟楼旗舰店           │
│  👥 5/7人                     │
│  ┌────────────────────┐      │
│  │ 👤  张三             │      │
│  └────────────────────┘      │
│  报名时间：2024-01-10 10:00  │
│  [ 取消报名 ] [ 联系发起者 ]  │
├──────────────────────────────┤
│  [待审核]                     │
│  进击的剧本                   │
│  📅 2024-01-16 20:00         │
│  📍 XXX店铺                   │
│  👥 3/6人                     │
│  ┌────────────────────┐      │
│  │ 👤  李四             │      │
│  └────────────────────┘      │
│  报名时间：2024-01-11 15:30  │
│  [ 取消报名 ]                 │
└──────────────────────────────┘
```

---

## 🎉 功能完成

"报名记录"功能已完全实现，用户现在可以：
- ✅ 查看所有报名的拼车活动
- ✅ 查看报名状态和详细信息
- ✅ 取消不需要的报名
- ✅ 联系拼车发起者
- ✅ 查看拼车详情

功能完善，体验流畅！🚀

