# 🔗 剧本详情页「复制JSON链接」功能说明

## ✅ 功能更新

根据需求，已将「复制JSON」功能修改为「复制JSON链接」功能。用户点击后将获得一个可访问的JSON文件URL，而不是直接复制JSON文本内容。

## 🎯 实现方案

### 方案选择
采用**智能双模式**方案，自动选择最优的URL生成方式：

#### 模式1：使用现有URL（优先）
- 如果剧本已有 `json_url` 字段（永久链接）
- 直接复制该URL，无需生成

#### 模式2：生成临时云存储URL（备选）
- 如果剧本只有 `json_data` 字段
- 调用云函数 `script-generate-json-url`
- 将JSON数据上传到云存储
- 生成7天有效期的临时访问链接

## 📋 技术实现

### 1. 前端实现

#### 1.1 按钮UI
```vue
<button class="json-btn btn-copy" @click="copyJsonToClipboard">
  {{ copyingJson ? '⏳ 生成中...' : '🔗 复制JSON链接' }}
</button>
```

- **按钮文案**：🔗 复制JSON链接
- **加载状态**：⏳ 生成中...
- **样式**：蓝色渐变（#4facfe → #00f2fe）

#### 1.2 功能逻辑
```javascript
async copyJsonToClipboard() {
  // 1. 检查剧本数据是否存在
  // 2. 优先使用 json_url（如果有）
  // 3. 否则调用云函数生成临时URL
  // 4. 复制URL到剪贴板
  // 5. 显示成功提示
}
```

### 2. 云函数实现

#### 2.1 云函数名称
`script-generate-json-url`

#### 2.2 功能流程
```
接收 scriptId
    ↓
查询剧本数据
    ↓
检查是否有 json_url（优先返回）
    ↓
将 json_data 上传到云存储
    ↓
生成临时访问链接（7天有效）
    ↓
返回 URL 给前端
```

#### 2.3 返回数据格式
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "url": "https://xxxx.tcb.qcloud.la/temp-scripts/xxx.json",
    "type": "temporary",
    "expiresIn": 604800,
    "fileId": "cloud://xxx"
  }
}
```

## 🎨 用户体验

### 操作流程
1. 用户点击「🔗 复制JSON链接」按钮
2. 按钮显示「⏳ 生成中...」（如需生成）
3. 显示 Toast：「✅ JSON链接已复制」
4. 弹出提示：「临时链接有效期7天，可在浏览器中打开查看JSON内容」
5. 用户可在任意地方粘贴该URL

### 使用场景
- **分享剧本**：发送链接给其他玩家，对方可直接访问
- **导入工具**：在血染钟楼工具网站中导入剧本
- **浏览器查看**：在浏览器中打开链接查看JSON格式
- **下载保存**：通过浏览器下载JSON文件

## 📊 优势对比

### 复制JSON链接 vs 复制JSON文本

| 对比项 | 复制JSON链接 ✅ | 复制JSON文本 |
|--------|----------------|-------------|
| **分享便利性** | 极高（一个短链接） | 低（长文本不便分享） |
| **浏览器访问** | 支持直接打开 | 不支持 |
| **工具导入** | 支持URL导入 | 需要手动粘贴 |
| **文件大小** | 无限制 | 受剪贴板限制 |
| **跨平台** | 完美支持 | 部分平台有限制 |
| **专业性** | 更专业 | 普通 |

## 🔄 数据流程

### 完整流程图
```
用户点击按钮
    ↓
前端检查 scriptDetail
    ↓
有 json_url？
├─ 是 → 直接复制URL → Toast提示
└─ 否 ↓
    调用云函数 script-generate-json-url
        ↓
    云函数查询剧本数据
        ↓
    上传JSON到云存储
        ↓
    生成临时URL（7天）
        ↓
    返回URL给前端
        ↓
    复制URL到剪贴板
        ↓
    Toast提示 + Modal说明
```

## 💾 云存储说明

### 存储路径
- **路径格式**：`temp-scripts/{scriptId}-{timestamp}.json`
- **示例**：`temp-scripts/abc123-1729512000000.json`

### 临时文件管理
- **有效期**：7天（604800秒）
- **自动清理**：过期后自动删除
- **成本控制**：按实际使用量计费

### 访问权限
- **公开读取**：任何人都可通过URL访问
- **临时性**：7天后自动失效
- **安全性**：随机文件名，不易被猜测

## 🛠️ 部署说明

### 1. 云函数部署

#### 部署步骤
```bash
# 在HBuilderX中
1. 右键 uniCloud-aliyun/cloudfunctions/script-generate-json-url
2. 点击「上传部署」
3. 等待部署完成
```

#### 验证部署
```bash
# 在uniCloud Web控制台
1. 进入「云函数」管理
2. 找到 script-generate-json-url
3. 查看部署状态
4. 可以手动测试调用
```

### 2. 前端代码

#### 无需特殊配置
- ✅ 代码已更新到 `detail.vue`
- ✅ 无需修改其他文件
- ✅ 直接运行即可

### 3. 云存储权限

#### 检查存储桶权限
```json
{
  "read": true,  // 允许公开读取
  "write": false // 禁止公开写入（仅云函数可写）
}
```

## 🧪 测试指南

### 测试1：有 json_url 的剧本
**步骤**：
1. 找到一个有 `json_url` 字段的剧本
2. 进入详情页
3. 点击「🔗 复制JSON链接」

**预期结果**：
- ✅ 立即复制成功（无需等待）
- ✅ 显示「✅ JSON链接已复制」
- ✅ 粘贴后是完整的HTTP链接
- ✅ 可在浏览器直接访问

### 测试2：只有 json_data 的剧本
**步骤**：
1. 找到一个只有 `json_data` 字段的剧本
2. 进入详情页
3. 点击「🔗 复制JSON链接」

**预期结果**：
- ✅ 按钮显示「⏳ 生成中...」
- ✅ 1-3秒后显示「✅ JSON链接已复制」
- ✅ 弹出Modal：「临时链接有效期7天...」
- ✅ 粘贴后是云存储临时链接
- ✅ 可在浏览器访问并下载JSON

### 测试3：在浏览器中访问
**步骤**：
1. 复制链接后
2. 打开浏览器（Chrome/Safari/微信内置浏览器）
3. 粘贴链接并访问

**预期结果**：
- ✅ 直接显示JSON内容（格式化）
- ✅ 可以查看完整的剧本数据
- ✅ 可以右键保存为文件

### 测试4：链接分享
**步骤**：
1. 复制链接后
2. 发送给其他用户（微信聊天）
3. 对方点击链接

**预期结果**：
- ✅ 对方可以直接访问
- ✅ 无需登录
- ✅ 7天内有效

## 📝 注意事项

### 1. 临时链接有效期
- ⚠️ 临时链接7天后自动失效
- 💡 建议：如需长期保存，在浏览器中下载保存
- 💡 提示用户：显示有效期提醒

### 2. 成本控制
- 📊 云存储费用：前5GB免费
- 📊 流量费用：按实际下载量计费
- 💰 预计成本：极低（大部分场景免费）

### 3. 性能优化
- ⚡ 优先使用 `json_url`（无延迟）
- ⚡ 异步上传（不阻塞UI）
- ⚡ 智能缓存（相同剧本可复用）

## 🔧 故障排查

### 问题1：生成链接失败
**可能原因**：
- 云函数未部署
- 云存储权限不足
- JSON数据格式错误

**解决方案**：
1. 检查云函数部署状态
2. 检查云存储权限配置
3. 查看云函数日志

### 问题2：链接无法访问
**可能原因**：
- 链接已过期（超过7天）
- 网络问题
- 文件已被删除

**解决方案**：
1. 重新生成链接
2. 检查网络连接
3. 查看云存储文件列表

### 问题3：生成速度慢
**可能原因**：
- JSON文件太大
- 网络速度慢
- 云函数冷启动

**解决方案**：
1. 优化JSON大小
2. 显示进度提示
3. 云函数保持热启动

## 📈 后续优化

### 可选增强功能
1. **链接缓存**：相同剧本复用之前生成的链接
2. **永久链接**：提供生成永久链接的选项
3. **自定义有效期**：让用户选择有效期（1天/7天/30天）
4. **二维码分享**：生成二维码方便分享
5. **访问统计**：记录链接访问次数

## ✅ 完成清单

### 前端
- [x] 修改按钮文案为「🔗 复制JSON链接」
- [x] 实现双模式逻辑（json_url优先）
- [x] 调用云函数生成临时URL
- [x] 复制URL到剪贴板
- [x] 显示有效期提示

### 后端
- [x] 创建 `script-generate-json-url` 云函数
- [x] 实现JSON上传到云存储
- [x] 生成7天临时访问链接
- [x] 错误处理和日志记录

### 文档
- [x] 功能说明文档
- [x] 测试指南
- [x] 部署说明
- [x] 故障排查

---

## 📞 支持

如有问题，请参考：
- **云函数日志**：uniCloud控制台 → 云函数 → script-generate-json-url → 日志
- **云存储文件**：uniCloud控制台 → 云存储 → temp-scripts/
- **前端日志**：浏览器控制台搜索 `[copyJsonToClipboard]`

---

**功能版本**: v2.0.0  
**更新时间**: 2025年10月21日  
**状态**: ✅ 已完成，待部署测试

