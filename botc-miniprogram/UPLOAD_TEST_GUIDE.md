# 剧本上传功能测试指南

## 🚀 快速测试步骤

### 准备工作

1. **准备测试JSON文件**
   - 创建一个 `test-script.json` 文件
   - 复制下方的测试JSON内容
   - 保存文件

2. **发送到手机**
   - 发送到微信"文件传输助手"
   - 或通过QQ等方式发送到手机

### 测试步骤

#### 步骤1: 进入上传页面
```
1. 打开小程序
2. 切换到"工具"Tab
3. 点击"📄 剧本上传"
```

#### 步骤2: 选择文件
```
1. 点击"点击选择JSON文件"区域
2. 从聊天记录或文件管理器选择test-script.json
3. 等待自动读取和验证
```

**预期结果**:
- ✅ 显示文件名：test-script.json
- ✅ 显示文件大小：XX KB
- ✅ 状态显示：✓ 格式正确
- ✅ 自动显示"解析结果"区块

#### 步骤3: 查看解析结果
```
解析结果应显示：
- 剧本名称：测试剧本
- 作者：测试作者
- 角色总数：5个
- 玩家数量：4人左右
- 角色统计：👥镇民2 🏃外来者1 🗡️爪牙1 😈恶魔1
```

#### 步骤4: 测试优先级（场景A：留空）
```
1. 不输入标题和作者（留空）
2. 点击"提交并生成预览图"
3. 等待上传成功
```

**预期结果**:
```
上传成功提示：
最终使用：
标题：测试剧本      ← 来自JSON
作者：测试作者      ← 来自JSON
```

#### 步骤5: 测试优先级（场景B：自定义）
```
1. 再次选择同一文件
2. 输入标题：暗流涌动（中文版）
3. 输入作者：血染工作室
4. 点击提交
```

**预期结果**:
```
上传成功提示：
最终使用：
标题：暗流涌动（中文版）  ← 用户输入优先
作者：血染工作室          ← 用户输入优先
```

#### 步骤6: 查看上传结果
```
1. 上传成功后自动跳转到"我的上传"
2. 查看刚上传的剧本
3. 点击查看预览图
```

**预期结果**:
- ✅ 显示在"待审核"状态
- ✅ 显示SVG预览图
- ✅ 标题和作者正确

---

## 📄 测试JSON文件

### test-script.json（基础版）
```json
[
  {
    "id": "_meta",
    "name": "测试剧本",
    "author": "测试作者"
  },
  {
    "id": "washerwoman",
    "name": "洗衣妇",
    "team": "townsfolk",
    "ability": "开局得知某位玩家的角色",
    "firstNight": 15
  },
  {
    "id": "librarian",
    "name": "图书管理员",
    "team": "townsfolk",
    "ability": "开局得知外来者的数量"
  },
  {
    "id": "drunk",
    "name": "酒鬼",
    "team": "outsider",
    "ability": "不知道自己的真实角色"
  },
  {
    "id": "poisoner",
    "name": "投毒者",
    "team": "minion",
    "ability": "每夜选择一人，其能力失效",
    "otherNight": 8
  },
  {
    "id": "imp",
    "name": "小恶魔",
    "team": "demon",
    "ability": "每夜选择一名玩家杀死",
    "otherNight": 21
  }
]
```

### darkflow.json（对象格式）
```json
{
  "name": "暗流涌动",
  "author": "血染工作室",
  "description": "一个充满谎言和背叛的剧本",
  "players": {
    "min": 7,
    "max": 15
  },
  "characters": [
    {
      "id": "washerwoman",
      "name": "洗衣妇",
      "team": "townsfolk",
      "ability": "开局得知某位玩家的角色"
    },
    {
      "id": "imp",
      "name": "小恶魔",
      "team": "demon",
      "ability": "每夜选择一名玩家杀死"
    }
  ]
}
```

---

## ✅ 测试检查清单

### 文件选择功能
- [ ] 点击选择区域响应
- [ ] 可以选择JSON文件
- [ ] 文件名显示正确
- [ ] 文件大小显示正确
- [ ] 点击✕可以移除文件
- [ ] 移除后状态重置

### JSON解析功能
- [ ] 格式错误时显示"✗ 格式错误"
- [ ] 格式正确时显示"✓ 格式正确"
- [ ] 自动解析剧本名称
- [ ] 自动解析作者
- [ ] 自动统计角色数量
- [ ] 自动计算玩家数量
- [ ] 角色分类统计正确

### 优先级功能
- [ ] 留空时使用JSON值
- [ ] 输入时使用用户值
- [ ] 部分输入时混合使用
- [ ] 提交成功提示显示最终值

### 预览图功能
- [ ] 解析成功后显示预览区域
- [ ] 提交后云函数生成预览图
- [ ] 预览图URL正确返回
- [ ] 在"我的上传"中显示

### 集成测试
- [ ] 完整上传流程流畅
- [ ] 上传成功后跳转正确
- [ ] 在"我的上传"中可见
- [ ] 预览图正常显示
- [ ] 数据保存正确

---

## 🐛 常见问题

### Q1: 选择文件时报错
**A**: 
- 检查是否在微信小程序中运行
- 尝试使用备选粘贴方案
- 检查文件是否为.json格式

### Q2: 读取文件失败
**A**: 
- 检查文件编码是否为UTF-8
- 检查文件大小是否过大
- 尝试重新选择文件

### Q3: JSON解析失败
**A**: 
- 点击"查看内容"检查JSON
- 使用在线JSON验证工具验证
- 检查是否有多余的逗号或括号

### Q4: 预览图未生成
**A**: 
- 检查云函数是否部署成功
- 查看云函数日志
- 检查JSON中角色数据是否完整

### Q5: 优先级不生效
**A**: 
- 确认输入框有内容（不是空格）
- 检查控制台日志
- 查看云函数接收的参数

---

## 📊 性能指标

### 预期性能
- 文件选择：< 1秒
- 文件读取：< 2秒
- JSON解析：< 0.5秒
- 上传提交：< 3秒
- 预览图生成：< 5秒

### 文件大小限制
- 推荐：< 1MB
- 最大：10MB
- 超大文件可能需要更长时间

---

## 🎯 下一步

### 测试通过后
1. ✅ 在真实环境测试
2. ✅ 上传真实剧本
3. ✅ 验证预览图质量
4. ✅ 收集用户反馈

### 后续优化
1. 📝 支持拖拽上传（H5端）
2. 🎨 优化预览图样式
3. 📊 添加上传进度条
4. 💾 支持草稿保存

---

**创建日期**: 2025年10月15日  
**测试版本**: v2.0.0  
**状态**: ✅ 待测试

