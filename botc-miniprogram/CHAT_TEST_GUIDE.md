# 💬 Chat 云对象测试指南

## 📍 访问测试页面

### 方式 1: 直接访问
```
http://localhost:5173/#/pages/test/script-test
```

### 方式 2: 从快捷入口访问
打开 `botc-miniprogram/测试页面快捷入口.html`

---

## 🎯 测试页面说明

测试页面包含 3 个页签：
- 🎬 **Script** - 剧本云对象测试
- 🚗 **Carpool** - 拼车云对象测试  
- 💬 **Chat** - 聊天云对象测试（新增）

点击 **💬 Chat** 页签进入 Chat 云对象测试区。

---

## ✅ 测试前准备

### 1. 上传 Chat 云对象

在 HBuilderX 中：
```
右键 uniCloud-aliyun/cloudfunctions/chat → 上传云函数
```

等待上传完成，看到控制台输出 "上传成功"。

### 2. 确保已登录

- 页面顶部显示 **"✅ 已登录"** 状态
- 如果未登录，请先使用登录功能登录

### 3. 准备测试数据

需要准备：
- 至少 2 个测试账号（用于互相发消息）
- 记录用户 ID（可以在个人资料页或数据库中查看）

---

## 🧪 测试步骤

### 1️⃣ 发送消息 (sendMessage)

**测试目标：** 发送一条私聊消息

**步骤：**
1. 输入 **接收者用户ID**（另一个测试账号的ID）
2. 输入 **消息内容**（例如："你好，在吗？"）
3. 消息类型默认为 1（文本）
4. 点击 **"发送消息"** 按钮

**预期结果：**
- ✅ 显示 "消息发送成功！"
- ✅ 返回数据包含：
  - `message_id` - 消息ID
  - `conversation_id` - 会话ID
  - `created_at` - 发送时间
- ✅ 输入框自动清空，恢复默认值

**测试场景：**
- ✅ 正常发送文本消息
- ❌ 不输入接收者ID → 提示 "请填写完整信息"
- ❌ 不输入消息内容 → 提示 "请填写完整信息"
- ❌ 发给自己 → 提示 "不能给自己发消息"
- ❌ 消息超过1000字 → 提示 "消息内容不能超过1000字"

---

### 2️⃣ 获取会话列表 (getConversations)

**测试目标：** 查看当前用户的所有会话

**步骤：**
1. 设置 **页码**（默认 1）
2. 设置 **每页数量**（默认 20）
3. 点击 **"获取会话列表"** 按钮

**预期结果：**
- ✅ 显示 "获取成功！共 X 个会话，总计 Y 个"
- ✅ 返回数据包含：
  - `list` - 会话列表数组
    - `conversation_id` - 会话ID
    - `other_user` - 对方用户信息（ID、昵称、头像）
    - `last_message` - 最后一条消息
    - `last_message_time` - 最后消息时间
    - `unread_count` - 未读数量
  - `total` - 总数
  - `hasNext` - 是否有下一页

**测试场景：**
- ✅ 查看第1页
- ✅ 查看第2页（如果有）
- ✅ 修改每页数量
- ✅ 空列表情况

---

### 3️⃣ 获取聊天消息 (getMessages)

**测试目标：** 获取与指定用户的聊天记录

**步骤：**
1. 输入 **对方用户ID**
2. 设置 **页码**（默认 1）
3. 设置 **每页数量**（默认 50）
4. 点击 **"获取聊天消息"** 按钮

**预期结果：**
- ✅ 显示 "获取成功！共 X 条消息，总计 Y 条"
- ✅ 返回数据包含：
  - `list` - 消息列表数组（按时间倒序）
    - `message_id` - 消息ID
    - `sender_id` - 发送者ID
    - `receiver_id` - 接收者ID
    - `content` - 消息内容
    - `message_type` - 消息类型
    - `is_read` - 是否已读
    - `created_at` - 发送时间
    - `is_mine` - 是否是我发送的
  - `conversation_id` - 会话ID
  - `total` - 总消息数
  - `hasNext` - 是否有下一页

**测试场景：**
- ✅ 获取最新消息（第1页）
- ✅ 获取历史消息（第2页及以后）
- ✅ 查看 `is_mine` 标记是否正确
- ❌ 不输入用户ID → 提示 "请输入用户ID"

---

### 4️⃣ 标记已读 (markRead)

**测试目标：** 将收到的消息标记为已读

**步骤：**
1. 输入 **对方用户ID**（必填）
2. 输入 **会话ID**（可选，系统会自动查找）
3. 点击 **"标记已读"** 按钮

**预期结果：**
- ✅ 显示 "标记成功！共标记 X 条消息"
- ✅ 返回数据包含：
  - `conversation_id` - 会话ID
  - `marked_count` - 标记的消息数量

**后续验证：**
- ✅ 再次获取会话列表，该会话的 `unread_count` 应该为 0
- ✅ 再次获取聊天消息，消息的 `is_read` 应该为 `true`

**测试场景：**
- ✅ 只输入用户ID（自动查找会话）
- ✅ 输入用户ID和会话ID
- ❌ 两者都不输入 → 提示 "请输入用户ID或会话ID"
- ✅ 重复标记（应该标记0条）

---

### 5️⃣ 删除会话 (deleteConversation)

**测试目标：** 删除一个会话（软删除）

**步骤：**
1. 输入 **会话ID**（从会话列表或发送消息返回的ID）
2. 点击 **"删除会话"** 按钮

**预期结果：**
- ✅ 显示 "会话删除成功！"
- ✅ 输入框自动清空
- ✅ 返回数据包含：
  - `conversation_id` - 被删除的会话ID

**后续验证：**
- ✅ 再次获取会话列表，该会话应该消失
- ✅ 对方用户的会话列表不受影响（软删除）
- ✅ 消息记录仍然保留

**测试场景：**
- ✅ 删除一个会话
- ❌ 不输入会话ID → 提示 "请输入会话ID"
- ❌ 输入不存在的会话ID → 提示 "会话不存在"
- ❌ 删除别人的会话 → 提示 "无权删除此会话"

---

### 6️⃣ 获取未读总数 (getUnreadCount)

**测试目标：** 获取所有会话的未读消息总数

**步骤：**
1. 直接点击 **"获取未读总数"** 按钮（无需输入参数）

**预期结果：**
- ✅ 显示 "未读消息总数: X 条"
- ✅ 返回数据包含：
  - `total_unread` - 未读总数

**使用场景：**
- 用于显示 tabBar 的未读角标
- 用于首页显示未读提示

**测试场景：**
- ✅ 无未读消息时，显示 0
- ✅ 有未读消息时，显示正确数量
- ✅ 标记已读后，数量减少

---

## 🎯 完整测试流程

### 推荐测试顺序：

1. **准备两个测试账号**
   - 账号 A（发送方）
   - 账号 B（接收方）

2. **使用账号 A：**
   ```
   ① 发送消息给账号 B
   ② 获取会话列表（应该看到与 B 的会话）
   ③ 获取与 B 的聊天消息
   ④ 获取未读总数
   ```

3. **切换到账号 B：**
   ```
   ① 获取会话列表（应该看到与 A 的会话，有未读数）
   ② 获取未读总数（应该 > 0）
   ③ 获取与 A 的聊天消息
   ④ 标记已读
   ⑤ 再次获取未读总数（应该变为 0）
   ```

4. **回到账号 A：**
   ```
   ① 获取会话列表
   ② 删除与 B 的会话
   ③ 再次获取会话列表（会话应该消失）
   ```

5. **切换到账号 B：**
   ```
   ① 获取会话列表（会话仍然存在）
   ② 发送新消息给 A
   ```

6. **回到账号 A：**
   ```
   ① 获取会话列表（会话重新出现）
   ```

---

## 📊 测试检查清单

### 功能测试
- [ ] ✅ 发送文本消息
- [ ] ✅ 获取会话列表
- [ ] ✅ 获取聊天消息
- [ ] ✅ 标记消息已读
- [ ] ✅ 删除会话
- [ ] ✅ 获取未读总数

### 边界测试
- [ ] ❌ 不输入必填参数
- [ ] ❌ 输入不存在的用户ID
- [ ] ❌ 输入不存在的会话ID
- [ ] ❌ 给自己发消息
- [ ] ❌ 消息内容超长
- [ ] ✅ 空会话列表
- [ ] ✅ 空消息列表
- [ ] ✅ 未读数为0

### 权限测试
- [ ] ❌ 未登录发送消息
- [ ] ❌ 删除别人的会话

### 数据一致性
- [ ] ✅ 发送消息后，会话列表更新
- [ ] ✅ 标记已读后，未读数清零
- [ ] ✅ 删除会话后，列表中移除
- [ ] ✅ 软删除不影响对方

---

## 🐛 常见问题

### 问题 1: 无法连接云对象

**错误信息：**
```
[chat]: 无法连接uniCloud
```

**解决方案：**
1. 确认已上传 chat 云对象
2. 检查 uniCloud 控制台是否有 chat 云对象
3. 重新上传云对象
4. 刷新页面

---

### 问题 2: 未登录错误

**错误信息：**
```
未登录或token无效
```

**解决方案：**
- 页面顶部确认登录状态
- 如果未登录，请先登录
- 如果已登录，尝试重新登录

---

### 问题 3: 找不到会话

**错误信息：**
```
会话不存在
```

**解决方案：**
- 确认会话ID正确
- 先发送一条消息创建会话
- 从会话列表中获取正确的会话ID

---

### 问题 4: 无法给某人发消息

**可能原因：**
- 用户ID输入错误
- 对方用户不存在
- 尝试给自己发消息

**解决方案：**
- 检查用户ID拼写
- 在数据库中确认用户存在
- 使用不同的用户ID

---

## 📝 测试记录模板

```
测试日期：____年____月____日
测试人员：__________
测试环境：开发/测试/生产

| 测试项 | 测试结果 | 备注 |
|--------|---------|------|
| 发送消息 | ✅/❌ |  |
| 获取会话列表 | ✅/❌ |  |
| 获取聊天消息 | ✅/❌ |  |
| 标记已读 | ✅/❌ |  |
| 删除会话 | ✅/❌ |  |
| 获取未读总数 | ✅/❌ |  |

问题和建议：
1. 
2. 
3. 
```

---

## 🎉 测试完成

当所有测试项都通过后：

✅ Chat 云对象测试完成！

下一步可以：
1. 开始前端页面适配
2. 删除旧的 Chat 云函数
3. 继续开发下一个模块

---

_创建时间：2025-11-04_  
_测试页面：http://localhost:5173/#/pages/test/script-test_  
_相关文档：CHAT_CLOUD_OBJECT_COMPLETE.md_

