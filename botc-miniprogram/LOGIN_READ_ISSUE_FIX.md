# ç™»å½•åæ— æ³•è¯»å–å‰§æœ¬æ•°æ® - ä¿®å¤æŒ‡å—

## ğŸ› é—®é¢˜ç°è±¡

```
æœªç™»å½•çŠ¶æ€ï¼šâœ… å¯ä»¥çœ‹åˆ°å‰§æœ¬
ç™»å½•åï¼šâŒ çœ‹ä¸åˆ°å‰§æœ¬
```

## ğŸ¯ é—®é¢˜åŸå› 

å¯èƒ½çš„åŸå› ï¼š
1. æ•°æ®åº“ Schema æƒé™é…ç½®æœªç”Ÿæ•ˆ
2. ç™»å½•åè§¦å‘äº†é¢å¤–çš„æƒé™éªŒè¯
3. uni-id é…ç½®é—®é¢˜

---

## âœ… è§£å†³æ–¹æ¡ˆï¼ˆ3ç§ï¼‰

### **æ–¹æ¡ˆ1ï¼šåœ¨äº‘ç«¯æ‰‹åŠ¨è®¾ç½®æƒé™ï¼ˆæ¨èï¼‰** â­

```
1. ç™»å½• uniCloud Web æ§åˆ¶å°
   https://unicloud.dcloud.net.cn/

2. é€‰æ‹©æœåŠ¡ç©ºé—´ï¼šmp-1e0f6630-18c8-400c-99ff-761aea3a4e83

3. ç‚¹å‡»ï¼šäº‘æ•°æ®åº“ â†’ æ•°æ®è¡¨ â†’ botc-scripts

4. ç‚¹å‡»ï¼šè¡¨ç»“æ„ æˆ– Schema æ ‡ç­¾

5. æ‰¾åˆ° permission éƒ¨åˆ†ï¼Œç¡®è®¤é…ç½®ï¼š
   {
     "permission": {
       "read": true,           // âœ… æ‰€æœ‰äººéƒ½å¯ä»¥è¯»
       "create": "auth.uid != null",
       "update": "auth.uid == doc.creator_id",
       "delete": "auth.uid == doc.creator_id"
     }
   }

6. å¦‚æœä¸æ˜¯ trueï¼Œæ”¹ä¸º true

7. ç‚¹å‡»"ä¿å­˜"

8. åˆ·æ–°å°ç¨‹åºæµ‹è¯•
```

---

### **æ–¹æ¡ˆ2ï¼šé‡æ–°ä¸Šä¼ Schemaå¹¶é‡å¯**

```
1. åœ¨ HBuilderX ä¸­æ‰¾åˆ°ï¼š
   botc-miniprogram/uniCloud-aliyun/database/botc-scripts.schema.json

2. å³é”®ç‚¹å‡»

3. é€‰æ‹©ï¼š"ä¸Šä¼ Schemaæ‰©å±•Jsçš„é…ç½®"

4. ç­‰å¾…"ä¸Šä¼ æˆåŠŸ"

5. å®Œå…¨å…³é—­ HBuilderX

6. é‡æ–°æ‰“å¼€ HBuilderX

7. é‡æ–°è¿è¡Œ botc-miniprogram é¡¹ç›®

8. ç™»å½•æµ‹è¯•
```

---

### **æ–¹æ¡ˆ3ï¼šä½¿ç”¨ JQL æŸ¥è¯¢ç»•è¿‡æƒé™æ£€æŸ¥**

ä¿®æ”¹å°ç¨‹åºç«¯çš„æŸ¥è¯¢æ–¹å¼ï¼š

```javascript
// åŸæ¥çš„æ–¹å¼ï¼ˆå¯èƒ½å—æƒé™é™åˆ¶ï¼‰
const res = await db.collection('botc-scripts')
  .where({ status: 1 })
  .get()

// æ”¹ä¸º JQL æŸ¥è¯¢ï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
const res = await uniCloud.callFunction({
  name: 'script-list',
  data: {
    status: 1,
    pageSize: 10,
    pageNum: 1
  }
})
```

---

## ğŸ” è¯Šæ–­æ­¥éª¤

### **æ­¥éª¤1ï¼šæ£€æŸ¥å®é™…æƒé™**

åœ¨å°ç¨‹åºç«¯æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// æµ‹è¯•æœªç™»å½•è¯»å–
db.collection('botc-scripts').where({ status: 1 }).limit(1).get()
  .then(res => console.log('æœªç™»å½•è¯»å–ï¼š', res))
  .catch(err => console.error('æœªç™»å½•è¯»å–å¤±è´¥ï¼š', err))

// æµ‹è¯•ç™»å½•åè¯»å–
// ï¼ˆå…ˆç™»å½•ï¼‰
db.collection('botc-scripts').where({ status: 1 }).limit(1).get()
  .then(res => console.log('ç™»å½•åè¯»å–ï¼š', res))
  .catch(err => console.error('ç™»å½•åè¯»å–å¤±è´¥ï¼š', err))
```

### **æ­¥éª¤2ï¼šæŸ¥çœ‹é”™è¯¯ä¿¡æ¯**

```
1. æŒ‰ F12 æ‰“å¼€æ§åˆ¶å°

2. ç™»å½•

3. å°è¯•æŸ¥çœ‹å‰§æœ¬åˆ—è¡¨

4. æŸ¥çœ‹æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯

5. å¤åˆ¶é”™è¯¯ä¿¡æ¯
```

å¸¸è§é”™è¯¯ï¼š
- `permission denied` - æƒé™è¢«æ‹’ç»
- `Invalid uni-id config` - uni-id é…ç½®é”™è¯¯
- `auth.uid is undefined` - ç”¨æˆ·IDè·å–å¤±è´¥

---

## ğŸ¯ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

### **ç¦ç”¨ uni-id çš„æƒé™æ£€æŸ¥ï¼ˆä»…æµ‹è¯•ç”¨ï¼‰**

åœ¨æŸ¥è¯¢æ—¶æ·»åŠ  `skipPermission`ï¼š

```javascript
const res = await db.collection('botc-scripts')
  .where({ status: 1 })
  .get({
    getOne: false,
    getCount: false,
    skipPermission: true  // âš ï¸ è·³è¿‡æƒé™æ£€æŸ¥ï¼ˆä»…æµ‹è¯•ç”¨ï¼‰
  })
```

---

## ğŸ“Š æƒé™é…ç½®è¯´æ˜

### **å½“å‰é…ç½®ï¼š**

```json
{
  "permission": {
    "read": true,  // âœ… ä»»ä½•äººéƒ½å¯ä»¥è¯»å–
    "create": "auth.uid != null",  // ç™»å½•ç”¨æˆ·å¯ä»¥åˆ›å»º
    "update": "auth.uid == doc.creator_id",  // åªæœ‰åˆ›å»ºè€…å¯ä»¥æ›´æ–°
    "delete": "auth.uid == doc.creator_id"   // åªæœ‰åˆ›å»ºè€…å¯ä»¥åˆ é™¤
  }
}
```

### **read: true çš„å«ä¹‰ï¼š**

```
æœªç™»å½•ç”¨æˆ·ï¼šâœ… å¯ä»¥è¯»å–
ç™»å½•ç”¨æˆ·ï¼šâœ… å¯ä»¥è¯»å–
ä»»ä½•äººï¼šâœ… éƒ½å¯ä»¥è¯»å–
```

å¦‚æœè®¾ç½®ä¸º `"read": "auth.uid != null"`ï¼Œåˆ™ï¼š
```
æœªç™»å½•ç”¨æˆ·ï¼šâŒ ä¸èƒ½è¯»å–
ç™»å½•ç”¨æˆ·ï¼šâœ… å¯ä»¥è¯»å–
```

---

## âš¡ å¿«é€Ÿæµ‹è¯•

### **æµ‹è¯•1ï¼šæ£€æŸ¥ Schema æ˜¯å¦ç”Ÿæ•ˆ**

åœ¨ uniCloud Web æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// ç›´æ¥åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢
db.collection('botc-scripts')
  .where({ status: 1 })
  .limit(1)
  .get()
```

å¦‚æœèƒ½æŸ¥è¯¢åˆ°æ•°æ®ï¼Œè¯´æ˜æ•°æ®æœ¬èº«æ²¡é—®é¢˜ã€‚

### **æµ‹è¯•2ï¼šæ£€æŸ¥ç™»å½•çŠ¶æ€**

åœ¨å°ç¨‹åºæ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// æŸ¥çœ‹å½“å‰ç™»å½•çŠ¶æ€
console.log('Token:', uni.getStorageSync('uni_id_token'))
console.log('User Info:', uni.getStorageSync('uni-id-pages-userInfo'))
```

---

## ğŸ†˜ å¦‚æœéƒ½ä¸è¡Œ

æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **æ§åˆ¶å°å®Œæ•´é”™è¯¯ä¿¡æ¯**
2. **æ•°æ®åº“ä¸­å‰§æœ¬çš„å®é™…æ•°æ®**ï¼ˆæˆªå›¾ï¼‰
3. **uniCloud Web æ§åˆ¶å°çš„ Schema é…ç½®**ï¼ˆæˆªå›¾ï¼‰
4. **ç™»å½•ç”¨æˆ·çš„ token ä¿¡æ¯**

---

## âœ… æœ€å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ

**ç›´æ¥åœ¨ uniCloud Web æ§åˆ¶å°ä¿®æ”¹ botc-scripts è¡¨çš„æƒé™ï¼š**

```
1. ç™»å½• uniCloud Web æ§åˆ¶å°
2. äº‘æ•°æ®åº“ â†’ botc-scripts â†’ è¡¨ç»“æ„
3. æ‰¾åˆ° permission.read
4. æ”¹ä¸º true
5. ä¿å­˜
6. åˆ·æ–°å°ç¨‹åºæµ‹è¯•
```

**è¿™æ˜¯æœ€ç›´æ¥ã€æœ€æœ‰æ•ˆçš„æ–¹å¼ï¼** ğŸš€

