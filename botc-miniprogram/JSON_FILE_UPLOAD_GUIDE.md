# JSON文件上传功能使用指南

## ✅ 实现方案

**上传方式**: 选择JSON文件上传  
**API**: `uni.chooseMessageFile`  
**适用**: 微信小程序  

---

## 📋 完整功能

### 1. 文件选择
- ✅ 点击按钮选择JSON文件
- ✅ 从聊天记录选择
- ✅ 从文件管理器选择
- ✅ 显示文件名和大小

### 2. 自动处理
- ✅ 读取文件内容
- ✅ 验证JSON格式
- ✅ 解析剧本信息
- ✅ 统计角色数据

### 3. 智能优先级
- ✅ 用户可输入自定义标题
- ✅ 用户可输入自定义作者
- ✅ 留空则使用JSON中的值
- ✅ 输入则使用用户输入的值

### 4. 自动生成预览图
- ✅ 云函数生成SVG预览图
- ✅ 包含角色分类
- ✅ 包含夜晚行动顺序
- ✅ 专业视觉设计

---

## 🎯 使用流程

### 准备JSON文件
```
方式1：从聊天记录
1. 有人发给你一个.json文件
2. 保存在聊天记录中
3. 在小程序中选择该文件

方式2：从文件管理器
1. 手机中有.json文件
2. 通过文件管理器访问
3. 在小程序中选择

方式3：创建文件
1. 在电脑上创建test.json
2. 复制测试JSON内容
3. 发送到手机（微信文件传输助手）
4. 在小程序中选择
```

### 上传步骤
```
步骤1: 选择文件
┌────────────────────┐
│       📁           │
│   选择JSON文件      │
│ 点击从聊天记录或文件中选择 │
└────────────────────┘
        ↓ 点击

步骤2: 文件已选择
┌────────────────────┐
│ ✅ test.json  15KB │
│ [查看内容][重新选择] │
└────────────────────┘
        ↓ 自动读取和解析

步骤3: 查看解析结果
┌────────────────────┐
│ ✓ 解析成功         │
│ 剧本名称：测试剧本  │
│ 作者：测试作者      │
│ 角色：5个          │
│ 👥镇民2 😈恶魔1    │
└────────────────────┘
        ↓

步骤4: 可选修改
┌────────────────────┐
│ 剧本名称（可选）    │
│ [______________]   │
│ 留空使用：测试剧本  │
└────────────────────┘
        ↓

步骤5: 提交
[提交并生成预览图]
        ↓
上传成功 → 跳转到"我的上传"
```

---

## 💡 优先级说明

### 标题和作者的优先级
```
最终值 = 用户输入 || JSON中的值
```

### 使用示例

**场景1: 完全使用JSON的值**
```
JSON文件内容:
{
  "name": "暗流涌动",
  "author": "血染工作室"
}

用户操作:
- 标题输入框：留空
- 作者输入框：留空

最终结果:
- 标题：暗流涌动（来自JSON）
- 作者：血染工作室（来自JSON）
```

**场景2: 完全自定义**
```
JSON文件内容:
{
  "name": "darkflow",
  "author": "BOTC Workshop"
}

用户操作:
- 标题输入框：输入"暗流涌动"
- 作者输入框：输入"血染工作室"

最终结果:
- 标题：暗流涌动（来自用户输入）
- 作者：血染工作室（来自用户输入）
```

**场景3: 部分自定义**
```
JSON文件内容:
{
  "name": "darkflow",
  "author": "BOTC Workshop"
}

用户操作:
- 标题输入框：输入"暗流涌动"
- 作者输入框：留空

最终结果:
- 标题：暗流涌动（来自用户输入）
- 作者：BOTC Workshop（来自JSON）
```

---

## 🧪 测试准备

### 创建测试JSON文件

**文件名**: `test-script.json`

**内容**:
```json
[
  {
    "id": "_meta",
    "name": "测试剧本",
    "author": "测试作者"
  },
  {
    "id": "washerwoman",
    "name": "洗衣妇",
    "team": "townsfolk",
    "ability": "开局得知某位玩家的角色",
    "firstNight": 15
  },
  {
    "id": "librarian",
    "name": "图书管理员",
    "team": "townsfolk",
    "ability": "开局得知外来者的数量"
  },
  {
    "id": "drunk",
    "name": "酒鬼",
    "team": "outsider",
    "ability": "不知道自己的真实角色"
  },
  {
    "id": "poisoner",
    "name": "投毒者",
    "team": "minion",
    "ability": "每夜选择一人，其能力失效",
    "otherNight": 8
  },
  {
    "id": "imp",
    "name": "小恶魔",
    "team": "demon",
    "ability": "每夜选择一名玩家杀死",
    "otherNight": 21
  }
]
```

### 发送到手机
```
1. 在电脑上创建test-script.json
2. 粘贴上方JSON内容
3. 保存文件
4. 通过微信发送到"文件传输助手"
5. 在手机微信中可以看到该文件
```

---

## 🚀 在HBuilderX中测试

### 1. 编译运行
```
HBuilderX:
1. 点击工具栏"运行"
2. 选择"运行到小程序模拟器"
3. 或选择"运行到微信开发者工具"
```

### 2. 进入上传页面
```
小程序:
1. 切换到"工具"Tab（底部第三个）
2. 点击"📄 剧本上传"
```

### 3. 选择文件
```
1. 点击"选择JSON文件"按钮
2. 从聊天记录中选择test-script.json
3. 等待文件读取
```

### 4. 查看解析
```
应该自动显示：
✓ 解析成功

剧本名称：测试剧本
作者：测试作者
角色总数：5个
玩家数量：4人左右
👥镇民2 🏃外来者1 🗡️爪牙1 😈恶魔1
```

### 5. 测试优先级
```
测试A：不输入任何值，直接提交
→ 使用"测试剧本"和"测试作者"

测试B：只输入标题"我的剧本"
→ 使用"我的剧本"和"测试作者"

测试C：都输入自定义值
→ 使用用户输入的值
```

### 6. 提交测试
```
1. 先部署云函数（见下方）
2. 点击"提交并生成预览图"
3. 等待上传成功
4. 自动跳转到"我的上传"
5. 查看预览图
```

---

## ☁️ 云函数部署

### 必须部署的云函数

**1. script-upload**
```
功能：接收JSON，生成预览图，保存数据库

部署：
右键 uniCloud-aliyun/cloudfunctions/script-upload
→ 上传并运行
```

**2. script-my-uploads**
```
功能：查询用户上传的剧本列表

部署：
右键 uniCloud-aliyun/cloudfunctions/script-my-uploads
→ 上传并运行
```

**3. script-delete**
```
功能：删除剧本

部署：
右键 uniCloud-aliyun/cloudfunctions/script-delete
→ 上传并运行
```

### 验证部署
```
1. 打开uniCloud Web控制台
2. 进入"云函数"管理
3. 查看三个函数是否都在列表中
4. 状态应为"正常"
```

---

## 📱 界面预览

### 未选择文件
```
┌─────────────────────────────┐
│ 选择JSON文件   [等待选择]    │
├─────────────────────────────┤
│                              │
│          📁                  │
│      选择JSON文件             │
│  点击从聊天记录或文件中选择    │
│                              │
└─────────────────────────────┘
```

### 已选择文件
```
┌─────────────────────────────┐
│ 选择JSON文件   [✓ 格式正确]  │
├─────────────────────────────┤
│ ✅  test-script.json         │
│     15.2KB                   │
├─────────────────────────────┤
│  [查看内容]  [重新选择]       │
└─────────────────────────────┘
```

### 解析成功后
```
┌─────────────────────────────┐
│ 解析结果      [✓ 解析成功]   │
├─────────────────────────────┤
│ 剧本名称：测试剧本            │
│ 作者：测试作者                │
│ 角色总数：5个                 │
│ 玩家数量：4人左右             │
│ 👥镇民2 🏃外来者1 🗡️爪牙1 😈恶魔1 │
└─────────────────────────────┘

┌─────────────────────────────┐
│ 自定义信息  [可选，留空则使用JSON中的值] │
├─────────────────────────────┤
│ 剧本名称（可选）              │
│ [_________________________] │
│ 留空使用：测试剧本            │
│ 如需修改，请在此输入新名称     │
└─────────────────────────────┘
```

---

## ✅ 功能验证清单

### 文件选择
- [ ] 点击按钮弹出文件选择器
- [ ] 可以选择JSON文件
- [ ] 显示文件名和大小
- [ ] 可以重新选择

### 文件读取
- [ ] 自动读取文件内容
- [ ] 自动验证JSON格式
- [ ] 格式错误时提示
- [ ] 格式正确时解析

### 信息解析
- [ ] 提取剧本名称
- [ ] 提取作者
- [ ] 统计角色数量
- [ ] 分类角色阵营
- [ ] 估算玩家数量

### 优先级逻辑
- [ ] 留空使用JSON值
- [ ] 输入使用用户值
- [ ] 提交时正确合并

### 上传功能
- [ ] 提交到云函数
- [ ] 生成预览图
- [ ] 保存到数据库
- [ ] 跳转到"我的上传"

---

## 📚 完整功能列表

| 功能 | 状态 | 说明 |
|-----|------|------|
| 选择JSON文件 | ✅ | uni.chooseMessageFile |
| 读取文件内容 | ✅ | uni.getFileSystemManager |
| 验证JSON格式 | ✅ | JSON.parse |
| 解析剧本信息 | ✅ | 智能提取 |
| 自定义标题 | ✅ | 可选，留空用JSON |
| 自定义作者 | ✅ | 可选，留空用JSON |
| 生成预览图 | ✅ | 云函数SVG生成 |
| 保存数据库 | ✅ | opendb-botc-scripts |
| 我的上传 | ✅ | 查看和管理 |

---

## 🎯 使用建议

### 最佳实践
```
1. 准备好JSON文件
2. 发送到微信（文件传输助手）
3. 在小程序中选择文件
4. 查看自动解析的信息
5. 如果信息正确，直接提交（留空）
6. 如果需要修改，输入新值
7. 提交并等待成功
```

### 注意事项
```
1. 文件必须是.json格式
2. JSON内容必须符合规范
3. 文件大小建议<1MB
4. 需要先部署云函数
5. 需要登录后才能上传
```

---

## 🔧 技术实现

### 文件选择API
```javascript
uni.chooseMessageFile({
  count: 1,           // 选择1个文件
  type: 'file',       // 文件类型
  extension: ['json'] // 只允许json
})
```

### 文件读取API
```javascript
const fs = uni.getFileSystemManager()
fs.readFile({
  filePath: file.path,
  encoding: 'utf8',
  success: (res) => {
    this.jsonContent = res.data
  }
})
```

### 优先级实现
```javascript
const finalTitle = this.formData.customTitle.trim() 
  || this.parsedInfo.title

const finalAuthor = this.formData.customAuthor.trim() 
  || this.parsedInfo.author
```

---

## 🎉 完成状态

- [x] 文件选择功能
- [x] 文件读取功能
- [x] JSON解析功能
- [x] 优先级逻辑
- [x] 云函数上传
- [x] 预览图生成
- [x] 我的上传页面
- [x] 完整文档

---

**创建日期**: 2025年10月15日  
**上传方式**: JSON文件上传  
**状态**: ✅ 完成  
**版本**: v2.0.0 Final

