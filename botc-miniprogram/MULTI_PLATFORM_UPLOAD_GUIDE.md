# 剧本上传 - 多平台支持指南

## ✅ 双模式设计

为了兼容不同平台，剧本上传提供**两种上传方式**：

### 📁 文件上传模式（推荐）
- **适用**: 真实微信小程序
- **API**: `uni.chooseMessageFile`
- **优点**: 更方便，直接选择文件

### 📋 粘贴内容模式（备选）
- **适用**: HBuilderX测试环境
- **方式**: 复制粘贴JSON内容
- **优点**: 兼容性好，所有环境都支持

---

## 🎯 平台适配

### 真实小程序环境
```
✅ 使用"文件上传"模式
1. 点击"文件上传"标签
2. 点击"选择JSON文件"
3. 从聊天记录选择.json文件
4. 自动读取并解析
```

### HBuilderX测试环境
```
✅ 使用"粘贴内容"模式
1. 点击"粘贴内容"标签
2. 复制测试JSON
3. 粘贴到输入框
4. 自动验证并解析
```

### 自动切换
```
如果选择文件失败：
→ 弹出提示："当前环境不支持文件选择，建议切换到'粘贴内容'模式"
→ 点击"切换"自动切换到粘贴模式
```

---

## 📱 界面说明

### 模式切换区
```
┌────────────┬────────────┐
│ 📁 文件上传 │ 📋 粘贴内容 │
│ 小程序推荐  │ 测试环境用  │
└────────────┴────────────┘
```

### 文件上传模式
```
┌──────────────────────────┐
│ 选择JSON文件  [等待选择]  │
├──────────────────────────┤
│         📁               │
│    选择JSON文件           │
│  从聊天记录或文件中选择    │
└──────────────────────────┘

选择后：
┌──────────────────────────┐
│ 选择JSON文件  [✓ 格式正确]│
├──────────────────────────┤
│ ✅ test.json   15.2KB    │
├──────────────────────────┤
│  [查看内容]  [重新选择]   │
└──────────────────────────┘
```

### 粘贴内容模式
```
┌──────────────────────────┐
│ 粘贴JSON内容  [等待输入]  │
├──────────────────────────┤
│ ┌────────────────────┐   │
│ │ 请粘贴JSON内容...  │   │
│ │                    │   │
│ │ 支持两种格式：      │   │
│ │ 1. 数组格式        │   │
│ │ 2. 对象格式        │   │
│ └────────────────────┘   │
├──────────────────────────┤
│ [格式化] [验证] [清空]    │
└──────────────────────────┘
```

---

## 🔄 完整流程

### 在真实小程序中
```
1. 工具 → 剧本上传
2. 选择"文件上传"模式（默认）
3. 点击"选择JSON文件"
4. 从微信聊天记录选择.json文件
5. 自动读取并验证
6. 查看解析结果
7. 可选修改标题/作者
8. 提交上传
```

### 在HBuilderX测试中
```
1. 工具 → 剧本上传
2. 切换到"粘贴内容"模式
3. 复制测试JSON
4. 粘贴到输入框
5. 自动验证
6. 查看解析结果
7. 可选修改标题/作者
8. 提交上传
```

---

## 🧪 测试方法

### HBuilderX环境测试

**步骤 1**: 准备测试JSON
```json
[{"id":"_meta","name":"测试剧本","author":"测试作者"},{"id":"washerwoman","name":"洗衣妇","team":"townsfolk","ability":"开局得知某位玩家的角色"},{"id":"imp","name":"小恶魔","team":"demon","ability":"每夜选择一名玩家杀死"}]
```

**步骤 2**: 运行测试
```
1. HBuilderX → 运行 → 运行到小程序模拟器
2. 切换到"工具"Tab
3. 点击"剧本上传"
4. 点击"📋 粘贴内容"标签
5. 粘贴上方JSON
6. 查看解析结果
7. 测试提交（需先部署云函数）
```

### 真实小程序测试

**步骤 1**: 准备JSON文件
```
1. 创建 test-script.json 文件
2. 复制测试JSON内容
3. 发送到微信"文件传输助手"
```

**步骤 2**: 真机测试
```
1. 手机微信打开小程序
2. 工具 → 剧本上传
3. 使用"📁 文件上传"模式（默认）
4. 选择刚才发送的文件
5. 查看解析结果
6. 测试提交
```

---

## 💡 优先级逻辑

### 无论哪种模式，都支持优先级

**规则**: 用户输入 > JSON中的值

**示例**:
```
JSON中:
{
  "name": "darkflow",
  "author": "BOTC Workshop"
}

用户输入:
customTitle: "暗流涌动"
customAuthor: ""（留空）

最终结果:
title: "暗流涌动"     ← 用户输入
author: "BOTC Workshop" ← JSON值
```

---

## 🔧 技术实现

### 模式切换
```javascript
switchMode(mode) {
  this.uploadMode = mode
  this.reset()  // 重置所有状态
}
```

### 文件上传失败处理
```javascript
try {
  const res = await uni.chooseMessageFile({...})
} catch (error) {
  // 提示切换到粘贴模式
  uni.showModal({
    content: '当前环境不支持文件选择，建议切换到"粘贴内容"模式',
    confirmText: '切换',
    success: (res) => {
      if (res.confirm) {
        this.switchMode('paste')
      }
    }
  })
}
```

### 统一的后续处理
```javascript
// 无论哪种模式，最终都是:
// 1. 验证JSON格式
// 2. 解析剧本信息
// 3. 提交到云函数
// 4. 生成预览图
```

---

## 📊 平台兼容性

| 功能 | HBuilderX模拟器 | 真实小程序 | 说明 |
|-----|----------------|-----------|------|
| 文件上传 | ❌ 不支持 | ✅ 支持 | chooseMessageFile限制 |
| 粘贴内容 | ✅ 支持 | ✅ 支持 | 通用方式 |
| JSON解析 | ✅ 支持 | ✅ 支持 | 两种模式都支持 |
| 格式验证 | ✅ 支持 | ✅ 支持 | 实时验证 |
| 优先级逻辑 | ✅ 支持 | ✅ 支持 | 统一逻辑 |
| 云函数上传 | ✅ 支持 | ✅ 支持 | 相同代码 |
| 预览图生成 | ✅ 支持 | ✅ 支持 | 云端生成 |

---

## 🎨 用户体验

### 模式选择提示
```
📁 文件上传
小程序推荐          ← 真实小程序用这个

📋 粘贴内容
测试环境用          ← HBuilderX测试用这个
```

### 智能提示
```
选择文件失败时：
弹窗："当前环境不支持文件选择，建议切换到'粘贴内容'模式"
[取消] [切换]       ← 点击切换自动跳转
```

---

## ✅ 测试清单

### HBuilderX模拟器
- [ ] 打开上传页面
- [ ] 默认在"文件上传"模式
- [ ] 点击选择文件 → 失败提示
- [ ] 点击"切换" → 自动切换到"粘贴内容"
- [ ] 粘贴JSON → 验证成功
- [ ] 解析信息正确
- [ ] 提交成功

### 真实小程序
- [ ] 打开上传页面
- [ ] 使用"文件上传"模式
- [ ] 选择.json文件 → 成功
- [ ] 自动读取文件
- [ ] 解析信息正确
- [ ] 提交成功

### 两种模式都测试
- [ ] 优先级逻辑正确
- [ ] 留空使用JSON值
- [ ] 输入使用用户值
- [ ] 预览图正常生成
- [ ] 在"我的上传"中可见

---

## 🚀 快速使用

### HBuilderX测试
```
1. 编译运行
2. 工具 → 剧本上传
3. 点击"📋 粘贴内容"
4. 复制测试JSON: 
[{"id":"_meta","name":"测试","author":"作者"},{"id":"imp","name":"小恶魔","team":"demon"}]
5. 粘贴并提交
```

### 真实小程序
```
1. 准备test.json文件
2. 发送到微信
3. 打开小程序
4. 工具 → 剧本上传
5. 使用"📁 文件上传"
6. 选择文件并提交
```

---

## 📝 开发建议

### 开发阶段
```
使用"粘贴内容"模式：
- 更快捷
- 不需要准备文件
- 方便调试
```

### 生产环境
```
推荐"文件上传"模式：
- 用户体验更好
- 更符合使用习惯
- 支持大文件
```

---

## 🎉 完成总结

### 双模式支持
✅ 文件上传（真实小程序）
✅ 粘贴内容（测试环境）
✅ 自动提示切换
✅ 统一的后续处理

### 完整功能
✅ JSON格式验证
✅ 剧本信息解析
✅ 智能优先级逻辑
✅ 自动生成预览图
✅ 完整管理功能

### 跨平台兼容
✅ HBuilderX模拟器
✅ 微信开发者工具
✅ 真实微信小程序
✅ 其他uniapp支持的平台

---

**创建日期**: 2025年10月15日  
**版本**: v3.0.0 Multi-Platform  
**状态**: ✅ 全平台支持完成

