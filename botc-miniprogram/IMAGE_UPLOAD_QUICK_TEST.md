# 🧪 图片上传功能 - 快速测试指南

## 🚀 5分钟快速测试

### 步骤1：打开上传页面（30秒）

1. 启动小程序
2. 进入"工具" → "上传剧本"
3. 选择任意JSON文件（或粘贴内容）
4. 等待解析成功

### 步骤2：上传图片（2分钟）

1. 滚动到"剧本图片（可选）"区域
2. 点击"📸 选择图片"按钮
3. 从相册选择1-3张图片
4. 观察上传进度：
   ```
   上传图片中 1/3
   上传图片中 2/3
   上传图片中 3/3
   ```
5. 看到提示："✅ 成功上传N张图片"

### 步骤3：查看控制台（1分钟）

打开控制台，应该看到：

```
[图片上传] 开始上传第1张，路径: script-images/1737458400000-0-abc123def.jpg
[图片上传] 第1张上传成功，fileID: cloud://xxx
[图片上传] 第1张获得永久URL: https://vkceyugu.cdn.bspapp.com/xxx.jpg
[图片上传] URL格式检查 - 是否HTTPS: true  ← ✅ 关键检查
[图片上传] 所有图片上传完成
[图片上传] 永久URLs: ["https://..."]
[图片上传] URL类型检查: [
  {url: "https://...", isHTTPS: true, isCDN: true}  ← ✅ 关键验证
]
```

**✅ 关键验证点**：
- `isHTTPS: true` ← 不是 Blob URL
- `isCDN: true` ← 来自云存储CDN

### 步骤4：提交剧本（1分钟）

1. 点击"提交并生成预览图"按钮
2. 等待处理
3. 看到成功提示
4. 查看控制台：
   ```
   [剧本提交] 提交数据: {
     title: "xxx",
     user_images_count: 2,
     user_images: ["https://...", "https://..."]
   }
   ```

### 步骤5：验证数据库（30秒）

1. 打开 **uniCloud Web控制台**
2. 进入 **云数据库** → **botc-scripts**
3. 找到刚上传的剧本
4. 检查 `user_images` 字段：

**✅ 正确格式**：
```json
{
  "user_images": [
    "https://vkceyugu.cdn.bspapp.com/VKCEYUGU-xxx/script-images/xxx.jpg",
    "https://vkceyugu.cdn.bspapp.com/VKCEYUGU-xxx/script-images/xxx.jpg"
  ]
}
```

**验证要点**：
- ✅ 是数组格式
- ✅ 以 `https://` 开头
- ✅ 包含 `cdn` 或 `bspapp`
- ✅ 路径包含 `script-images/`
- ❌ 不是 `blob:` 开头

### 步骤6：查看小程序显示（30秒）

1. 进入剧本详情页
2. 找到"📷 剧本图片"卡片
3. 查看是否显示"👤 用户上传的图片"区域
4. 图片以3列网格显示
5. 点击图片可以放大查看

**✅ 验证成功标准**：
- 图片正常显示（不是空白）
- 可以点击放大
- 可以左右滑动浏览
- 长按可保存到相册

---

## 🐛 常见问题排查

### 问题1：上传按钮点击无反应

**检查**：
- 是否已经上传了3张（最多3张）
- 控制台是否有错误

**解决**：
- 删除已有图片后重试
- 检查网络连接

### 问题2：上传失败

**控制台显示**：
```
[图片上传] 第1张上传失败: [错误信息]
```

**可能原因**：
- 网络连接问题
- 云存储配置问题
- 文件格式不支持

**解决**：
- 检查网络
- 使用标准图片格式（JPG/PNG）
- 查看云存储配额

### 问题3：数据库中是Blob URL

**检查控制台**：
```
[图片上传] URL格式检查 - 是否HTTPS: false  ← ❌ 问题
```

**原因**：
- 代码未正确执行
- 云存储上传失败

**解决**：
- 重新上传图片
- 检查云函数日志

### 问题4：小程序详情页不显示

**检查**：
1. 数据库中是否有 `user_images` 字段
2. URL是否有效（在浏览器中打开测试）
3. 控制台是否有图片加载错误

**解决**：
- 验证URL在浏览器中可访问
- 检查网络权限设置

---

## ✅ 完整测试清单

### 基础功能
- [ ] 图片选择功能正常
- [ ] 上传进度显示正确
- [ ] 上传成功提示显示
- [ ] 图片以网格形式显示
- [ ] 删除按钮功能正常

### URL验证
- [ ] 控制台显示 `isHTTPS: true`
- [ ] 控制台显示 `isCDN: true`
- [ ] URL 以 `https://` 开头
- [ ] URL 包含 `script-images/`

### 数据库验证
- [ ] `user_images` 字段存在
- [ ] 是数组格式
- [ ] 包含正确数量的URL
- [ ] URL 不是 `blob:` 开头

### 前端显示
- [ ] 剧本详情页正确显示
- [ ] 图片可以点击放大
- [ ] 图片可以左右滑动
- [ ] 长按可以保存

### 边界测试
- [ ] 上传1张图片 - 正常
- [ ] 上传3张图片 - 正常
- [ ] 上传3张后不能继续 - 正常
- [ ] 删除图片后可继续上传 - 正常
- [ ] 不上传图片直接提交 - 正常

---

## 📊 测试报告模板

```markdown
## 测试结果

**测试时间**：2025-10-21  
**测试环境**：微信开发者工具 / 真机

### 上传测试

| 项目 | 预期 | 实际 | 状态 |
|------|------|------|------|
| 选择图片 | 弹出相册 | 弹出相册 | ✅ |
| 上传进度 | 显示进度 | 显示进度 | ✅ |
| 获得URL | HTTPS URL | HTTPS URL | ✅ |
| 拒绝Blob | 验证失败 | 验证失败 | ✅ |

### URL验证

| 图片 | URL格式 | isHTTPS | isCDN | 状态 |
|------|---------|---------|-------|------|
| 图1 | https://vkc... | true | true | ✅ |
| 图2 | https://vkc... | true | true | ✅ |
| 图3 | https://vkc... | true | true | ✅ |

### 数据库验证

| 字段 | 格式 | 内容 | 状态 |
|------|------|------|------|
| user_images | Array | 3个URL | ✅ |
| preview_image | String | SVG Base64 | ✅ |

### 前端显示

| 项目 | 状态 |
|------|------|
| 图片卡片显示 | ✅ |
| 网格布局正确 | ✅ |
| 点击放大功能 | ✅ |
| 左右滑动浏览 | ✅ |
| 长按保存功能 | ✅ |

### 总结

☑️ 所有功能正常，可以上线  
☐ 发现问题需要修复

**发现的问题**：
无

**建议**：
可以正式使用
```

---

**测试完成后请记录结果！**

