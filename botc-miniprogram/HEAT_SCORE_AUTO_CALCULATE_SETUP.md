# 🔥 热度自动计算 - 定时任务配置指南

## 📋 配置步骤

### 步骤1：上传热度计算云函数

1. 在 HBuilderX 中找到：
   ```
   botc-miniprogram/uniCloud-aliyun/cloudfunctions/storyteller-calculate-heat
   ```

2. 右键点击该文件夹 → **上传部署**

3. 等待上传完成，看到提示"上传成功"

---

### 步骤2：测试云函数

上传后，先测试一下是否正常工作：

1. 右键点击 `storyteller-calculate-heat` → **云端运行**

2. 在弹出的对话框中，参数留空或输入 `{}`

3. 点击"运行"

4. 查看返回结果，应该类似：
   ```json
   {
     "code": 0,
     "message": "成功计算 1 个说书人的热度",
     "data": {
       "count": 1,
       "results": [
         {
           "user_id": "xxx",
           "nickname": "冉冉",
           "heat_score": 10
         }
       ]
     }
   }
   ```

5. ✅ 如果看到成功信息，说明云函数正常工作

---

### 步骤3：配置定时触发器

#### 方法A：通过 HBuilderX 配置（推荐）

1. 在 HBuilderX 中右键点击 `storyteller-calculate-heat`

2. 选择 **管理定时触发器**

3. 点击 **新增触发器**

4. 配置参数：
   ```
   触发器名称：每日计算说书人热度
   触发周期：自定义
   Cron 表达式：0 3 * * *
   触发时区：Asia/Shanghai (中国标准时间)
   启用状态：启用
   ```

5. 点击 **确定**

#### 方法B：通过 uniCloud Web 控制台配置

1. 打开浏览器，访问 [uniCloud Web 控制台](https://unicloud.dcloud.net.cn/)

2. 选择您的服务空间（应该是 `mp-1e0f6630-18c8-400c-99ff-761aea3a4e83`）

3. 进入 **云函数** → 找到 `storyteller-calculate-heat`

4. 点击该云函数，进入详情页

5. 切换到 **定时触发** 标签

6. 点击 **新增触发器**

7. 填写配置：
   - **触发器名称**：`每日计算说书人热度`
   - **触发周期**：选择 "自定义"
   - **Cron 表达式**：`0 3 * * *`
   - **时区**：`Asia/Shanghai`
   - **是否启用**：✅ 启用

8. 点击 **确定**

---

### 步骤4：理解 Cron 表达式

```
0 3 * * *
│ │ │ │ │
│ │ │ │ └─── 星期几 (0-6，0表示周日，*表示每天)
│ │ │ └───── 月份 (1-12，*表示每月)
│ │ └─────── 日期 (1-31，*表示每日)
│ └───────── 小时 (0-23，3表示凌晨3点)
└─────────── 分钟 (0-59，0表示整点)
```

**`0 3 * * *` 的含义**：
- 每天凌晨 3:00 执行

**其他常用配置**：

| Cron 表达式 | 说明 |
|------------|------|
| `0 3 * * *` | 每天凌晨 3:00 |
| `0 */6 * * *` | 每 6 小时执行一次 |
| `0 0 * * 0` | 每周日凌晨 0:00 |
| `0 2 1 * *` | 每月1号凌晨 2:00 |

---

### 步骤5：验证定时任务

配置完成后，等待下一次触发时间。

如果不想等待，可以：

#### 方法1：修改触发时间

临时修改 Cron 表达式为当前时间后几分钟，例如：
- 当前时间：14:25
- 修改为：`30 14 * * *`（14:30执行）
- 等待5分钟后查看执行日志

#### 方法2：查看云函数日志

1. 在 uniCloud Web 控制台

2. 进入 **云函数** → `storyteller-calculate-heat`

3. 切换到 **日志** 标签

4. 等待定时任务触发后，查看执行记录

5. 应该能看到类似的日志：
   ```
   [2025-10-27 03:00:01] 开始执行
   [2025-10-27 03:00:01] === 开始计算说书人热度 ===
   [2025-10-27 03:00:01] 找到 1 个认证说书人
   [2025-10-27 03:00:02] 冉冉: 粉丝1 剧本0 下载0 评分0.0 = 热度10
   [2025-10-27 03:00:02] === 计算完成：成功 1/1 ===
   [2025-10-27 03:00:02] 执行成功
   ```

---

## 🎯 完整配置检查清单

- [ ] ✅ 上传 `storyteller-calculate-heat` 云函数
- [ ] ✅ 手动运行一次，确认功能正常
- [ ] ✅ 配置定时触发器（Cron: `0 3 * * *`）
- [ ] ✅ 验证定时任务已启用
- [ ] ✅ （可选）测试定时任务执行
- [ ] ✅ （可选）查看执行日志

---

## 📊 定时任务说明

### 执行时间

- **触发时间**：每天凌晨 3:00（北京时间）
- **执行时长**：通常 < 5秒（取决于说书人数量）

### 执行内容

1. 查询所有认证说书人
2. 逐个计算热度分数
3. 更新到数据库
4. 热度榜自动更新

### 热度计算公式

```
热度分数 = 粉丝数 × 10 + 剧本数 × 50 + 总下载量 × 1 + 总评分 × 20
```

### 影响因素

| 因素 | 权重 | 说明 |
|------|------|------|
| 粉丝数 | ×10 | 每个粉丝贡献 10 分 |
| 剧本数 | ×50 | 每个剧本贡献 50 分 |
| 下载量 | ×1 | 每次下载贡献 1 分 |
| 评分 | ×20 | 每个评分贡献 20 分 |

---

## 💡 常见问题

### Q1: 定时任务为什么没有执行？

**检查项**：
1. ✅ 确认触发器已启用
2. ✅ 确认 Cron 表达式正确
3. ✅ 确认时区设置为 `Asia/Shanghai`
4. ✅ 查看云函数日志，确认是否有报错

### Q2: 可以手动触发吗？

**可以**！两种方式：

**方式1**：HBuilderX
```
右键 storyteller-calculate-heat → 云端运行
```

**方式2**：代码调用
```javascript
uniCloud.callFunction({
  name: 'storyteller-calculate-heat'
})
```

### Q3: 定时任务会产生费用吗？

**会**，但非常少：
- 每次执行约消耗 100ms 计算时长
- 每天执行一次 = 100ms/天
- 每月约 3 秒
- 成本几乎可以忽略

### Q4: 可以改变执行频率吗？

**可以**！修改 Cron 表达式即可：

| 频率 | Cron 表达式 |
|------|------------|
| 每天1次（凌晨3点） | `0 3 * * *` |
| 每天2次（3点、15点） | `0 3,15 * * *` |
| 每6小时1次 | `0 */6 * * *` |
| 每12小时1次 | `0 0,12 * * *` |

### Q5: 如果云函数执行失败怎么办？

**自动重试**：
- uniCloud 会自动重试 3 次
- 如果都失败，会在日志中记录错误
- 不影响下次定时执行

**查看错误**：
- 进入云函数日志
- 查找错误信息
- 根据错误修复代码

---

## 🚀 立即开始

### 快速配置（3步完成）

```bash
# 步骤1：上传云函数
右键 storyteller-calculate-heat → 上传部署

# 步骤2：测试运行
右键 storyteller-calculate-heat → 云端运行

# 步骤3：配置定时器
右键 storyteller-calculate-heat → 管理定时触发器 → 新增
Cron: 0 3 * * *
时区: Asia/Shanghai
启用: ✅
```

---

## ✅ 配置完成

配置完成后：

1. ✅ 每天凌晨3点自动计算热度
2. ✅ 热度榜自动更新
3. ✅ 无需人工干预

**现在就开始配置吧！** 🎉

---

**配置时间**：约 5 分钟  
**配置难度**：⭐⭐ 简单  
**维护成本**：0（全自动）

