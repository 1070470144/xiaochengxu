# 我的上传功能完整指南

## ✅ 已完成的功能

### 1. "我的"页面增强
**文件**: `pages/user/profile/profile.vue`

**新增内容**:
- ✅ 在"📚 内容管理"区块添加"我的上传"入口
- ✅ 显示上传数量统计
- ✅ 点击跳转到上传列表页

**位置**:
```
我的页面
└── 内容管理
    ├── 📄 我的上传 (新增)
    ├── ⭐ 我的收藏
    └── 👁️ 浏览历史
```

---

### 2. 我的上传列表页面
**文件**: `pages/user/my-uploads/my-uploads.vue`

**核心功能**:
- ✅ 显示用户上传的所有剧本
- ✅ 按状态筛选（全部/待审核/已发布/已拒绝）
- ✅ 显示剧本预览图
- ✅ 显示剧本基本信息
- ✅ 支持下拉刷新
- ✅ 支持加载更多
- ✅ 编辑和删除功能

**页面结构**:
```
┌─────────────────────────────────┐
│ 全部(5) | 待审核(2) | 已发布(3) | 已拒绝(0) │ ← 状态筛选
├─────────────────────────────────┤
│   [📄 上传新剧本]                │ ← 快捷上传按钮
├─────────────────────────────────┤
│ ┌──────┐  剧本标题        [待审核]│
│ │预览图│  作者：xxx               │
│ │      │  20个角色 | 7-15人       │
│ └──────┘  2小时前   [编辑][删除] │
├─────────────────────────────────┤
│ ┌──────┐  另一个剧本      [已发布]│
│ │预览图│  作者：yyy               │
│ │      │  15个角色 | 5-7人        │
│ └──────┘  1天前     [删除]       │
└─────────────────────────────────┘
```

**状态说明**:
- 🟡 **待审核**: 刚上传，等待管理员审核
- 🟢 **已发布**: 审核通过，已在剧本库中展示
- 🔴 **已拒绝**: 审核未通过，需要修改

**操作功能**:
- **编辑**: 仅待审核的剧本可编辑（功能待完善）
- **删除**: 待审核和已拒绝的剧本可删除，已发布的需联系管理员

---

### 3. 云函数支持
**文件**: `uniCloud-aliyun/cloudfunctions/`

#### script-my-uploads 云函数
**功能**: 查询用户上传的剧本列表

**请求参数**:
```javascript
{
  page: 1,        // 页码
  pageSize: 10    // 每页数量
}
```

**返回数据**:
```javascript
{
  code: 0,
  message: 'success',
  data: {
    list: [...],    // 剧本列表
    total: 10,      // 总数
    page: 1,
    pageSize: 10,
    hasMore: false  // 是否有更多
  }
}
```

#### script-delete 云函数
**功能**: 删除剧本（软删除）

**请求参数**:
```javascript
{
  scriptId: 'xxx'  // 剧本ID
}
```

**权限验证**:
- ✅ 只能删除自己上传的剧本
- ✅ 已发布的剧本不能删除
- ✅ 待审核和已拒绝的可以删除

---

## 📁 完整文件清单

### 前端页面
```
pages/
├── user/
│   ├── profile/
│   │   └── profile.vue          # ✅ 已修改：添加"我的上传"入口
│   └── my-uploads/
│       └── my-uploads.vue        # ✅ 新建：我的上传列表页
│
└── tools/
    └── upload-json/
        └── upload-json.vue       # ✅ 已有：剧本上传页面
```

### 云函数
```
uniCloud-aliyun/cloudfunctions/
├── script-upload/               # ✅ 已有：上传并生成预览图
│   ├── index.js
│   ├── preview-generator.js
│   └── package.json
│
├── script-my-uploads/           # ✅ 新建：查询我的上传
│   ├── index.js
│   └── package.json
│
└── script-delete/               # ✅ 新建：删除剧本
    ├── index.js
    └── package.json
```

### 配置文件
```
└── pages.json                   # ✅ 已修改：注册新页面
```

---

## 🎯 完整使用流程

### 用户上传剧本
```
1. 工具 Tab → 剧本上传
2. 粘贴JSON内容
3. 查看自动解析的信息
4. 完善剧本信息
5. 提交并自动生成预览图
6. 返回"我的"页面
```

### 查看我的上传
```
1. 我的 Tab
2. 点击"📄 我的上传"
3. 查看上传的剧本列表
4. 按状态筛选
5. 点击查看详情
```

### 管理我的剧本
```
待审核状态：
- 可以编辑（待完善）
- 可以删除

已发布状态：
- 可以查看
- 不能删除（需联系管理员）

已拒绝状态：
- 可以查看拒绝原因（待完善）
- 可以删除
- 可以重新上传修改版本
```

---

## 📊 数据统计

### 在"我的"页面顶部统计区
```
┌──────┬──────┬──────┐
│ 帖子 │ 拼车 │ 收藏 │
│  5   │  3   │  12  │
└──────┴──────┴──────┘
```

建议添加"上传"统计（可选）：
```javascript
// 在 userStats 中添加
userStats: {
  postCount: 0,
  carpoolCount: 0,
  favoriteCount: 0,
  uploadCount: 0  // ← 新增
}
```

---

## 🚀 部署步骤

### 1. 部署云函数

**部署 script-my-uploads**:
```
在HBuilderX中：
1. 右键 uniCloud-aliyun/cloudfunctions/script-my-uploads
2. 选择"上传并运行"
3. 等待部署完成
```

**部署 script-delete**:
```
在HBuilderX中：
1. 右键 uniCloud-aliyun/cloudfunctions/script-delete
2. 选择"上传并运行"
3. 等待部署完成
```

### 2. 测试功能

**测试查看列表**:
```
1. 编译小程序
2. 切换到"我的"Tab
3. 点击"我的上传"
4. 查看是否正常显示列表
```

**测试上传流程**:
```
1. 先上传一个测试剧本
2. 返回"我的上传"页面
3. 刷新查看新上传的剧本
4. 检查状态是否为"待审核"
```

**测试删除功能**:
```
1. 点击待审核剧本的"删除"按钮
2. 确认删除
3. 检查是否从列表中移除
```

---

## 💡 功能亮点

### 1. 状态管理清晰
- 🟡 待审核：黄色标识
- 🟢 已发布：绿色标识
- 🔴 已拒绝：红色标识

### 2. 快捷操作
- 顶部快速上传按钮
- 一键筛选不同状态
- 直接编辑/删除

### 3. 预览图展示
- 显示自动生成的SVG预览图
- 预览图未生成时显示占位符
- 点击查看详情

### 4. 数据统计
- 各状态数量实时显示
- 点击状态快速筛选
- 一目了然

---

## 🔧 技术实现

### 前端查询
```javascript
// 调用云函数获取列表
const res = await uniCloud.callFunction({
  name: 'script-my-uploads',
  data: {
    page: this.page,
    pageSize: this.pageSize
  }
})
```

### 云函数查询
```javascript
// 查询当前用户上传的剧本
await db.collection('opendb-botc-scripts')
  .where({
    creator_id: userId
  })
  .orderBy('created_at', 'desc')
  .get()
```

### 软删除机制
```javascript
// 不是真正删除记录，而是标记
await db.collection('opendb-botc-scripts')
  .doc(scriptId)
  .update({
    deleted_at: Date.now(),
    status: -1
  })
```

---

## 📝 待完善功能

### 短期
- [ ] 编辑剧本功能
- [ ] 查看拒绝原因
- [ ] 批量删除
- [ ] 导出剧本JSON

### 中期
- [ ] 上传草稿保存
- [ ] 剧本数据统计
- [ ] 分享我的剧本
- [ ] 查看浏览/下载数据

### 长期
- [ ] 剧本版本管理
- [ ] 协作编辑功能
- [ ] 剧本模板库
- [ ] AI辅助生成

---

## 🎨 界面预览

### 我的页面
```
┌─────────────────────────────┐
│   [用户头像和信息]           │
├─────────────────────────────┤
│ 帖子(5)  拼车(3)  收藏(12)   │
├─────────────────────────────┤
│ 📚 内容管理                  │
│ ├─ 📄 我的上传      [2] ›   │ ← 新增
│ ├─ ⭐ 我的收藏     [12] ›   │
│ └─ 👁️ 浏览历史     [30] ›   │
└─────────────────────────────┘
```

### 我的上传页面
```
┌─────────────────────────────┐
│ 全部  待审核  已发布  已拒绝 │
├─────────────────────────────┤
│      [📄 上传新剧本]         │
├─────────────────────────────┤
│ [预览图] 剧本名称    [状态]  │
│         作者 | 角色 | 人数   │
│         时间         操作    │
├─────────────────────────────┤
│ [预览图] 另一个剧本  [状态]  │
│         作者 | 角色 | 人数   │
│         时间         操作    │
└─────────────────────────────┘
```

---

## 🧪 测试场景

### 场景 1: 首次上传
```
1. 用户进入"剧本上传"
2. 粘贴JSON并提交
3. 系统自动生成预览图
4. 保存到数据库（status=0待审核）
5. 在"我的上传"中可以看到
```

### 场景 2: 管理上传
```
1. 进入"我的上传"
2. 看到所有上传的剧本
3. 筛选"待审核"
4. 点击删除某个剧本
5. 确认后从列表移除
```

### 场景 3: 审核流程
```
1. 管理员在后台审核
2. 审核通过，status改为1
3. 用户在"我的上传"看到状态变为"已发布"
4. 该剧本出现在剧本库中
```

---

## 🗄️ 数据库设计

### opendb-botc-scripts 集合

**核心字段**:
```javascript
{
  _id: 'xxx',
  title: '剧本名称',
  author: '作者',
  description: '剧本简介',
  json_data: {...},              // 原始JSON数据
  preview_image: 'data:image/svg+xml;base64,...', // SVG预览图
  player_count: '7-15人',
  total_characters: 20,
  difficulty: '普通',
  script_type: '标准剧本',
  tags: [],
  creator_id: 'user_id',         // 上传者ID
  status: 0,                     // 0=待审核 1=已发布 2=已拒绝 -1=已删除
  view_count: 0,
  download_count: 0,
  favorite_count: 0,
  created_at: 1234567890,
  updated_at: 1234567890,
  deleted_at: null               // 删除时间（软删除）
}
```

**索引建议**:
```javascript
// 创建索引提高查询性能
{
  creator_id: 1,      // 按上传者查询
  status: 1,          // 按状态筛选
  created_at: -1      // 按时间排序
}
```

---

## 📋 云函数详解

### script-my-uploads（查询列表）

**功能**: 查询当前用户上传的剧本

**鉴权**: 需要登录

**查询逻辑**:
```javascript
// 1. 验证用户登录
const userInfo = await uniID.checkToken(event.uniIdToken)

// 2. 查询该用户的剧本
const res = await db.collection('opendb-botc-scripts')
  .where({
    creator_id: userId,
    deleted_at: null  // 排除已删除的
  })
  .orderBy('created_at', 'desc')
  .skip((page - 1) * pageSize)
  .limit(pageSize)
  .get()
```

### script-delete（删除剧本）

**功能**: 删除用户自己上传的剧本

**鉴权**: 需要登录 + 本人验证

**删除逻辑**:
```javascript
// 1. 验证用户登录
// 2. 查询剧本并验证权限
if (script.creator_id !== userId) {
  return { code: 403, message: '无权删除' }
}

// 3. 验证状态（已发布的不能删除）
if (script.status === 1) {
  return { code: 403, message: '已发布的无法删除' }
}

// 4. 执行软删除
await db.collection('opendb-botc-scripts')
  .doc(scriptId)
  .update({
    deleted_at: Date.now(),
    status: -1
  })
```

---

## 🎯 与剧本上传功能的关联

### 完整流程图
```
工具页面
    ↓
剧本上传页面
    ↓
粘贴JSON → 解析 → 提交
    ↓
调用 script-upload 云函数
    ↓
生成SVG预览图 → 保存数据库（status=0）
    ↓
返回"我的"页面
    ↓
查看"我的上传"
    ↓
显示刚上传的剧本（待审核状态）
```

### 数据关联
```
用户上传 (script-upload)
    ↓
保存到数据库
creator_id = 当前用户ID
status = 0 (待审核)
    ↓
我的上传页面查询 (script-my-uploads)
WHERE creator_id = 当前用户ID
    ↓
显示该用户的所有剧本
```

---

## ✅ 测试清单

### 功能测试
- [ ] "我的"页面显示"我的上传"入口
- [ ] 点击"我的上传"跳转正常
- [ ] 我的上传页面正常显示
- [ ] 状态筛选功能正常
- [ ] 快捷上传按钮可用
- [ ] 剧本列表显示正确
- [ ] 预览图显示正常
- [ ] 下拉刷新可用
- [ ] 加载更多可用
- [ ] 删除功能正常

### 云函数测试
- [ ] script-my-uploads 部署成功
- [ ] script-delete 部署成功
- [ ] 查询列表返回正确
- [ ] 权限验证正常
- [ ] 删除操作成功

### 集成测试
- [ ] 上传剧本后在列表中可见
- [ ] 删除剧本后从列表移除
- [ ] 状态筛选准确
- [ ] 数量统计正确

---

## 🔐 权限控制

### 页面权限
- ✅ "我的上传"页面需要登录
- ✅ 未登录自动跳转登录页

### 操作权限
- ✅ 只能查看自己上传的剧本
- ✅ 只能删除自己上传的剧本
- ✅ 已发布的剧本不能删除

### 数据隔离
- ✅ 云函数验证用户身份
- ✅ 数据库查询过滤 creator_id
- ✅ 防止越权操作

---

## 🎨 UI设计说明

### 颜色方案
```
主题色:   #f5576c (粉红)
辅助色:   #f093fb (紫粉)
待审核:   #faad14 (黄色)
已发布:   #52c41a (绿色)
已拒绝:   #f5222d (红色)
```

### 交互反馈
- 点击卡片缩放 0.98
- 状态标签带颜色区分
- 按钮有渐变和阴影
- 加载有动画效果

---

## 📈 后续优化

### 功能优化
1. **编辑功能**: 允许编辑待审核的剧本
2. **拒绝原因**: 显示管理员的拒绝原因
3. **重新提交**: 修改后重新提交审核
4. **数据统计**: 查看浏览、下载、收藏数据

### 体验优化
1. **预览图缓存**: 避免重复加载
2. **骨架屏**: 加载时显示占位
3. **下拉刷新**: 自动刷新状态
4. **错误提示**: 更友好的错误信息

---

## 🎉 完成总结

### 实现功能
✅ 在"我的"页面添加"我的上传"入口
✅ 创建"我的上传"列表页面
✅ 创建查询云函数 script-my-uploads
✅ 创建删除云函数 script-delete
✅ 状态筛选和统计
✅ 编辑和删除功能
✅ 下拉刷新和加载更多

### 技术特点
✅ 参考收藏页面的成功结构
✅ 云函数权限验证
✅ 软删除机制
✅ 统一的视觉设计
✅ 完善的错误处理

### 用户价值
✅ 方便管理自己上传的剧本
✅ 实时查看审核状态
✅ 快捷上传和编辑
✅ 数据统计一目了然

---

**创建日期**: 2025年10月15日  
**状态**: ✅ 完成  
**版本**: v1.0.0

