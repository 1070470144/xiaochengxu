# ç³»ç»Ÿæ¶ˆæ¯åŠŸèƒ½ - é—®é¢˜æ’æŸ¥

## ğŸ” é—®é¢˜ï¼šåŠ è½½å¤±è´¥

### æ­¥éª¤1ï¼šç¡®è®¤æ•°æ®åº“è¡¨å·²åˆ›å»º

**åœ¨ uniCloud webæ§åˆ¶å°**ï¼š
1. ç™»å½• https://unicloud.dcloud.net.cn
2. é€‰æ‹©ä½ çš„æœåŠ¡ç©ºé—´
3. ç‚¹å‡»"äº‘æ•°æ®åº“"
4. æŸ¥çœ‹æ˜¯å¦æœ‰ `botc-system-messages` è¡¨

**å¦‚æœæ²¡æœ‰**ï¼š
- é‡æ–°ä¸Šä¼ ï¼šå³é”® `botc-system-messages.schema.json` â†’ ä¸Šä¼ DB Schema

---

### æ­¥éª¤2ï¼šæ£€æŸ¥è¡¨æƒé™

**åœ¨ uniCloud webæ§åˆ¶å°**ï¼š
1. è¿›å…¥"äº‘æ•°æ®åº“"
2. ç‚¹å‡» `botc-system-messages` è¡¨
3. ç‚¹å‡»"è¡¨ç»“æ„"
4. æŸ¥çœ‹"æƒé™è§„åˆ™"

**åº”è¯¥æ˜¯**ï¼š
```json
{
  "read": true,
  "create": false,
  "update": true,
  "delete": false
}
```

**å¦‚æœä¸æ˜¯**ï¼š
- é‡æ–°ä¸Šä¼  schema æ–‡ä»¶

---

### æ­¥éª¤3ï¼šæ‰‹åŠ¨åˆ›å»ºæµ‹è¯•æ•°æ®

**åœ¨ uniCloud webæ§åˆ¶å°**ï¼š
1. è¿›å…¥"äº‘æ•°æ®åº“"
2. ç‚¹å‡» `botc-system-messages` è¡¨
3. ç‚¹å‡»"æ·»åŠ è®°å½•"
4. å¡«å…¥ä»¥ä¸‹æ•°æ®ï¼š

```json
{
  "user_id": "ä½ çš„ç”¨æˆ·ID",
  "type": "notice",
  "title": "æµ‹è¯•æ¶ˆæ¯",
  "content": "è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯",
  "is_read": false,
  "created_at": 1730000000000
}
```

**è·å–ä½ çš„ç”¨æˆ·ID**ï¼š
- åœ¨å°ç¨‹åºä¸­ï¼Œæ‰“å¼€æ§åˆ¶å°
- æŸ¥çœ‹ `Auth.getUserInfo()` çš„è¾“å‡º
- å¤åˆ¶ `uid` æˆ– `_id` å­—æ®µ

---

### æ­¥éª¤4ï¼šæŸ¥çœ‹è¯¦ç»†æ—¥å¿—

**ä¿®æ”¹åçš„ä»£ç ä¼šè¾“å‡º**ï¼š
```
ç”¨æˆ·ä¿¡æ¯: {...}
ç”¨æˆ·ID: xxx
å¼€å§‹æŸ¥è¯¢æ¶ˆæ¯ï¼Œuser_id: xxx
æŸ¥è¯¢ç»“æœ: {...}
æ¶ˆæ¯æ•°é‡: 0
```

**å¦‚æœçœ‹åˆ°é”™è¯¯**ï¼š
- è®°å½•é”™è¯¯ä¿¡æ¯
- æ£€æŸ¥é”™è¯¯ä»£ç 

---

## ğŸ› å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

### é”™è¯¯1ï¼š`Permission denied`

**åŸå› **ï¼šæƒé™é…ç½®é”™è¯¯

**è§£å†³**ï¼š
1. ä¿®æ”¹ `botc-system-messages.schema.json`
2. å°† `read` å’Œ `update` æ”¹ä¸º `true`
3. é‡æ–°ä¸Šä¼ 

---

### é”™è¯¯2ï¼š`Collection not found`

**åŸå› **ï¼šæ•°æ®åº“è¡¨ä¸å­˜åœ¨

**è§£å†³**ï¼š
1. åœ¨ uniCloud æ§åˆ¶å°æ‰‹åŠ¨åˆ›å»ºè¡¨
2. è¡¨åï¼š`botc-system-messages`
3. æˆ–é‡æ–°ä¸Šä¼  schema

---

### é”™è¯¯3ï¼š`user_id is undefined`

**åŸå› **ï¼šç”¨æˆ·IDè·å–å¤±è´¥

**è§£å†³**ï¼š
1. ç¡®è®¤ç”¨æˆ·å·²ç™»å½•
2. æ£€æŸ¥ `Auth.getUserInfo()` è¿”å›å€¼
3. ç¡®è®¤ token æœ‰æ•ˆ

---

## ğŸ”§ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨äº‘å‡½æ•°æŸ¥è¯¢

åˆ›å»ºäº‘å‡½æ•° `get-system-messages`ï¼š

```javascript
'use strict';
exports.main = async (event, context) => {
  const { token } = event
  const userId = token.split('_')[0]
  
  const db = uniCloud.database()
  const res = await db.collection('botc-system-messages')
    .where({ user_id: userId })
    .orderBy('created_at', 'desc')
    .limit(20)
    .get()
  
  return {
    code: 0,
    data: res.data
  }
}
```

ä¿®æ”¹å‰ç«¯ä»£ç ï¼š
```javascript
const res = await uniCloud.callFunction({
  name: 'get-system-messages',
  data: { token: Auth.getToken() }
})
this.messages = res.result.data
```

---

### æ–¹æ¡ˆ2ï¼šæ£€æŸ¥æœåŠ¡ç©ºé—´

**ç¡®è®¤ä½¿ç”¨çš„æ˜¯æ­£ç¡®çš„æœåŠ¡ç©ºé—´**ï¼š
1. æ‰“å¼€ `uniCloud/spaces.json`
2. ç¡®è®¤ `spaceId` æ­£ç¡®
3. ç¡®è®¤å½“å‰è¿æ¥çš„æ˜¯è¿™ä¸ªæœåŠ¡ç©ºé—´

---

## ğŸ“ éœ€è¦æä¾›çš„ä¿¡æ¯

å¦‚æœé—®é¢˜ä»æœªè§£å†³ï¼Œè¯·æä¾›ï¼š

1. **æ§åˆ¶å°å®Œæ•´æ—¥å¿—**ï¼ˆåŒ…æ‹¬é”™è¯¯ä¿¡æ¯ï¼‰
2. **æ•°æ®åº“è¡¨æˆªå›¾**ï¼ˆæ˜¾ç¤ºè¡¨åå’Œæƒé™ï¼‰
3. **ç”¨æˆ·ä¿¡æ¯**ï¼ˆ`Auth.getUserInfo()` çš„è¾“å‡ºï¼‰
4. **æŸ¥è¯¢ç»“æœ**ï¼ˆ`console.log('æŸ¥è¯¢ç»“æœ:', res)` çš„è¾“å‡ºï¼‰

---

## âœ… éªŒè¯æ­¥éª¤

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼ŒæŒ‰é¡ºåºéªŒè¯ï¼š

1. [ ] æ•°æ®åº“è¡¨å­˜åœ¨
2. [ ] æƒé™é…ç½®æ­£ç¡®
3. [ ] æ‰‹åŠ¨æ·»åŠ çš„æµ‹è¯•æ•°æ®å¯è§
4. [ ] æ§åˆ¶å°æ— é”™è¯¯æ—¥å¿—
5. [ ] æ¶ˆæ¯åˆ—è¡¨å¯ä»¥æ­£å¸¸æ˜¾ç¤º
6. [ ] ç‚¹å‡»æ¶ˆæ¯å¯ä»¥æŸ¥çœ‹è¯¦æƒ…
7. [ ] æ ‡è®°å·²è¯»åŠŸèƒ½æ­£å¸¸

