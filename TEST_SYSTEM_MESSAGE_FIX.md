# 系统消息修复 - 快速测试

## 🚀 快速测试步骤（5分钟）

### 步骤1：更新代码
```bash
# 代码已自动更新
# 文件：botc-admin/pages/botc/post/audit-list.vue
```

### 步骤2：重启管理端
```bash
# 如果管理端正在运行，重启它
# 按 Ctrl+C 停止，然后重新运行：
npm run dev
```

### 步骤3：执行测试

#### 3.1 准备测试帖子

1. 打开小程序
2. 发布一条测试帖子（随便写点内容）
3. 记住这个帖子的内容

#### 3.2 管理端隐藏并警告

1. 打开管理端：`http://localhost:9001`（或你的地址）
2. 登录管理员账号
3. 进入"帖子管理" → "帖子审核管理"
4. 找到刚才发的测试帖子
5. 点击"隐藏"按钮
6. **重要**：在弹窗中点击"**隐藏并警告**"（不是"仅隐藏"）

#### 3.3 查看控制台（F12）

应该看到：
```
=== 准备发送系统消息 ===
目标用户ID: 65xxxxxxxxxxxxx
帖子内容: 测试帖子内容
消息数据: {user_id: "65xxx", type: "warning", ...}
系统消息发送结果: {id: "673xxx", ...}
✅ 系统消息发送成功，ID: 673xxxxx
```

✅ **如果看到"发送成功"** → 继续下一步  
❌ **如果报错** → 记录错误信息，反馈给我

#### 3.4 验证数据库

1. 打开 uniCloud Web控制台：https://unicloud.dcloud.net.cn
2. 选择你的服务空间
3. 云数据库 → `botc-system-messages`
4. 查看最新的一条记录

**应该看到**：
- `user_id`: 你的用户ID
- `type`: "warning"
- `title`: "内容违规警告"
- `content`: 包含你的帖子内容
- `is_read`: false
- `created_at`: 当前时间（时间戳格式）

✅ **有这条记录** → 继续下一步  
❌ **没有记录** → 查看控制台错误，反馈给我

#### 3.5 验证客户端显示

1. 打开小程序（用发帖的账号）
2. 进入"我的"页面
3. 点击"系统消息"

**应该看到**：
```
⚠️ 内容违规警告              刚刚
您发布的帖子"测试帖子内容..."因违反社区规范已被隐藏。
请遵守社区规则，避免发布违规内容。
```

✅ **能看到** → 🎉 问题已解决！  
❌ **看不到** → 继续下面的调试

---

## 🔍 如果客户端看不到消息

### 调试步骤A：检查用户ID

**在管理端控制台**（刚才的日志）：
```
目标用户ID: 65abc123def456...
```

**在小程序控制台**（打开"系统消息"页面）：
```
=== 用户信息详情 ===
提取的userId: 65abc123def456...
```

**对比两个ID**：
- ✅ **完全一致** → 继续调试步骤B
- ❌ **不一致** → 这是问题所在！

**如果不一致，可能的原因**：
1. 发帖账号和查看消息的账号不是同一个
2. 用户ID提取逻辑有问题

### 调试步骤B：手动创建测试消息

1. 打开 uniCloud Web控制台
2. 云数据库 → `botc-system-messages`
3. 点击"添加记录"
4. 填入：

```json
{
  "user_id": "在小程序控制台看到的userId（完整复制）",
  "type": "notice",
  "title": "手动测试消息",
  "content": "如果你能看到这条消息，说明查询功能正常",
  "related_type": "",
  "related_id": "",
  "is_read": false
}
```

5. 保存后，刷新小程序"系统消息"页面

**结果判断**：
- ✅ **能看到手动消息** → 说明查询正常，问题在管理端的 user_id
- ❌ **也看不到** → 说明查询有问题，检查权限配置

### 调试步骤C：检查数据库权限

1. uniCloud控制台 → 云数据库 → `botc-system-messages`
2. 点击"表结构"
3. 查看"权限规则"

**应该是**：
```json
{
  "read": true,
  "create": false,
  "update": true,
  "delete": false
}
```

**如果不是**：
1. 修改为上述配置
2. 点击"保存"
3. 重新测试

---

## 📊 测试结果记录

请填写测试结果：

### 管理端测试
- [ ] 控制台显示"准备发送系统消息"
- [ ] 控制台显示"系统消息发送成功"
- [ ] 显示的目标用户ID：`___________________`

### 数据库验证
- [ ] 数据库中有新增的消息记录
- [ ] 记录的 `user_id` 字段：`___________________`
- [ ] 记录的 `type` 字段：`___________________`
- [ ] 记录的 `created_at` 有值

### 客户端验证
- [ ] 小程序控制台显示的用户ID：`___________________`
- [ ] 系统消息列表能看到警告消息
- [ ] 点击消息能查看详情
- [ ] 消息内容正确显示

### 结果
- [ ] ✅ 全部通过，问题已解决
- [ ] ❌ 有问题，具体是：`___________________`

---

## 🆘 常见问题速查

### Q1: 控制台没有"准备发送系统消息"日志
**原因**：代码没更新或缓存  
**解决**：
1. 确认 `audit-list.vue` 文件已更新
2. 强制刷新浏览器（Ctrl+Shift+R）
3. 重启管理端服务

### Q2: 显示"系统消息发送失败"
**原因**：数据库权限或网络问题  
**解决**：
1. 检查数据库权限（read: true, update: true）
2. 检查网络连接
3. 查看完整错误信息

### Q3: 数据库有记录，但客户端看不到
**原因**：用户ID不匹配  
**解决**：
1. 对比管理端和客户端的用户ID
2. 确认使用的是同一个账号
3. 手动创建测试消息验证查询功能

### Q4: 手动消息也看不到
**原因**：数据库权限或查询逻辑问题  
**解决**：
1. 检查 `botc-system-messages.schema.json` 权限
2. 重新上传 schema 文件
3. 检查小程序是否连接正确的服务空间

---

## 📞 反馈模板

如果问题仍未解决，请提供以下信息：

```
### 测试环境
- 管理端地址: http://___________
- 服务空间ID: ___________
- uniCloud类型: 阿里云/腾讯云

### 管理端日志
（粘贴完整控制台日志）

### 数据库截图
（上传 botc-system-messages 表的截图）

### 客户端日志
（粘贴小程序控制台日志）

### 用户ID对比
- 管理端看到的user_id: ___________
- 客户端看到的userId: ___________
- 数据库记录的user_id: ___________

### 测试结果
- 手动创建的测试消息能否看到: 能/不能
- 数据库权限配置: （粘贴权限JSON）
```

---

**测试时间**：`___________`  
**测试人**：`___________`  
**测试结果**：✅通过 / ❌失败

