# ğŸ”§ ä¸¾æŠ¥å¤„ç†æ¶ˆæ¯æœªæ˜¾ç¤º - è°ƒè¯•æŒ‡å—

## âŒ é—®é¢˜ç°è±¡

ç‚¹å‡»"éšè—å¹¶è­¦å‘Š"åï¼Œå°ç¨‹åºç«¯"ç³»ç»Ÿæ¶ˆæ¯"ä¸­æ²¡æœ‰æ˜¾ç¤ºæ¶ˆæ¯ã€‚

---

## ğŸ” æ’æŸ¥æ¸…å•

### âœ… æ­¥éª¤1ï¼šç¡®è®¤äº‘å‡½æ•°å·²ä¸Šä¼ 

```bash
å³é”®ï¼šbotc-admin/uniCloud-aliyun/cloudfunctions/reports-admin
â†’ ä¸Šä¼ éƒ¨ç½²
â†’ ç­‰å¾…æ˜¾ç¤º"ä¸Šä¼ æˆåŠŸ"
```

**éªŒè¯æ–¹æ³•ï¼š**
1. æ‰“å¼€ uniCloud webæ§åˆ¶å°
2. è¿›å…¥ï¼šäº‘å‡½æ•°/äº‘å¯¹è±¡
3. æ‰¾åˆ° `reports-admin`
4. æŸ¥çœ‹"æ›´æ–°æ—¶é—´"æ˜¯å¦æ˜¯æœ€æ–°çš„

---

### âœ… æ­¥éª¤2ï¼šç¡®è®¤Schemaå·²ä¸Šä¼ 

```bash
å³é”®ï¼šbotc-miniprogram/uniCloud-aliyun/database/botc-system-messages.schema.json
â†’ ä¸Šä¼ DB Schema
â†’ ç­‰å¾…æ˜¾ç¤º"ä¸Šä¼ æˆåŠŸ"
```

**éªŒè¯æ–¹æ³•ï¼š**
1. æ‰“å¼€ uniCloud webæ§åˆ¶å°
2. è¿›å…¥ï¼šäº‘æ•°æ®åº“
3. æ‰¾åˆ° `botc-system-messages` è¡¨
4. ç‚¹å‡»"è¡¨ç»“æ„"æŸ¥çœ‹å­—æ®µå®šä¹‰

---

### âœ… æ­¥éª¤3ï¼šæŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—

```bash
1. uniCloud webæ§åˆ¶å°
2. äº‘å‡½æ•°/äº‘å¯¹è±¡ â†’ reports-admin
3. ç‚¹å‡»"æ—¥å¿—"
4. æ‰¾åˆ°æœ€è¿‘çš„æ‰§è¡Œè®°å½•
5. æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯æˆ–æˆåŠŸæ—¥å¿—
```

**æœŸæœ›çœ‹åˆ°çš„æ—¥å¿—ï¼š**
```
å·²è­¦å‘Šç”¨æˆ· user_xxx
å·²å‘é€ç³»ç»Ÿæ¶ˆæ¯ç»™ç”¨æˆ· user_xxx
```

**å¦‚æœçœ‹åˆ°é”™è¯¯ï¼š**
```
è­¦å‘Šå¤±è´¥ï¼šæœªæ‰¾åˆ°è¢«ä¸¾æŠ¥ç”¨æˆ·ID
```
â†’ è¯´æ˜æ²¡æœ‰è·å–åˆ°ç”¨æˆ·IDï¼Œè·³åˆ°æ­¥éª¤4

---

### âœ… æ­¥éª¤4ï¼šæ£€æŸ¥ä¸¾æŠ¥æ•°æ®

åœ¨ uniCloud webæ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
db.collection('botc-reports')
  .orderBy('created_at', 'desc')
  .limit(1)
  .get()
  .then(res => {
    console.log('æœ€æ–°ä¸¾æŠ¥è®°å½•ï¼š', res.data[0])
    console.log('content_type:', res.data[0].content_type)
    console.log('content_id:', res.data[0].content_id)
    console.log('reported_user_id:', res.data[0].reported_user_id)
  })
```

**æ£€æŸ¥ç‚¹ï¼š**
- âœ… `content_type` æœ‰å€¼ï¼ˆpost/comment/scriptç­‰ï¼‰
- âœ… `content_id` æœ‰å€¼ï¼ˆè¢«ä¸¾æŠ¥å†…å®¹çš„IDï¼‰
- âš ï¸ `reported_user_id` å¯èƒ½ä¸ºç©ºï¼ˆç³»ç»Ÿä¼šè‡ªåŠ¨è·å–ï¼‰

---

### âœ… æ­¥éª¤5ï¼šæ£€æŸ¥è¢«ä¸¾æŠ¥çš„å†…å®¹æ˜¯å¦å­˜åœ¨

```javascript
// å‡è®¾ content_type = 'post', content_id = 'xxx'
db.collection('botc-posts')
  .doc('content_id')
  .get()
  .then(res => {
    if (res.data.length > 0) {
      console.log('å¸–å­å­˜åœ¨ï¼Œä½œè€…ID:', res.data[0].user_id)
    } else {
      console.log('å¸–å­ä¸å­˜åœ¨æˆ–å·²åˆ é™¤')
    }
  })
```

**å¦‚æœå†…å®¹ä¸å­˜åœ¨ï¼š**
- å¯èƒ½å·²è¢«åˆ é™¤
- ç³»ç»Ÿæ— æ³•è·å–ä½œè€…ID
- æ— æ³•å‘é€æ¶ˆæ¯

---

### âœ… æ­¥éª¤6ï¼šæ‰‹åŠ¨æµ‹è¯•å‘é€æ¶ˆæ¯

åœ¨ uniCloud webæ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
db.collection('botc-system-messages').add({
  user_id: 'ä½ çš„ç”¨æˆ·ID',  // æ›¿æ¢ä¸ºå®é™…çš„ç”¨æˆ·ID
  type: 'warning',
  title: 'æµ‹è¯•æ¶ˆæ¯',
  content: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯',
  related_type: '',
  related_id: '',
  is_read: false
})
.then(res => {
  console.log('æ¶ˆæ¯åˆ›å»ºæˆåŠŸï¼š', res)
})
.catch(err => {
  console.error('æ¶ˆæ¯åˆ›å»ºå¤±è´¥ï¼š', err)
})
```

**ç„¶åï¼š**
1. åˆ·æ–°å°ç¨‹åº
2. è¿›å…¥"æˆ‘çš„" â†’ "ç³»ç»Ÿæ¶ˆæ¯"
3. æŸ¥çœ‹æ˜¯å¦æ˜¾ç¤ºæµ‹è¯•æ¶ˆæ¯

**å¦‚æœæ˜¾ç¤ºï¼š**
â†’ è¯´æ˜æ¶ˆæ¯åŠŸèƒ½æ­£å¸¸ï¼Œé—®é¢˜åœ¨äºä¸¾æŠ¥å¤„ç†æµç¨‹

**å¦‚æœä¸æ˜¾ç¤ºï¼š**
â†’ è¯´æ˜æ¶ˆæ¯æŸ¥è¯¢æœ‰é—®é¢˜ï¼Œè·³åˆ°æ­¥éª¤7

---

### âœ… æ­¥éª¤7ï¼šæ£€æŸ¥å°ç¨‹åºæŸ¥è¯¢é€»è¾‘

æ‰“å¼€ `botc-miniprogram/pages/user/system-messages/list.vue`

æ£€æŸ¥æŸ¥è¯¢æ¡ä»¶ï¼š

```javascript
const res = await db.collection('botc-system-messages')
  .where({
    user_id: userId,  // â† ç¡®è®¤è¿™ä¸ªuserIdæ˜¯å¦æ­£ç¡®
    is_read: false    // â† å¦‚æœä½ å·²è¯»äº†æ¶ˆæ¯ï¼Œè¿™é‡Œä¼šæŸ¥ä¸åˆ°
  })
  .get()
```

**è°ƒè¯•æ–¹æ³•ï¼š**
```javascript
// ä¸´æ—¶å»æ‰ is_read æ¡ä»¶
const res = await db.collection('botc-system-messages')
  .where({
    user_id: userId
  })
  .orderBy('created_at', 'desc')
  .limit(10)
  .get()

console.log('æŸ¥è¯¢åˆ°çš„æ¶ˆæ¯ï¼š', res.data)
```

---

## ğŸ› å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šäº‘å‡½æ•°æœªä¸Šä¼ 
**ç—‡çŠ¶**ï¼šäº‘å‡½æ•°æ—¥å¿—ä¸­æ²¡æœ‰æ–°è®°å½•  
**è§£å†³**ï¼šé‡æ–°ä¸Šä¼  `reports-admin` äº‘å‡½æ•°

### é—®é¢˜2ï¼šreported_user_id ä¸ºç©º
**ç—‡çŠ¶**ï¼šæ—¥å¿—æ˜¾ç¤º"è­¦å‘Šå¤±è´¥ï¼šæœªæ‰¾åˆ°è¢«ä¸¾æŠ¥ç”¨æˆ·ID"  
**è§£å†³**ï¼š
1. æ£€æŸ¥è¢«ä¸¾æŠ¥å†…å®¹æ˜¯å¦å­˜åœ¨
2. æ£€æŸ¥å†…å®¹è¡¨ä¸­æ˜¯å¦æœ‰ `user_id` å­—æ®µ
3. å¯èƒ½éœ€è¦æ‰‹åŠ¨è¡¥å…… `reported_user_id`

### é—®é¢˜3ï¼šæ¶ˆæ¯åˆ›å»ºå¤±è´¥
**ç—‡çŠ¶**ï¼šæ—¥å¿—æ˜¾ç¤º"å‘é€ç³»ç»Ÿæ¶ˆæ¯å¤±è´¥"  
**è§£å†³**ï¼š
1. æ£€æŸ¥Schemaæ˜¯å¦ä¸Šä¼ 
2. æ£€æŸ¥å­—æ®µåæ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥æ•°æ®åº“æƒé™

### é—®é¢˜4ï¼šæ¶ˆæ¯æŸ¥è¯¢ä¸åˆ°
**ç—‡çŠ¶**ï¼šæ•°æ®åº“æœ‰æ¶ˆæ¯ï¼Œä½†å°ç¨‹åºæ˜¾ç¤ºä¸ºç©º  
**è§£å†³**ï¼š
1. æ£€æŸ¥ `user_id` æ˜¯å¦åŒ¹é…
2. æ£€æŸ¥æ˜¯å¦è¢« `is_read: false` è¿‡æ»¤äº†
3. åˆ·æ–°å°ç¨‹åºç¼“å­˜

### é—®é¢˜5ï¼šuser_id ä¸åŒ¹é…
**ç—‡çŠ¶**ï¼šæ¶ˆæ¯çš„ `user_id` å’Œå½“å‰ç”¨æˆ·ä¸åŒ  
**è§£å†³**ï¼š
1. ç¡®è®¤å¤„ç†çš„æ˜¯æ­£ç¡®çš„ä¸¾æŠ¥è®°å½•
2. ç¡®è®¤è¢«ä¸¾æŠ¥ç”¨æˆ·IDè·å–æ­£ç¡®
3. æ£€æŸ¥æ˜¯å¦å¤„ç†äº†é”™è¯¯çš„ä¸¾æŠ¥

---

## ğŸ§ª å®Œæ•´æµ‹è¯•æµç¨‹

### æµ‹è¯•1ï¼šæ‰‹åŠ¨åˆ›å»ºä¸¾æŠ¥è®°å½•

```javascript
// 1. åˆ›å»ºæµ‹è¯•ä¸¾æŠ¥
db.collection('botc-reports').add({
  reporter_id: 'test_reporter',
  reporter_nickname: 'æµ‹è¯•ä¸¾æŠ¥äºº',
  content_type: 'post',
  content_id: 'çœŸå®å­˜åœ¨çš„å¸–å­ID',  // â† æ›¿æ¢ä¸ºçœŸå®çš„
  content_title: 'æµ‹è¯•å¸–å­',
  reported_user_id: '',  // ç•™ç©ºè®©ç³»ç»Ÿè‡ªåŠ¨è·å–
  reason: 'spam',
  description: 'æµ‹è¯•ä¸¾æŠ¥',
  images: [],
  status: 'pending',
  created_at: Date.now()
})
```

### æµ‹è¯•2ï¼šé€šè¿‡ç®¡ç†åå°å¤„ç†

```bash
1. åˆ·æ–°ç®¡ç†åå°"ä¸¾æŠ¥ç®¡ç†"
2. æ‰¾åˆ°åˆšæ‰åˆ›å»ºçš„ä¸¾æŠ¥
3. ç‚¹å‡»"å¤„ç†"
4. é€‰æ‹©"è­¦å‘Šç”¨æˆ·"
5. å¡«å†™å¤‡æ³¨
6. ç‚¹å‡»"ç¡®å®š"
```

### æµ‹è¯•3ï¼šæŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—

```bash
1. uniCloudæ§åˆ¶å° â†’ äº‘å‡½æ•°
2. reports-admin â†’ æ—¥å¿—
3. æŸ¥çœ‹æœ€æ–°æ‰§è¡Œè®°å½•
4. ç¡®è®¤æ˜¯å¦æœ‰æˆåŠŸæ—¥å¿—
```

### æµ‹è¯•4ï¼šæŸ¥çœ‹æ•°æ®åº“

```javascript
// æŸ¥è¯¢ç³»ç»Ÿæ¶ˆæ¯
db.collection('botc-system-messages')
  .orderBy('created_at', 'desc')
  .limit(1)
  .get()
  .then(res => {
    console.log('æœ€æ–°æ¶ˆæ¯ï¼š', res.data[0])
  })
```

### æµ‹è¯•5ï¼šå°ç¨‹åºç«¯éªŒè¯

```bash
1. ç™»å½•è¢«è­¦å‘Šç”¨æˆ·çš„è´¦å·
2. è¿›å…¥"æˆ‘çš„"
3. ç‚¹å‡»"ç³»ç»Ÿæ¶ˆæ¯"
4. æŸ¥çœ‹æ˜¯å¦æ˜¾ç¤ºè­¦å‘Šæ¶ˆæ¯
```

---

## ğŸ”§ ä¸´æ—¶è°ƒè¯•ä»£ç 

### åœ¨äº‘å‡½æ•°ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—

ä¿®æ”¹ `reports-admin/index.js` çš„ `warnUser` å‡½æ•°ï¼š

```javascript
async function warnUser(userId, contentType) {
  console.log('[è°ƒè¯•] warnUser å¼€å§‹')
  console.log('[è°ƒè¯•] userId:', userId)
  console.log('[è°ƒè¯•] contentType:', contentType)
  
  if (!userId) {
    console.log('[è°ƒè¯•] ç”¨æˆ·IDä¸ºç©ºï¼Œæ— æ³•å‘é€è­¦å‘Š')
    return false
  }
  
  try {
    // å‘é€è­¦å‘Šæ¶ˆæ¯
    console.log('[è°ƒè¯•] å‡†å¤‡å‘é€ç³»ç»Ÿæ¶ˆæ¯')
    const result = await sendSystemMessage({
      userId: userId,
      type: 'warning',
      title: 'è¿è§„è­¦å‘Š',
      content: `æ‚¨å‘å¸ƒçš„${getContentTypeName(contentType)}å­˜åœ¨è¿è§„è¡Œä¸ºï¼Œå·²è¢«ç®¡ç†å‘˜è­¦å‘Šã€‚è¯·æ³¨æ„éµå®ˆç¤¾åŒºè§„èŒƒï¼Œå¤šæ¬¡è¿è§„å°†è¢«å°ç¦è´¦å·ã€‚`,
      relatedType: contentType,
      relatedId: ''
    })
    console.log('[è°ƒè¯•] ç³»ç»Ÿæ¶ˆæ¯å‘é€ç»“æœ:', result)
    
    // è®°å½•è­¦å‘Šæ¬¡æ•°
    console.log('[è°ƒè¯•] å‡†å¤‡æ›´æ–°ç”¨æˆ·è­¦å‘Šæ¬¡æ•°')
    await db.collection('uni-id-users')
      .doc(userId)
      .update({
        warning_count: dbCmd.inc(1),
        last_warning_at: Date.now()
      })
    console.log('[è°ƒè¯•] ç”¨æˆ·è­¦å‘Šæ¬¡æ•°æ›´æ–°æˆåŠŸ')
    
    console.log(`[è°ƒè¯•] å·²è­¦å‘Šç”¨æˆ· ${userId}`)
    return true
  } catch (error) {
    console.error('[è°ƒè¯•] è­¦å‘Šç”¨æˆ·å¤±è´¥ï¼š', error)
    return false
  }
}
```

### åœ¨ sendSystemMessage ä¸­æ·»åŠ æ—¥å¿—

```javascript
async function sendSystemMessage({ userId, type, title, content, relatedType, relatedId }) {
  console.log('[è°ƒè¯•] sendSystemMessage å¼€å§‹')
  console.log('[è°ƒè¯•] å‚æ•°:', { userId, type, title, content })
  
  try {
    const result = await db.collection('botc-system-messages').add({
      user_id: userId,
      type: type || 'system',
      title: title,
      content: content,
      related_type: relatedType || '',
      related_id: relatedId || '',
      is_read: false
    })
    console.log('[è°ƒè¯•] æ¶ˆæ¯åˆ›å»ºç»“æœ:', result)
    console.log(`[è°ƒè¯•] å·²å‘é€ç³»ç»Ÿæ¶ˆæ¯ç»™ç”¨æˆ· ${userId}`)
    return true
  } catch (error) {
    console.error('[è°ƒè¯•] å‘é€ç³»ç»Ÿæ¶ˆæ¯å¤±è´¥ï¼š', error)
    console.error('[è°ƒè¯•] é”™è¯¯è¯¦æƒ…:', JSON.stringify(error))
    return false
  }
}
```

---

## ğŸ“‹ å¿«é€Ÿæ£€æŸ¥æ¸…å•

å®Œæˆå¤„ç†åï¼ŒæŒ‰é¡ºåºæ£€æŸ¥ï¼š

- [ ] äº‘å‡½æ•°å·²ä¸Šä¼ ï¼ˆæŸ¥çœ‹æ›´æ–°æ—¶é—´ï¼‰
- [ ] Schemaå·²ä¸Šä¼ ï¼ˆè¡¨ç»“æ„æ­£ç¡®ï¼‰
- [ ] äº‘å‡½æ•°æ—¥å¿—æœ‰æ‰§è¡Œè®°å½•
- [ ] æ—¥å¿—ä¸­æ˜¾ç¤º"å·²å‘é€ç³»ç»Ÿæ¶ˆæ¯"
- [ ] æ•°æ®åº“ä¸­æœ‰æ–°çš„æ¶ˆæ¯è®°å½•
- [ ] æ¶ˆæ¯çš„ `user_id` æ­£ç¡®
- [ ] å°ç¨‹åºèƒ½æŸ¥è¯¢åˆ°æ¶ˆæ¯
- [ ] æ¶ˆæ¯æ­£å¸¸æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­

---

## ğŸ¯ æœ€å¯èƒ½çš„åŸå› 

æ ¹æ®ç»éªŒï¼Œæœ€å¸¸è§çš„åŸå› æ˜¯ï¼š

### 1. äº‘å‡½æ•°æœªä¸Šä¼ ï¼ˆ60%ï¼‰
â†’ é‡æ–°ä¸Šä¼ äº‘å‡½æ•°

### 2. reported_user_id ä¸ºç©ºä¸”æ— æ³•è‡ªåŠ¨è·å–ï¼ˆ20%ï¼‰
â†’ è¢«ä¸¾æŠ¥å†…å®¹å·²åˆ é™¤æˆ–ä¸å­˜åœ¨

### 3. user_id ä¸åŒ¹é…ï¼ˆ10%ï¼‰
â†’ æ¶ˆæ¯å‘ç»™äº†é”™è¯¯çš„ç”¨æˆ·

### 4. å°ç¨‹åºæŸ¥è¯¢æ¡ä»¶è¿‡æ»¤ï¼ˆ10%ï¼‰
â†’ `is_read: false` æŠŠå·²è¯»æ¶ˆæ¯è¿‡æ»¤äº†

---

## ğŸ’¡ æ¨èè°ƒè¯•é¡ºåº

```
1. ç¡®è®¤äº‘å‡½æ•°å·²ä¸Šä¼  âœ…
   â†“
2. æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿— ğŸ“Š
   â†“
3. æ£€æŸ¥æ˜¯å¦æœ‰"å·²å‘é€"æ—¥å¿—
   â†“
   æœ‰ â†’ 4. æŸ¥çœ‹æ•°æ®åº“æ¶ˆæ¯è®°å½•
   æ—  â†’ æ·»åŠ è°ƒè¯•æ—¥å¿—é‡æ–°ä¸Šä¼ 
   â†“
4. æ¶ˆæ¯è®°å½•å­˜åœ¨ï¼Ÿ
   â†“
   æ˜¯ â†’ 5. æ£€æŸ¥ user_id æ˜¯å¦æ­£ç¡®
   å¦ â†’ æŸ¥çœ‹å‘é€å¤±è´¥åŸå› 
   â†“
5. user_id æ­£ç¡®ï¼Ÿ
   â†“
   æ˜¯ â†’ 6. æ£€æŸ¥å°ç¨‹åºæŸ¥è¯¢é€»è¾‘
   å¦ â†’ æ£€æŸ¥ä¸¾æŠ¥è®°å½•çš„ reported_user_id
   â†“
6. å°ç¨‹åºèƒ½æŸ¥åˆ°æ¶ˆæ¯ï¼Ÿ
   â†“
   èƒ½ â†’ âœ… é—®é¢˜è§£å†³
   å¦ â†’ æ£€æŸ¥æŸ¥è¯¢æ¡ä»¶å’Œç”¨æˆ·ç™»å½•çŠ¶æ€
```

---

**ğŸ” ç°åœ¨è¯·æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤é€æ­¥æ’æŸ¥ï¼Œå‘Šè¯‰æˆ‘åœ¨å“ªä¸€æ­¥å‡ºç°äº†é—®é¢˜ï¼**

