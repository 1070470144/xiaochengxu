# 🌙 预览图夜晚行动顺序功能

## ✅ 功能说明

现在生成的剧本预览图包含完整的夜晚行动顺序，左右两侧分别显示首夜和其他夜晚的行动顺序。

---

## 🖼️ 预览图布局

```
┌─────────────────────────────────┐
│      【剧本标题】【作者】         │
├──┬──────────────────────────┬──┤
│首│  👥 镇民 (8个)            │其│
│夜│  • 贵族 - 能力描述...      │他│
│  │  • 渔夫 - 能力描述...      │夜│
│爪│                           │晚│
│  │  🏃 外来者 (4个)           │  │
│魔│  • 酒鬼 - 能力描述...      │角│
│  │                           │色│
│角│  🗡️ 爪牙 (3个)           │  │
│色│  • 洗脑师 - 能力描述...    │顺│
│  │                           │序│
│顺│  😈 恶魔 (1个)            │  │
│序│  • 小恶魔 - 能力描述...    │  │
└──┴──────────────────────────┴──┘
```

---

## 📊 夜晚行动顺序内容

### 左侧：首夜行动
1. **爪牙互认**（橙色圆圈，文字"爪"）
2. **恶魔认识爪牙**（红色圆圈，文字"魔"）
3. **有首夜行动的角色**（按 `firstNight` 字段排序）
   - 显示角色头像（如果有image字段）
   - 或显示角色名首字母

### 右侧：其他夜晚行动
1. **有其他夜晚行动的角色**（按 `otherNight` 字段排序）
   - 显示角色头像（如果有image字段）
   - 或显示角色名首字母

---

## 🔍 数据提取逻辑

### 提取条件
```javascript
// 首夜行动
firstNight > 0 && team !== 'traveler' && team !== 'fabled'

// 其他夜晚行动
otherNight > 0 && team !== 'traveler' && team !== 'fabled'
```

### 排序规则
- 按 `firstNight` 数字升序排列
- 按 `otherNight` 数字升序排列

### 过滤规则
- ✅ 包含：镇民、外来者、爪牙、恶魔
- ❌ 排除：旅行者、传奇角色

---

## 🎨 视觉设计

### 角色显示
- **有头像**：圆形裁剪显示角色image
- **无头像**：紫色圆圈 + 角色名首字母

### 固定标记
- **爪牙互认**：橙色 (#f97316)
- **恶魔认识爪牙**：红色 (#ef4444)
- **普通角色**：紫色 (#8b5cf6)

### 自适应布局
- 根据角色数量自动调整间距
- 最小间距：22px
- 最大间距：34px
- Logo大小：18-26px

---

## 📝 修改的文件

### 1. script-batch-import/preview-generator.js
**修改位置**：第386-568行  
**新增功能**：`generateNightOrders()` 函数及SVG渲染

### 2. script-generate-preview/preview-generator.js
**完全重写**：包含完整的夜晚行动顺序功能

---

## 🚀 部署步骤

### 重新上传两个云函数

```bash
1. script-batch-import
   右键：botc-admin/uniCloud-aliyun/cloudfunctions/script-batch-import
   选择：「上传部署」

2. script-generate-preview
   右键：botc-admin/uniCloud-aliyun/cloudfunctions/script-generate-preview
   选择：「上传部署」
```

---

## 🧪 测试效果

### 测试1：添加新剧本
```bash
1. 添加剧本，上传包含夜晚行动的JSON
2. 保存
3. 在列表中点击「预览」
4. 查看自动生成的预览图
5. ✅ 应该看到左右两侧的夜晚行动顺序
```

### 测试2：批量导入
```bash
1. 批量导入多个剧本
2. 导入完成后查看任意剧本
3. 点击「预览」
4. ✅ 预览图中有夜晚行动顺序
```

### 测试3：用户端查看
```bash
1. 在小程序中查看刚上传的剧本
2. 查看预览图
3. ✅ 预览图包含夜晚行动顺序
```

---

## 📊 对比

### 之前的预览图
```
只显示：
- 标题、作者
- 角色分类列表
- 角色能力
```

### 现在的预览图
```
显示：
- 标题、作者
- 角色分类列表
- 角色能力
- ✨ 首夜行动顺序（左侧）
- ✨ 其他夜晚行动顺序（右侧）
```

---

## ✅ 完成清单

- [x] 添加夜晚行动顺序渲染函数
- [x] 集成到SVG生成流程
- [x] 支持角色头像显示
- [x] 自适应布局
- [x] 更新两个云函数
- [x] 编写文档

---

**现在上传云函数，重新生成预览图就能看到夜晚行动顺序了！** 🌙✨

