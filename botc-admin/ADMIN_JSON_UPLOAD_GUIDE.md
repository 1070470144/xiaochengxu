# 📁 管理端 - 剧本JSON上传功能说明

## ✅ 功能概述

在管理端的「添加剧本」页面新增了JSON文件上传功能，支持直接上传标准血染钟楼JSON格式文件。

## 🎯 支持的JSON格式

### 标准格式（数组格式）

```json
[
  {
    "id": "_meta",
    "name": "剧本名称",
    "author": "作者名",
    "description": "剧本描述",
    "logo": "https://..."
  },
  {
    "id": "role_id",
    "name": "角色名称",
    "ability": "角色能力",
    "team": "townsfolk",
    "image": "https://...",
    ...
  },
  ...
]
```

### 要求
- ✅ 必须是JSON数组格式 `[...]`
- ✅ 包含角色对象
- ✅ 建议包含 `_meta` 元数据对象
- ✅ 文件大小限制：10MB以内

## 📋 使用步骤

### 1. 进入添加剧本页面

```
管理后台 → BOTC管理 → 剧本管理 → 添加剧本
```

### 2. 上传JSON文件

在「剧本JSON文件」区域：
1. 点击「📁 选择JSON文件」按钮
2. 选择本地的 `.json` 文件
3. 等待文件解析（自动）

### 3. 自动填充表单

如果JSON文件包含 `_meta` 对象，会自动填充：
- **剧本标题**：使用 `meta.name`
- **作者**：使用 `meta.author`
- **剧本描述**：使用 `meta.description`

### 4. 查看文件信息

上传成功后显示：
- ✅ 文件名
- 📦 文件大小
- 🎭 角色数量

### 5. 完成其他信息

填写或修改：
- 副标题（可选）
- 剧本类型（推理/娱乐）
- 难度等级
- 玩家人数
- 预计时长
- 标签
- 发布状态

### 6. 保存

点击「保存」按钮，剧本会保存到数据库，包含完整的JSON数据。

## 🔄 数据流程

```
选择JSON文件
    ↓
读取文件内容
    ↓
解析JSON（JSON.parse）
    ↓
验证格式（必须是数组）
    ↓
保存到 formData.json_data
    ↓
自动填充表单字段
    ↓
显示文件信息
    ↓
用户点击保存
    ↓
存入数据库 botc-scripts 集合
```

## 📊 功能特点

### 1. 智能验证
- ✅ 检查文件类型（.json）
- ✅ 检查文件大小（<10MB）
- ✅ 验证JSON格式（数组）
- ✅ 显示详细错误信息

### 2. 自动填充
- ✅ 从 `_meta` 提取剧本信息
- ✅ 自动填充标题、作者、描述
- ✅ 只填充空字段（不覆盖已填写内容）

### 3. 实时反馈
- ✅ 显示文件名和大小
- ✅ 显示角色数量
- ✅ 支持移除和重新上传

### 4. 数据处理
- ✅ 保存原始JSON数组到 `json_data` 字段
- ✅ 不修改JSON内容
- ✅ 完整保留所有字段

## 📝 JSON示例

### 最小示例
```json
[
  {
    "id": "_meta",
    "name": "我的剧本",
    "author": "作者"
  },
  {
    "id": "washerwoman",
    "name": "洗衣妇",
    "team": "townsfolk",
    "ability": "能力描述"
  }
]
```

### 完整示例
请参考用户query中提供的JSON格式，包含：
- `_meta`：剧本元数据
- `fabled`：传说角色
- `a jinxed`：相克规则
- `townsfolk`：镇民角色
- `outsider`：外来者角色
- `minion`：爪牙角色
- `demon`：恶魔角色
- `traveler`：旅行者角色

## 🧪 测试步骤

### 测试1：正常上传

1. 准备一个标准格式的JSON文件
2. 进入添加剧本页面
3. 点击「选择JSON文件」
4. 选择文件
5. 验证：
   - ✅ 显示文件信息
   - ✅ 自动填充表单
   - ✅ 显示成功提示

### 测试2：格式错误

1. 准备一个非数组格式的JSON（如对象格式）
2. 上传文件
3. 验证：
   - ✅ 显示错误提示「JSON格式错误：必须是数组格式」
   - ✅ 不保存数据

### 测试3：文件过大

1. 准备一个超过10MB的JSON文件
2. 上传文件
3. 验证：
   - ✅ 显示「JSON文件不能超过10MB」
   - ✅ 不读取文件

### 测试4：移除文件

1. 上传一个JSON文件
2. 点击「🗑️ 移除」按钮
3. 验证：
   - ✅ 文件信息清空
   - ✅ 可以重新上传

### 测试5：保存到数据库

1. 上传JSON文件
2. 填写其他信息
3. 点击「保存」
4. 验证：
   - ✅ 保存成功
   - ✅ 在用户端可以看到剧本
   - ✅ 可以复制JSON链接
   - ✅ 复制的链接能在血染工具中使用

## 🎨 UI展示

### 未上传状态
```
┌─────────────────────────────────┐
│                                 │
│          📁                      │
│     选择JSON文件                  │
│                                 │
│  支持标准血染钟楼JSON格式（数组）   │
└─────────────────────────────────┘
```

### 已上传状态
```
┌─────────────────────────────────┐
│ ✅ 我的剧本.json        🗑️ 移除   │
│ 大小：125.5 KB                   │
│ 角色数：18                       │
└─────────────────────────────────┘
```

## ⚠️ 注意事项

### 1. JSON格式要求
- **必须是数组格式**：`[{...}, {...}]`
- **不支持对象格式**：`{meta: [...], roles: [...]}`（会报错）

### 2. 文件限制
- 最大文件大小：10MB
- 只接受 `.json` 扩展名

### 3. 数据保存
- JSON数据保存在 `json_data` 字段
- 保存的是完整数组（包括meta、角色、相克规则等）
- 不会修改或转换JSON内容

### 4. 与用户端的关系
- 用户端复制的JSON链接会返回这里上传的完整数组
- 血染工具可以直接导入

## 🐛 常见问题

### 问题1：上传后提示格式错误

**原因**：JSON不是数组格式

**解决**：
- 检查JSON文件第一个字符是否为 `[`
- 确保整个文件是 `[{}, {}, ...]` 格式

### 问题2：自动填充不生效

**原因**：JSON中没有 `_meta` 对象

**解决**：
- 手动填写表单即可
- 或在JSON中添加 `_meta` 对象

### 问题3：角色数量显示为0

**原因**：JSON中的角色没有 `team` 字段

**解决**：
- 确保每个角色对象包含 `team` 字段
- 支持的team值：townsfolk, outsider, minion, demon, traveler

## ✅ 完成清单

- [x] 添加文件上传UI
- [x] 实现文件读取功能
- [x] JSON格式验证
- [x] 自动填充表单
- [x] 显示文件信息
- [x] 移除文件功能
- [x] 保存到数据库
- [x] CSS样式美化

## 🎉 测试

现在可以：
1. 打开管理后台
2. 进入「添加剧本」页面
3. 上传你的JSON文件
4. 保存剧本
5. 在用户端复制JSON链接
6. 在血染工具中导入测试

---

**功能版本**: v1.0.0  
**完成时间**: 2025年10月21日  
**状态**: ✅ 已完成

