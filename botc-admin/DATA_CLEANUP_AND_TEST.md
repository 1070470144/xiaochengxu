# 🧹 数据清理 + 新方案测试指南

## ✅ 高RU消耗方案已修改完毕

### 修改内容总结
- [x] 图片不再转base64存数据库
- [x] 图片上传到云存储，获取URL
- [x] SVG上传到云存储，获取URL  
- [x] 数据库只存储URL（极少RU消耗）
- [x] 添加调试日志和备用首字母

---

## 🗑️ 数据清理步骤

### 步骤1：清理数据库中的大数据

```bash
1. 登录 uniCloud Web控制台
2. 进入「云数据库」
3. 打开 botc-scripts 集合
4. 查找今天创建的测试记录：
   - 按 created_at 排序
   - 找到今天的记录
5. 删除这些测试记录：
   - 点击记录右侧的「删除」按钮
   - 确认删除
```

### 步骤2：清理云存储文件（可选）

```bash
1. uniCloud控制台 → 云存储
2. 查看以下目录：
   - script-images/
   - role-images/
   - preview-images/
   - temp-scripts/
3. 删除今天创建的测试文件
```

---

## 🧪 新方案测试

### 测试前准备
```bash
1. 确认数据已清理
2. 上传云函数：
   右键 script-generate-preview → 上传部署
3. 检查云存储权限正常
```

### 测试步骤
```bash
1. 在管理后台添加剧本
2. 上传JSON文件
3. 点击保存
4. 查看HBuilderX日志：
   [云存储上传] 上传图片 1/15: 小恶魔
   [云存储上传] 上传成功: 小恶魔 → https://xxx.cdn.bspapp.com/...
   ...
   [预览图生成] 角色 小恶魔 图片URL: https://xxx.cdn.bspapp.com/...
   [预览图生成] URL类型: 云存储URL
```

### 验证结果
```bash
1. 查看RU消耗：
   uniCloud控制台 → 概览 → 今日RU使用量
   ✅ 应该增长很少（<500 RU）

2. 查看预览图：
   点击剧本「预览」按钮
   ✅ 应该看到角色头像

3. 查看云存储：
   云存储 → role-images/ 和 preview-images/
   ✅ 应该有新上传的文件
```

---

## 🔍 如果角色logo还是消失

### 可能原因
1. **云存储URL无法在SVG中加载**（CORS问题）
2. **图片上传失败**
3. **URL格式不正确**

### 调试方法
查看HBuilderX日志中的关键信息：
```
[预览图生成] 角色 xxx 图片URL: ???
[预览图生成] URL类型: ???
```

### 备用方案
如果云存储URL在SVG中无法加载，我会：
1. 改用首字母logo（临时）
2. 或者改用其他图片处理方案

---

## 📊 成功标准

### RU消耗
- ✅ 单次测试 < 500 RU
- ✅ 不再超限

### 功能完整性
- ✅ 预览图正常生成
- ✅ 角色logo正常显示
- ✅ 夜晚行动顺序完整

---

## 🎯 下一步

1. **先清理数据**（删除测试记录）
2. **上传云函数**
3. **小心测试**（观察RU消耗）
4. **查看日志**（确认URL类型）
5. **验证效果**

**请先清理数据库中的测试记录，然后我们测试新方案！** 🧹
