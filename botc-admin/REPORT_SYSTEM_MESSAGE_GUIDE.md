# 📨 举报处理系统消息功能

## ✅ 已完成功能

举报处理现在会自动发送系统消息给被举报用户！

---

## 🎯 功能说明

### 处理举报时的4种操作

| 操作 | 系统消息 | 其他操作 |
|------|---------|---------|
| **删除内容** | ✅ 发送"内容违规通知" | 删除被举报内容 |
| **警告用户** | ✅ 发送"违规警告" | 记录警告次数 |
| **封禁用户** | ✅ 发送"账号封禁通知" | 禁用用户账号 |
| **忽略举报** | ❌ 不发送消息 | 仅更新举报状态 |

---

## 📋 系统消息内容

### 1. 删除内容通知

**消息类型：** `warning`  
**标题：** 内容违规通知  
**内容：**
```
您发布的{内容类型}因违反社区规范已被删除。请遵守社区规则，文明发言。
```

**示例：**
```
您发布的帖子因违反社区规范已被删除。请遵守社区规则，文明发言。
```

### 2. 警告用户通知

**消息类型：** `warning`  
**标题：** 违规警告  
**内容：**
```
您发布的{内容类型}存在违规行为，已被管理员警告。请注意遵守社区规范，多次违规将被封禁账号。
```

**示例：**
```
您发布的帖子存在违规行为，已被管理员警告。请注意遵守社区规范，多次违规将被封禁账号。
```

**附加操作：**
- 用户表增加 `warning_count` 字段（警告次数+1）
- 记录 `last_warning_at` 最后警告时间

### 3. 封禁用户通知

**消息类型：** `warning`  
**标题：** 账号封禁通知  
**内容：**
```
您的账号因违反社区规范已被封禁。封禁原因：{管理员填写的原因}。如有疑问，请联系客服。
```

**示例：**
```
您的账号因违反社区规范已被封禁。封禁原因：多次发布违规内容。如有疑问，请联系客服。
```

**附加操作：**
- 用户状态改为禁用（`status: 1`）
- 记录封禁原因 `ban_reason`
- 记录封禁时间 `banned_at`

---

## 🔄 完整处理流程

```
用户举报内容
  ↓
管理员查看举报
  ↓
选择处理方式
  ↓
┌─────────────┬─────────────┬─────────────┬─────────────┐
│ 删除内容    │ 警告用户    │ 封禁用户    │ 忽略举报    │
├─────────────┼─────────────┼─────────────┼─────────────┤
│ 1.删除内容  │ 1.发送警告  │ 1.发送通知  │ 1.更新状态  │
│ 2.发送通知  │ 2.记录次数  │ 2.禁用账号  │             │
│             │             │ 3.记录原因  │             │
└─────────────┴─────────────┴─────────────┴─────────────┘
  ↓             ↓             ↓             ↓
用户收到系统消息（前3种）
  ↓
用户在"我的"-"系统消息"中查看
```

---

## 🚀 部署步骤

### 步骤1：上传云函数
```bash
右键：botc-admin/uniCloud-aliyun/cloudfunctions/reports-admin
→ 上传部署
→ 等待"上传成功"
```

### 步骤2：上传Schema（如果还没上传）
```bash
右键：botc-miniprogram/uniCloud-aliyun/database/botc-system-messages.schema.json
→ 上传DB Schema

右键：botc-admin/uniCloud-aliyun/database/botc-system-messages.schema.json
→ 上传DB Schema
```

### 步骤3：测试功能
```bash
1. 管理后台：进入"举报管理"
2. 找到一条待处理的举报
3. 点击"处理" → 选择"警告用户"
4. 填写处理备注 → 点击"确定"
5. 小程序：进入"我的" → "系统消息"
6. 验证：是否收到警告消息
```

---

## 📊 数据库变更

### botc-system-messages（系统消息表）

新增的消息记录示例：

```json
{
  "_id": "xxx",
  "user_id": "被警告用户ID",
  "type": "warning",
  "title": "违规警告",
  "content": "您发布的帖子存在违规行为...",
  "related_type": "post",
  "related_id": "帖子ID",
  "is_read": false,
  "created_at": 1730102400000
}
```

### uni-id-users（用户表）

新增字段（警告功能）：

```json
{
  "warning_count": 1,        // 警告次数
  "last_warning_at": 1730102400000  // 最后警告时间
}
```

新增字段（封禁功能）：

```json
{
  "status": 1,               // 1=禁用
  "ban_reason": "封禁原因",
  "banned_at": 1730102400000 // 封禁时间
}
```

---

## 🧪 测试场景

### 场景1：警告用户

```bash
1. 管理后台：举报管理 → 找到一条举报
2. 点击"处理"
3. 选择处理结果：警告用户
4. 填写处理备注："发布不当言论"
5. 点击"确定"
6. 小程序：登录被警告用户账号
7. 进入"我的" → "系统消息"
8. 验证：看到"违规警告"消息
```

### 场景2：删除内容

```bash
1. 管理后台：举报管理 → 找到一条举报
2. 点击"处理"
3. 选择处理结果：删除内容
4. 点击"确定"
5. 小程序：登录内容作者账号
6. 进入"我的" → "系统消息"
7. 验证：看到"内容违规通知"消息
8. 验证：原帖子已被删除
```

### 场景3：封禁用户

```bash
1. 管理后台：举报管理 → 找到一条举报
2. 点击"处理"
3. 选择处理结果：封禁用户
4. 填写处理备注："多次违规"
5. 点击"确定"
6. 小程序：登录被封禁用户账号
7. 进入"我的" → "系统消息"
8. 验证：看到"账号封禁通知"消息
9. 验证：用户无法发布新内容
```

---

## 💡 智能功能

### 1. 自动获取被举报用户ID

如果举报记录中没有 `reported_user_id`，系统会自动：
1. 根据 `content_type` 和 `content_id` 查询内容
2. 从内容中提取 `user_id`
3. 作为被举报用户ID使用

**支持的内容类型：**
- `post` → 查询 `botc-posts` 表
- `comment` → 查询 `botc-post-comments` 表
- `script` → 查询 `botc-scripts` 表
- `review` → 查询 `botc-script-reviews` 表

### 2. 删除内容时自动通知

删除内容时，系统会：
1. 先获取内容信息（包括作者ID）
2. 删除内容
3. 自动发送通知给内容作者

### 3. 警告次数统计

每次警告用户时，系统会：
1. `warning_count` 字段自动+1
2. 记录 `last_warning_at` 时间
3. 可用于后续的自动封禁规则

---

## 🔮 后续扩展建议

### 1. 自动封禁规则

```javascript
// 在警告用户时检查警告次数
if (user.warning_count >= 3) {
  // 3次警告自动封禁
  await banUser(userId, '累计3次警告，自动封禁')
}
```

### 2. 消息模板管理

在管理后台添加"消息模板"功能：
- 自定义不同违规类型的通知文案
- 支持变量替换（用户名、内容类型等）
- 多语言支持

### 3. 消息推送

除了系统消息，还可以：
- 发送微信模板消息
- 发送短信通知
- 发送邮件通知

### 4. 申诉功能

用户收到处罚后可以：
- 点击消息进入申诉页面
- 填写申诉理由
- 管理员审核申诉

---

## ⚠️ 注意事项

1. **消息发送失败**
   - 检查 `botc-system-messages` 表是否存在
   - 检查Schema是否上传
   - 查看云函数日志

2. **用户ID为空**
   - 确保举报时记录了 `reported_user_id`
   - 或确保内容表中有 `user_id` 字段

3. **消息不显示**
   - 检查小程序的系统消息页面查询条件
   - 确认 `user_id` 匹配
   - 检查 `is_read` 字段

4. **权限问题**
   - 确保Schema的 `create` 权限允许云函数写入
   - 当前配置：`"create": false`（只允许云函数创建）

---

## 📝 云函数日志

处理举报时，云函数会输出以下日志：

```
已警告用户 user_123
已发送系统消息给用户 user_123
```

```
已删除post: post_456
已发送系统消息给用户 user_789
```

```
已封禁用户：user_abc
已发送系统消息给用户 user_abc
```

可以在 uniCloud 控制台查看这些日志，确认功能正常执行。

---

**✅ 系统消息功能已完成！现在处理举报时会自动通知用户！** 🎉

**测试步骤：**
1. 上传 `reports-admin` 云函数
2. 上传 `botc-system-messages.schema.json`（两端）
3. 在管理后台处理一条举报
4. 在小程序查看系统消息

**如有问题，请查看云函数日志！** 🔧

