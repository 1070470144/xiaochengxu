# ☁️ 云存储方案 - 解决RU消耗问题

## 🎯 方案1实现：云存储架构

**问题根源**：将大量base64图片存储到数据库导致RU消耗巨大  
**解决方案**：图片存储到云存储，数据库只存储URL

---

## 📊 RU消耗对比

### 之前的错误架构 ❌
```
下载28张图片 → 转base64 → 存储到数据库
= 每张图片50-200KB base64存入数据库
= 大量数据库写入RU消耗
= 50,000+ RU ❌
```

### 现在的正确架构 ✅
```
下载图片 → 上传到云存储 → 获取URL → 存储URL到数据库
= 只存储URL字符串到数据库
= 极少的数据库写入RU消耗
= 100-500 RU ✅
```

---

## 🔄 新的工作流程

### 图片处理流程
```
外部图片URL (https://oss.gstonegames.com/...)
    ↓
云函数下载图片Buffer
    ↓
上传到uniCloud云存储 (role-images/xxx.png)
    ↓
获取云存储URL (https://xxx.cdn.bspapp.com/...)
    ↓
SVG中使用云存储URL
    ↓
SVG上传到云存储 (preview-images/xxx.svg)
    ↓
数据库存储SVG的云存储URL
```

### 数据库存储
```javascript
// 之前（错误）
{
  preview_image: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0..." // 巨大的base64
}

// 现在（正确）
{
  preview_image: "https://xxx.cdn.bspapp.com/cloudstorage/preview-images/xxx.svg" // 只是URL
}
```

---

## 💰 成本对比

### 数据库RU消耗
- **之前**：存储1.5MB base64 = 大量RU
- **现在**：存储100字节URL = 极少RU

### 云存储费用
- **存储费用**：前5GB免费，超出¥0.0045/GB/天
- **流量费用**：按下载量计费
- **预估成本**：28张图片约5MB，基本免费

### 总成本
- **RU消耗**：从50,000降到500以内 ✅
- **存储成本**：几乎免费 ✅
- **总体**：大幅降低成本 ✅

---

## 🧪 测试方案

### 测试前准备
```bash
1. 上传云函数：
   右键 script-generate-preview → 上传部署

2. 检查云存储权限：
   uniCloud控制台 → 云存储 → 确认读写权限正常
```

### 测试步骤
```bash
1. 在管理后台添加剧本
2. 上传JSON文件
3. 点击保存
4. 查看HBuilderX日志：
   [云存储上传] 上传图片 1/15: 小恶魔
   [云存储上传] 上传成功: 小恶魔 → https://xxx.cdn.bspapp.com/...
   ...
   [云存储上传] 完成，上传了 15 张图片到云存储
```

### 验证结果
```bash
1. 查看云存储：
   uniCloud控制台 → 云存储
   应该看到：
   - role-images/ 目录（角色图片）
   - preview-images/ 目录（SVG预览图）

2. 查看数据库：
   preview_image 字段应该是云存储URL，不是base64

3. 查看预览图：
   点击预览，应该显示完整的SVG，包含角色头像
```

---

## 📊 优势总结

### RU消耗优化
- **数据库写入**：从MB级降到KB级
- **RU消耗**：从50,000+降到500以内
- **可持续性**：不会再超限

### 功能完整性
- ✅ 所有角色显示真实头像
- ✅ 夜晚行动顺序完整
- ✅ 28px大尺寸logo
- ✅ 永久有效的云存储URL

### 架构合理性
- ✅ 图片存储在云存储（专业）
- ✅ 数据库只存URL（轻量）
- ✅ 符合最佳实践

---

## ⚠️ 注意事项

### 云存储权限
确保云存储设置为：
- **读权限**：公开（所有人可读）
- **写权限**：仅云函数

### 文件管理
- 角色图片：`role-images/` 目录
- 预览图SVG：`preview-images/` 目录
- 自动命名：时间戳+随机字符

---

**现在上传云函数测试！** RU消耗应该大幅降低 📉✅
