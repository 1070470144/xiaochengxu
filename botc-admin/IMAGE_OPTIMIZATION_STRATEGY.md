# 🖼️ 图片显示优化策略

## 🎯 问题解决

**问题**：28张图片转base64导致请求过大（413错误）

**解决方案**：限制转换数量 + 混合显示

---

## 🔧 优化策略

### 方案：前10张显示图片，其余显示精美首字母

```javascript
// 转换策略
const maxConvert = 10  // 最多转换10张图片

For 每个角色:
  if (有图片 && 转换数量 < 10) {
    下载图片 → 转base64 → 显示真实头像
  } else {
    显示精美首字母logo
  }
```

### 显示效果
- **前10个角色**：真实头像（圆形裁剪）
- **其余角色**：精美首字母（三层圆圈 + 阴影）
- **夜晚行动顺序**：根据是否有base64图片决定

---

## 🎨 精美首字母设计

### 三层圆圈设计
```svg
<!-- 外层白色背景 -->
<circle r="16" fill="white" opacity="0.95"/>

<!-- 中层队伍颜色 -->
<circle r="14" fill="队伍颜色" opacity="0.9"/>

<!-- 内层深色 -->
<circle r="12" fill="队伍颜色" opacity="0.7"/>

<!-- 白色首字母 + 阴影 -->
<text font-size="16" fill="white" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5)">
```

### 队伍颜色
- 镇民：绿色 (#10b981)
- 外来者：黄色 (#eab308)
- 爪牙：橙色 (#f97316)
- 恶魔：红色 (#ef4444)
- 旅行者：紫色 (#8b5cf6)

---

## 📊 数据量对比

### 优化前（全部转换）
- 28张图片 × 平均50KB = 1.4MB
- 转base64后 ≈ 1.9MB
- 超过云函数限制 ❌

### 优化后（限制10张）
- 10张图片 × 平均50KB = 500KB
- 转base64后 ≈ 700KB
- 在限制范围内 ✅

---

## 🧪 测试步骤

### 1. 上传云函数
```bash
右键：script-generate-preview → 上传部署
```

### 2. 重新生成预览图
```bash
在管理后台重新保存剧本
```

### 3. 查看HBuilderX日志
应该看到：
```
[图片预处理] 转换图片 1/10: 洗衣妇
[图片预处理] 转换成功: 洗衣妇
...
[图片预处理] 转换图片 10/10: 士兵
[图片预处理] 完成，转换了 10 张图片
[夜晚行动] 首夜角色数: X, 其他夜晚: Y
```

### 4. 查看预览图
应该看到：
- ✅ 前10个角色：真实头像
- ✅ 其余角色：精美首字母
- ✅ 夜晚行动顺序：左右两侧
- ✅ Logo尺寸：28px（放大了）

---

## 💡 进一步优化（可选）

### 如果还想显示更多图片：
1. **提高转换数量**：maxConvert = 15
2. **压缩图片**：下载时压缩尺寸
3. **选择性转换**：优先转换重要角色（镇民、恶魔）

### 如果仍然过大：
1. **降低图片质量**：压缩base64
2. **减少转换数量**：maxConvert = 5
3. **异步生成**：先保存剧本，后台生成图片

---

## ✅ 当前方案优势

- ✅ **避免413错误**：控制数据量
- ✅ **显示真实图片**：前10个角色
- ✅ **美观降级**：其余角色用精美首字母
- ✅ **完整功能**：包含夜晚行动顺序
- ✅ **性能可控**：生成时间合理

---

**现在上传云函数测试！** 应该能看到前10个角色的真实头像了 🎉
