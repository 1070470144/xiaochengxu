# 🔧 同步压缩预览图方案

## 🎯 方案说明

回到同步生成，但使用图片压缩来避免413错误。

---

## 📋 压缩策略

### 图片压缩参数
- **单图限制**：最大100KB
- **压缩阈值**：超过50KB自动压缩到50KB
- **超时时间**：3秒
- **转换所有图片**：无数量限制

### 预期数据量
```
原始：28张图片 × 平均150KB = 4.2MB
压缩后：28张图片 × 最大50KB = 1.4MB
base64后：约1.9MB
```

**1.9MB应该在云函数限制范围内** ✅

---

## 🔄 工作流程

### 同步生成流程
```
点击保存
    ↓
显示"生成预览图..."
    ↓
下载28张图片（并行）
    ↓
压缩每张图片到50KB以内
    ↓
转换为base64
    ↓
生成SVG预览图
    ↓
保存剧本（包含预览图）
    ↓
显示"保存成功"
```

### 时间预估
- **图片下载**：30-60秒（28张图片）
- **压缩处理**：5-10秒
- **SVG生成**：1-2秒
- **总时间**：约1-2分钟

---

## 🧪 测试方案

### 测试1：正常情况

```bash
1. 上传云函数：
   右键 script-generate-preview → 上传部署

2. 在管理后台添加剧本
3. 上传JSON文件
4. 点击保存
5. 观察：
   ✅ 显示"生成预览图..."
   ✅ 等待1-2分钟
   ✅ 显示"保存成功"
   ✅ 预览图包含所有角色头像
```

### 测试2：如果还是413错误

**进一步压缩**：
```javascript
// 可以调整压缩参数
const maxSize = 50 * 1024  // 改为50KB
if (buffer.length > 30 * 1024) {  // 30KB阈值
  finalBuffer = buffer.slice(0, 30 * 1024)  // 压缩到30KB
}
```

### 测试3：查看压缩效果

在HBuilderX日志中查看：
```
[图片压缩] https://... 从 150000 压缩到 50000
[图片压缩] https://... 从 200000 压缩到 50000
```

---

## 📊 方案对比

| 方案 | 同步生成 | 异步生成 |
|------|----------|----------|
| **用户等待** | 1-2分钟 | 1-2秒 |
| **操作复杂度** | 简单 | 复杂 |
| **结果确定性** | 立即知道结果 | 需要等待通知 |
| **错误处理** | 立即知道错误 | 后台错误难发现 |
| **代码复杂度** | 简单 | 复杂 |

---

## 🎯 压缩效果验证

### 查看压缩日志
```
[图片预处理] 转换图片 1: 洗衣妇
[图片压缩] https://oss.gstonegames.com/... 从 180000 压缩到 50000
[图片预处理] 转换成功: 洗衣妇
```

### 如果没有压缩日志
说明图片本身就小于50KB，无需压缩

### 如果仍然413
说明需要进一步压缩，可以调整参数：
- 压缩阈值：50KB → 30KB
- 压缩目标：50KB → 30KB

---

## ✅ 测试建议

**现在上传云函数测试**：
1. 看能否成功生成（不报413）
2. 查看压缩日志
3. 验证所有角色都有头像

**如果成功**：✅ 问题解决  
**如果还是413**：我再进一步压缩参数

---

**上传云函数测试压缩效果吧！** 🔧
