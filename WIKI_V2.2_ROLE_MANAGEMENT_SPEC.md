# 血染百科 v2.2 - 角色管理系统完整方案

## 🎯 核心功能

### 1. 角色名称管理
- ✅ 批量添加角色名称
- ✅ 保存到数据库
- ✅ 显示角色列表
- ✅ 删除单个角色
- ✅ 一键同步所有角色

### 2. 搜索功能 🆕
- ✅ 按角色名称搜索
- ✅ 按同步状态筛选
- ✅ 实时搜索

### 3. 简化功能
- ❌ 删除"同步所有内容"
- ❌ 删除"仅同步剧本"  
- ❌ 删除"仅同步规则"
- ✅ 专注于角色同步

---

## 💾 数据库设计

### wiki_role_list（角色列表）

```javascript
{
  _id: String,
  role_name: String,          // 角色名称
  role_url: String,           // URL（自动生成）
  entry_type: String,         // 角色类型：镇民/外来者/爪牙/恶魔
  script_name: String,        // 所属剧本
  is_synced: Boolean,         // 是否已同步
  last_sync_time: Date,       // 最后同步时间
  sync_status: String,        // success/failed/pending
  sync_error: String,         // 同步错误信息
  sort_order: Number,         // 排序
  created_by: String,         // 添加人
  created_at: Date,
  updated_at: Date
}
```

---

## 📱 界面设计

### 百科同步页面（完整版）

```
┌──────────────────────────────────────────────────┐
│  📚 角色管理                                     │
├──────────────────────────────────────────────────┤
│                                                   │
│  🔍 搜索角色                                      │
│  ┌────────────────┬────────────┬──────────────┐ │
│  │ [🔍 搜索名称.. ]│ [▼ 同步状态]│ [▼ 所属剧本] │ │
│  └────────────────┴────────────┴──────────────┘ │
│                                                   │
│  ────────────────────────────────────────────   │
│                                                   │
│  📝 批量添加角色                                  │
│  ┌──────────────────────────────────────────┐  │
│  │ 哲学家                                    │  │
│  │ 送茶侍者                                  │  │
│  │ 祖母                                      │  │
│  └──────────────────────────────────────────┘  │
│                                                   │
│  剧本分类：[▼ 黯月初升  ]                       │
│                                                   │
│  [ 添加到列表 ]  [ 清空输入 ]                   │
│                                                   │
│  ────────────────────────────────────────────   │
│                                                   │
│  📋 角色列表（共45个，已同步24个，未同步21个）   │
│                                                   │
│  [ 同步所有未同步角色 ] [ 重新同步全部 ]         │
│  [ 导出列表 ] [ 导入列表 ]                       │
│                                                   │
│  ┌──────────────────────────────────────────┐  │
│  │ ✓ 洗衣妇     镇民  暗流涌动  [详情][删除] │  │
│  │   2025-10-18 14:00                        │  │
│  │                                            │  │
│  │ ✓ 图书管理员 镇民  暗流涌动  [详情][删除] │  │
│  │   2025-10-18 14:15                        │  │
│  │                                            │  │
│  │ ○ 哲学家     镇民  黯月初升  [同步][删除] │  │
│  │   未同步                                   │  │
│  │                                            │  │
│  │ ✗ 送茶侍者   镇民  黯月初升  [重试][删除] │  │
│  │   同步失败：网络超时                      │  │
│  └──────────────────────────────────────────┘  │
└──────────────────────────────────────────────────┘
```

---

## 🔍 搜索功能

### 搜索条件

```javascript
// 按名称搜索
searchKeyword: '洗衣妇'

// 按状态筛选
syncStatus: 'synced'      // 已同步
syncStatus: 'pending'     // 未同步
syncStatus: 'failed'      // 失败
syncStatus: 'all'         // 全部

// 按剧本筛选
scriptName: '暗流涌动'
scriptName: '黯月初升'
scriptName: '梦殒春宵'
scriptName: 'all'         // 全部
```

### 实时搜索

```javascript
watch: {
  searchKeyword(val) {
    this.filterRoles();
  },
  syncStatus(val) {
    this.filterRoles();
  },
  scriptName(val) {
    this.filterRoles();
  }
},

methods: {
  filterRoles() {
    // 从数据库查询并筛选
  }
}
```

---

## 📦 导入/导出功能 🆕

### 导出角色列表

```javascript
// 导出为JSON
async exportRoles() {
  const roles = await this.getAllRoles();
  const data = roles.map(r => ({
    name: r.role_name,
    script: r.script_name,
    type: r.entry_type
  }));
  
  // 下载JSON文件
  downloadJSON(data, '角色列表.json');
}
```

### 导入角色列表

```javascript
// 从JSON导入
async importRoles(file) {
  const data = JSON.parse(file);
  
  for (const role of data) {
    await this.addRole(role.name, role.script, role.type);
  }
  
  this.loadRoleList();
}
```

---

## 🔧 开发任务清单

### 数据库（1个集合）
1. ✅ 创建 wiki_role_list 集合

### 云函数（5个）
2. ✅ wiki-role-add：添加角色
3. ✅ wiki-role-list：获取列表（支持搜索）
4. ✅ wiki-role-delete：删除角色
5. ✅ wiki-role-sync-all：同步所有
6. ✅ wiki-role-sync-one：同步单个

### 前端页面（1个）
7. ✅ 优化 sync.vue：
   - 删除剧本/规则同步
   - 添加角色管理区域
   - 添加搜索功能
   - 添加角色列表展示
   - 添加导入/导出

---

## ⏱️ 开发时间

- **数据库设计**：0.5小时
- **云函数开发**：2小时
- **前端界面**：3小时
- **搜索功能**：1小时
- **导入导出**：1小时
- **测试优化**：1小时

**总计：8.5小时（约1天）**

---

## 🎊 最终效果

### 使用流程

```
1. 添加角色
   输入：哲学家、送茶侍者、祖母
   点击"添加到列表"
   → 保存到数据库

2. 查看列表
   搜索：哲
   → 显示：哲学家
   
3. 同步
   点击"同步所有未同步角色"
   → 自动同步3个新角色
   
4. 管理
   搜索、删除、重新同步
```

---

## 📊 功能对比

| 功能 | v2.1 | v2.2 |
|------|------|------|
| 添加角色 | ❌ 需要URL | ✅ 只需名称 |
| 保存角色 | ❌ 不保存 | ✅ 永久保存 |
| 搜索角色 | ❌ 无 | ✅ 实时搜索 |
| 批量管理 | ⚠️ 有限 | ✅ 完整 |
| 导入导出 | ❌ 无 | ✅ 支持 |

---

## 🚀 确认开发？

回复 **/implement** 我将开始开发 v2.2 角色管理系统！

---

**版本**: v2.2.0  
**功能**: 角色名称管理+搜索系统  
**开发时间**: 约1天（8.5小时）

