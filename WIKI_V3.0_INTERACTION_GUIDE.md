# Wiki v3.0 角色互动功能 - 部署指南

## 📋 版本信息
- **版本**: v3.0
- **更新日期**: 2025-10-18
- **功能**: 角色点赞和评论

---

## 🎯 新增功能

### 1. 角色点赞
- ✅ 用户可以点赞角色
- ✅ 点赞后可取消
- ✅ 实时显示点赞数量
- ✅ 点赞状态持久化

### 2. 角色评论
- ✅ 用户可以发表评论
- ✅ 显示评论列表
- ✅ 显示用户头像和昵称
- ✅ 智能时间显示（刚刚/N分钟前/N小时前）

### 3. 统计展示
- ✅ 浏览量 👁️
- ✅ 点赞数 ❤️
- ✅ 评论数 💬
- ✅ 收藏数 ⭐

---

## 📦 文件清单

### 数据库Schema（3个）
```
botc-miniprogram/uniCloud-aliyun/database/
├── wiki_entries.schema.json        # 扩展（添加like_count, comment_count）
├── wiki_role_likes.schema.json     # 新增（点赞记录）
└── wiki_role_comments.schema.json  # 新增（评论记录）
```

### 云函数（3个）
```
botc-miniprogram/uniCloud-aliyun/cloudfunctions/
├── wiki-role-toggle-like/          # 点赞/取消点赞
│   ├── index.js
│   └── package.json
├── wiki-role-comment-add/          # 发表评论
│   ├── index.js
│   └── package.json
└── wiki-role-comment-list/         # 评论列表
    ├── index.js
    └── package.json
```

### 前端页面（1个）
```
botc-miniprogram/pages/tools/wiki/
└── detail.vue                      # 扩展（添加互动区域）
```

---

## 🚀 部署步骤

### 步骤1: 上传数据库Schema（2分钟）

```bash
# 上传3个Schema
右键 wiki_entries.schema.json → 上传Schema
右键 wiki_role_likes.schema.json → 上传Schema  
右键 wiki_role_comments.schema.json → 上传Schema
```

**验证**：
- uniCloud控制台 → 数据库
- 确认3个集合都已创建/更新

---

### 步骤2: 上传云函数（3分钟）

```bash
# 依次上传3个云函数
右键 wiki-role-toggle-like → 上传部署
右键 wiki-role-comment-add → 上传部署
右键 wiki-role-comment-list → 上传部署
```

**验证**：
- uniCloud控制台 → 云函数
- 确认3个云函数显示"已部署"

---

### 步骤3: 运行小程序（1分钟）

```bash
运行 → 运行到小程序模拟器
或
运行 → 运行到手机/预览
```

---

## ✅ 功能测试

### 测试1: 查看统计信息
1. 打开任意角色详情页
2. 查看顶部统计栏

**应该显示**：
```
👁️ 12  ❤️ 3  💬 5  ⭐ 2
```

---

### 测试2: 点赞功能
1. 点击"🤍 点赞"按钮
2. 应该变为"❤️ 已点赞"
3. 点赞数+1
4. 再次点击取消点赞

**预期效果**：
- ✅ 按钮颜色从黄色变为红色
- ✅ 文字从"点赞"变为"已点赞"
- ✅ 点赞数实时更新

---

### 测试3: 评论功能
1. 在评论输入框输入："这个角色很强"
2. 点击"发送"按钮
3. 评论列表应该显示新评论

**预期效果**：
- ✅ 显示用户头像和昵称
- ✅ 显示评论内容
- ✅ 显示"刚刚"时间
- ✅ 评论数+1

---

## 📐 界面展示

### 角色详情页（完整）

```
┌─────────────────────────────────┐
│ [图标] 图书管理员   [镇民]       │
├─────────────────────────────────┤
│ ... 角色详细信息 ...            │
├─────────────────────────────────┤
│ 👁️ 123  ❤️ 45  💬 12  ⭐ 8     │  ← 统计栏
├─────────────────────────────────┤
│ [🤍 点赞]                        │  ← 点赞按钮
├─────────────────────────────────┤
│ 💬 评论 (12)                     │  ← 评论区
│ ┌───────────────────────────┐  │
│ │ [👤] 张三  2小时前         │  │
│ │ 这个角色很强，适合新手      │  │
│ └───────────────────────────┘  │
│ ┌───────────────────────────┐  │
│ │ [👤] 李四  5小时前         │  │
│ │ 配合哲学家效果更好          │  │
│ └───────────────────────────┘  │
│                                 │
│ [说说你的看法...]  [发送]       │  ← 评论输入
├─────────────────────────────────┤
│ [🌐 跳转百科地址]                │
└─────────────────────────────────┘
```

---

## 🎨 设计亮点

### 1. 统计栏
- 4个统计指标横向排列
- 图标+数字，简洁直观
- 白色卡片，圆角阴影

### 2. 点赞按钮
- **未点赞**: 黄色渐变 + 🤍
- **已点赞**: 红色渐变 + ❤️
- 全宽大按钮，点击动画

### 3. 评论列表
- 头像 + 昵称 + 时间
- 评论内容自动换行
- 智能时间显示

### 4. 评论输入
- 圆角输入框 + 发送按钮
- 输入为空时禁用发送
- 浅灰背景，区分明显

---

## 🔐 权限说明

### wiki_role_likes
```json
{
  "read": "auth.uid == doc.user_id",  // 只能查看自己的点赞
  "create": "auth.uid != null",       // 登录用户可点赞
  "delete": "auth.uid == doc.user_id" // 只能删除自己的点赞
}
```

### wiki_role_comments
```json
{
  "read": true,                       // 所有人可查看评论
  "create": "auth.uid != null",       // 登录用户可评论
  "update": "auth.uid == doc.user_id",// 只能修改自己的评论
  "delete": "auth.uid == doc.user_id" // 只能删除自己的评论
}
```

---

## 💡 使用说明

### 用户角度

#### 查看角色
1. 打开小程序 → 工具 → 血染百科
2. 点击任意角色
3. 查看详情和统计

#### 点赞角色（需登录）
1. 点击"🤍 点赞"按钮
2. 按钮变为"❤️ 已点赞"
3. 点赞数+1

#### 发表评论（需登录）
1. 在评论输入框输入内容
2. 点击"发送"
3. 评论立即显示在列表中

#### 查看百科
1. 点击底部"🌐 跳转百科地址"
2. 地址自动复制到剪贴板
3. 在浏览器中粘贴打开

---

## 🐛 常见问题

### Q1: 点赞后刷新页面，状态丢失？
**A**: 不会。点赞状态存储在数据库中，刷新后会重新检查。

### Q2: 未登录能看评论吗？
**A**: 可以。评论列表所有人可见，但发表评论需要登录。

### Q3: 评论能删除吗？
**A**: 可以。用户可以删除自己的评论（功能待开发）。

### Q4: 点赞数会实时更新吗？
**A**: 会。点赞后立即更新本地数据和数据库。

---

## 📊 数据流程

### 点赞流程
```
用户点击"点赞" 
  → 调用 wiki-role-toggle-like
  → 检查是否已点赞
  → 插入/删除 wiki_role_likes 记录
  → 更新 wiki_entries.stats.like_count
  → 返回新状态
  → 更新按钮显示
```

### 评论流程
```
用户输入评论内容
  → 点击"发送"
  → 调用 wiki-role-comment-add
  → 获取用户信息
  → 插入 wiki_role_comments
  → 更新 wiki_entries.stats.comment_count
  → 重新加载评论列表
  → 显示新评论
```

---

## 🎊 完成！

角色互动功能开发完成，包括：
- ✅ 3个数据库Schema
- ✅ 3个云函数
- ✅ 完整的前端交互
- ✅ 美观的界面设计

**预计部署时间**: 6分钟  
**开发时间**: 2小时

现在可以部署测试了！🚀

