# è¡€æŸ“ç™¾ç§‘ - ç½‘é¡µæŠ“å–è§£æåŠŸèƒ½å‡çº§æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®èƒŒæ™¯

### ç°çŠ¶åˆ†æ
å½“å‰ `pages/tools/wiki/wiki.vue` é¡µé¢ä½¿ç”¨**é™æ€æ•°æ®**å±•ç¤ºç™¾ç§‘å†…å®¹ï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
- âœ… æ•°æ®å†™æ­»åœ¨ä»£ç ä¸­ï¼Œæ›´æ–°å›°éš¾
- âœ… å†…å®¹æœ‰é™ï¼Œæ— æ³•è¦†ç›–æ‰€æœ‰è§’è‰²å’Œè§„åˆ™
- âœ… æ— æ³•åŒæ­¥å®˜æ–¹æœ€æ–°ä¿¡æ¯
- âœ… ç»´æŠ¤æˆæœ¬é«˜

### å‡çº§ç›®æ ‡
é€šè¿‡**ç½‘é¡µæŠ“å–è§£ææŠ€æœ¯**ï¼Œå®ç°ï¼š
- ğŸ¯ è‡ªåŠ¨åŒæ­¥å®˜æ–¹ç™¾ç§‘å†…å®¹
- ğŸ¯ å†…å®¹ä¸°å¯Œä¸”å®æ—¶æ›´æ–°
- ğŸ¯ é™ä½äººå·¥ç»´æŠ¤æˆæœ¬
- ğŸ¯ æä¾›æ›´å®Œæ•´çš„ç™¾ç§‘ä½“éªŒ

---

## ğŸ¨ æŠ€æœ¯æ–¹æ¡ˆè¯„ä¼°

### æ–¹æ¡ˆå¯¹æ¯”

#### âŒ æ–¹æ¡ˆAï¼šå°ç¨‹åºç«¯ç›´æ¥æŠ“å–ï¼ˆä¸å¯è¡Œï¼‰
```
å°ç¨‹åº â†’ ç™¾ç§‘ç½‘ç«™ â†’ è§£æHTML â†’ å±•ç¤º
```
**ä¸å¯è¡ŒåŸå› ï¼š**
1. å¾®ä¿¡å°ç¨‹åºå¯¹ç¬¬ä¸‰æ–¹ç½‘ç»œè¯·æ±‚æœ‰**ä¸¥æ ¼é™åˆ¶**
2. å¿…é¡»é…ç½®**æœåŠ¡å™¨åŸŸåç™½åå•**
3. å¤§å¤šæ•°ç™¾ç§‘ç½‘ç«™**ä¸åœ¨ç™½åå•**ä¸­
4. æ— æ³•å¤„ç†è·¨åŸŸé—®é¢˜

#### âœ… æ–¹æ¡ˆBï¼šäº‘å‡½æ•°åç«¯æŠ“å–ï¼ˆæ¨èï¼‰
```
å°ç¨‹åº â†’ uniCloudäº‘å‡½æ•° â†’ æŠ“å–ç™¾ç§‘ç½‘ç«™ â†’ è§£æHTML â†’ è¿”å›æ•°æ® â†’ å°ç¨‹åºå±•ç¤º
```
**ä¼˜ç‚¹ï¼š**
1. âœ… äº‘å‡½æ•°æ— è·¨åŸŸé™åˆ¶
2. âœ… å¯ä»¥ç¼“å­˜å†…å®¹ï¼Œæå‡æ€§èƒ½
3. âœ… ç»Ÿä¸€ç®¡ç†ï¼Œä¾¿äºç»´æŠ¤
4. âœ… å¯ä»¥åšå†…å®¹å®¡æ ¸å’Œä¼˜åŒ–
5. âœ… ç¬¦åˆå°ç¨‹åºå®‰å…¨è§„èŒƒ

#### âš ï¸ æ–¹æ¡ˆCï¼šå®šæ—¶çˆ¬è™« + æ•°æ®åº“å­˜å‚¨ï¼ˆå¤‡é€‰ï¼‰
```
å®šæ—¶ä»»åŠ¡ â†’ çˆ¬å–ç™¾ç§‘ â†’ å­˜å‚¨åˆ°æ•°æ®åº“ â†’ å°ç¨‹åºè¯»å–æ•°æ®åº“
```
**ä¼˜ç‚¹ï¼š**
- å“åº”é€Ÿåº¦æœ€å¿«
- ç¦»çº¿å¯ç”¨
- æˆæœ¬å¯æ§

**ç¼ºç‚¹ï¼š**
- éœ€è¦é¢å¤–çš„çˆ¬è™«æœåŠ¡
- å†…å®¹æ›´æ–°æœ‰å»¶è¿Ÿ
- éœ€è¦æ›´å¤šå­˜å‚¨ç©ºé—´

### ğŸ“Œ æœ€ç»ˆé€‰æ‹©ï¼šæ–¹æ¡ˆB + æ–¹æ¡ˆC æ··åˆ
- **é¦–æ¬¡è®¿é—®/æ‰‹åŠ¨åˆ·æ–°**ï¼šäº‘å‡½æ•°å®æ—¶æŠ“å–
- **äºŒæ¬¡è®¿é—®**ï¼šè¯»å–ç¼“å­˜æ•°æ®
- **å®šæœŸåå°ä»»åŠ¡**ï¼šæ›´æ–°çƒ­é—¨è¯æ¡åˆ°æ•°æ®åº“

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å°ç¨‹åºç«¯                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  ç™¾ç§‘é¦–é¡µ     â”‚  â”‚  è¯æ¡æœç´¢    â”‚  â”‚  è¯æ¡è¯¦æƒ…    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚         â”‚                  â”‚                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ uniCloud SDK è°ƒç”¨
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  uniCloud äº‘æœåŠ¡                     â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           äº‘å‡½æ•°å±‚                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚ wiki-parse   â”‚  â”‚ wiki-search  â”‚       â”‚   â”‚
â”‚  â”‚  â”‚  URLè§£æ     â”‚  â”‚  æœç´¢è¯æ¡    â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â”‚         â”‚                  â”‚                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚     HTML è§£æå¼•æ“ï¼ˆcheerioï¼‰     â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          ç¼“å­˜å±‚ï¼ˆäº‘æ•°æ®åº“ï¼‰                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚ wiki_entries â”‚  â”‚ wiki_cache   â”‚       â”‚   â”‚
â”‚  â”‚  â”‚  è¯æ¡æ•°æ®    â”‚  â”‚  æŠ“å–ç¼“å­˜    â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          å®šæ—¶ä»»åŠ¡                            â”‚   â”‚
â”‚  â”‚  æ¯å¤©å‡Œæ™¨2ç‚¹ï¼šæ›´æ–°çƒ­é—¨è¯æ¡                   â”‚   â”‚
â”‚  â”‚  æ¯å‘¨ä¸€æ¬¡ï¼šå…¨é‡åŒæ­¥                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTP è¯·æ±‚
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç›®æ ‡ç™¾ç§‘ç½‘ç«™                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ å®˜æ–¹Wiki     â”‚  â”‚ ç¤¾åŒºWiki     â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ”¯æŒçš„ç™¾ç§‘æ¥æº
1. **Blood on the Clocktower å®˜æ–¹Wiki**
   - URL: `https://wiki.bloodontheclocktower.com/`
   - ç‰¹ç‚¹ï¼šæœ€æƒå¨ï¼Œè‹±æ–‡ä¸ºä¸»

2. **è¡€æŸ“é’Ÿæ¥¼ä¸­æ–‡Wiki**
   - URL: `https://botc.wiki/`
   - ç‰¹ç‚¹ï¼šä¸­æ–‡ç¿»è¯‘ï¼Œé€‚åˆå›½å†…ç©å®¶

3. **ç¤¾åŒºç™¾ç§‘**
   - å„ç±»ç©å®¶ç»´æŠ¤çš„ç™¾ç§‘ç«™ç‚¹

---

## ğŸ’¾ æ•°æ®åº“è®¾è®¡

### è¡¨1: wiki_entries (ç™¾ç§‘è¯æ¡è¡¨)
```javascript
// MongoDB Schema
{
  _id: ObjectId,
  
  // åŸºæœ¬ä¿¡æ¯
  entry_type: String,      // è¯æ¡ç±»å‹: role, script, rule, term
  title: String,           // æ ‡é¢˜
  title_en: String,        // è‹±æ–‡æ ‡é¢˜
  title_zh: String,        // ä¸­æ–‡æ ‡é¢˜
  
  // æ¥æºä¿¡æ¯
  source_url: String,      // æ¥æºURL
  source_type: String,     // æ¥æºç±»å‹: official_wiki, community_wiki
  source_site: String,     // æ¥æºç«™ç‚¹åç§°
  
  // å†…å®¹æ•°æ®
  content: {
    text: String,          // çº¯æ–‡æœ¬å†…å®¹
    html: String,          // HTMLæ ¼å¼å†…å®¹ï¼ˆç²¾ç®€åï¼‰
    sections: [            // åˆ†æ®µå†…å®¹
      {
        heading: String,   // å°æ ‡é¢˜
        content: String,   // æ®µè½å†…å®¹
        level: Number      // æ ‡é¢˜å±‚çº§ (h2=2, h3=3)
      }
    ],
    summary: String        // æ‘˜è¦ï¼ˆå‰200å­—ï¼‰
  },
  
  // è§’è‰²ä¸“å±å­—æ®µ (entry_type === 'role')
  role_info: {
    team: String,          // é˜µè¥: townsfolk, outsider, minion, demon
    team_name_zh: String,  // é˜µè¥ä¸­æ–‡å
    ability: String,       // èƒ½åŠ›æè¿°
    ability_type: String,  // èƒ½åŠ›ç±»å‹: passive, active, setup
    script_belongs: [String], // æ‰€å±å‰§æœ¬åˆ—è¡¨
    is_jinx: Boolean,      // æ˜¯å¦æœ‰ç¦å¿Œ
    jinx_with: [String]    // ç¦å¿Œè§’è‰²åˆ—è¡¨
  },
  
  // åª’ä½“èµ„æº
  media: {
    icon_url: String,      // å›¾æ ‡URL
    images: [String],      // ç›¸å…³å›¾ç‰‡URLæ•°ç»„
    video_url: String      // è§†é¢‘æ•™ç¨‹URL
  },
  
  // æ‰©å±•ä¿¡æ¯
  tags: [String],          // æ ‡ç­¾
  keywords: [String],      // æœç´¢å…³é”®è¯
  related_entries: [String], // ç›¸å…³è¯æ¡ID
  
  // ç»Ÿè®¡æ•°æ®
  stats: {
    view_count: Number,    // æŸ¥çœ‹æ¬¡æ•°
    search_count: Number,  // æœç´¢æ¬¡æ•°
    favorite_count: Number // æ”¶è—æ¬¡æ•°
  },
  
  // çŠ¶æ€ç®¡ç†
  status: Number,          // 0-è‰ç¨¿, 1-å·²å‘å¸ƒ, 2-å·²ä¸‹æ¶
  quality_score: Number,   // å†…å®¹è´¨é‡åˆ†æ•° (0-100)
  
  // ç¼“å­˜ç®¡ç†
  cache_expires_at: Date,  // ç¼“å­˜è¿‡æœŸæ—¶é—´
  last_fetched_at: Date,   // æœ€åæŠ“å–æ—¶é—´
  fetch_count: Number,     // æŠ“å–æ¬¡æ•°
  
  // æ—¶é—´æˆ³
  created_at: Date,
  updated_at: Date
}
```

### è¡¨2: wiki_search_history (æœç´¢å†å²)
```javascript
{
  _id: ObjectId,
  user_id: String,         // ç”¨æˆ·ID
  keyword: String,         // æœç´¢å…³é”®è¯
  result_count: Number,    // ç»“æœæ•°é‡
  clicked_entry_id: String, // ç‚¹å‡»çš„è¯æ¡ID
  created_at: Date
}
```

### è¡¨3: wiki_favorites (ç”¨æˆ·æ”¶è—)
```javascript
{
  _id: ObjectId,
  user_id: String,         // ç”¨æˆ·ID
  entry_id: String,        // è¯æ¡ID
  notes: String,           // ç”¨æˆ·å¤‡æ³¨
  created_at: Date
}
```

---

## â˜ï¸ äº‘å‡½æ•°å®ç°

### äº‘å‡½æ•°1: wiki-parse-url

#### åŠŸèƒ½æè¿°
æ¥æ”¶ä¸€ä¸ªç™¾ç§‘URLï¼ŒæŠ“å–å¹¶è§£æç½‘é¡µå†…å®¹ï¼Œè¿”å›ç»“æ„åŒ–æ•°æ®ã€‚

#### å®Œæ•´ä»£ç å®ç°
```javascript
// uniCloud-aliyun/cloudfunctions/wiki-parse-url/index.js

'use strict';

const cheerio = require('cheerio');
const got = require('got'); // æ¨èä½¿ç”¨ got æ›¿ä»£ axios

exports.main = async (event, context) => {
  const { url, force_refresh = false } = event;
  
  console.log('[wiki-parse-url] å¼€å§‹è§£æ:', url);
  
  // 1. å‚æ•°éªŒè¯
  if (!url) {
    return {
      code: 400,
      message: 'ç¼ºå°‘URLå‚æ•°'
    };
  }
  
  // éªŒè¯URLæ˜¯å¦ä¸ºæ”¯æŒçš„ç™¾ç§‘ç«™ç‚¹
  const validationResult = validateUrl(url);
  if (!validationResult.valid) {
    return {
      code: 400,
      message: validationResult.message
    };
  }
  
  const db = uniCloud.database();
  
  // 2. æ£€æŸ¥ç¼“å­˜ï¼ˆé™¤éå¼ºåˆ¶åˆ·æ–°ï¼‰
  if (!force_refresh) {
    const cached = await db.collection('wiki_entries')
      .where({
        source_url: url,
        cache_expires_at: db.command.gte(new Date())
      })
      .get();
    
    if (cached.data.length > 0) {
      console.log('[wiki-parse-url] è¿”å›ç¼“å­˜æ•°æ®');
      return {
        code: 0,
        message: 'æˆåŠŸï¼ˆæ¥è‡ªç¼“å­˜ï¼‰',
        data: cached.data[0],
        from_cache: true
      };
    }
  }
  
  // 3. æŠ“å–ç½‘é¡µå†…å®¹
  let html;
  try {
    console.log('[wiki-parse-url] å¼€å§‹æŠ“å–ç½‘é¡µ...');
    const response = await got(url, {
      timeout: 15000,
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8'
      },
      retry: {
        limit: 2,
        methods: ['GET']
      }
    });
    html = response.body;
    console.log('[wiki-parse-url] ç½‘é¡µæŠ“å–æˆåŠŸ');
  } catch (error) {
    console.error('[wiki-parse-url] æŠ“å–å¤±è´¥:', error);
    return {
      code: 500,
      message: 'ç½‘é¡µæŠ“å–å¤±è´¥: ' + error.message
    };
  }
  
  // 4. è§£æHTMLå†…å®¹
  let parsedData;
  try {
    console.log('[wiki-parse-url] å¼€å§‹è§£æHTML...');
    parsedData = parseWikiContent(html, url, validationResult.site_type);
    console.log('[wiki-parse-url] HTMLè§£ææˆåŠŸ');
  } catch (error) {
    console.error('[wiki-parse-url] è§£æå¤±è´¥:', error);
    return {
      code: 500,
      message: 'HTMLè§£æå¤±è´¥: ' + error.message
    };
  }
  
  // 5. å†…å®¹å®¡æ ¸ï¼ˆç®€å•çš„æ•æ„Ÿè¯è¿‡æ»¤ï¼‰
  const auditResult = await simpleContentAudit(parsedData.content.text);
  if (!auditResult.pass) {
    console.warn('[wiki-parse-url] å†…å®¹å®¡æ ¸æœªé€šè¿‡');
    return {
      code: 403,
      message: 'å†…å®¹åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œæ— æ³•å±•ç¤º'
    };
  }
  
  // 6. ä¿å­˜åˆ°æ•°æ®åº“
  try {
    // è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼š7å¤©å
    parsedData.cache_expires_at = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
    parsedData.last_fetched_at = new Date();
    parsedData.fetch_count = 1;
    parsedData.status = 1;
    parsedData.quality_score = calculateQualityScore(parsedData);
    parsedData.created_at = new Date();
    parsedData.updated_at = new Date();
    
    // åˆå§‹åŒ–ç»Ÿè®¡æ•°æ®
    parsedData.stats = {
      view_count: 0,
      search_count: 0,
      favorite_count: 0
    };
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    const existing = await db.collection('wiki_entries')
      .where({ source_url: url })
      .get();
    
    if (existing.data.length > 0) {
      // æ›´æ–°ç°æœ‰è®°å½•
      await db.collection('wiki_entries')
        .doc(existing.data[0]._id)
        .update({
          ...parsedData,
          fetch_count: db.command.inc(1),
          stats: existing.data[0].stats // ä¿ç•™åŸæœ‰ç»Ÿè®¡æ•°æ®
        });
      parsedData._id = existing.data[0]._id;
      console.log('[wiki-parse-url] æ›´æ–°ç°æœ‰è¯æ¡');
    } else {
      // æ’å…¥æ–°è®°å½•
      const result = await db.collection('wiki_entries').add(parsedData);
      parsedData._id = result.id;
      console.log('[wiki-parse-url] æ’å…¥æ–°è¯æ¡');
    }
  } catch (error) {
    console.error('[wiki-parse-url] æ•°æ®åº“æ“ä½œå¤±è´¥:', error);
    return {
      code: 500,
      message: 'æ•°æ®ä¿å­˜å¤±è´¥: ' + error.message
    };
  }
  
  // 7. å¢åŠ ç”¨æˆ·ç»éªŒå€¼ï¼ˆå¦‚æœç”¨æˆ·å·²ç™»å½•ï¼‰
  if (event.userId) {
    try {
      await uniCloud.callFunction({
        name: 'user-add-exp',
        data: {
          userId: event.userId,
          expType: 'VIEW_WIKI',
          amount: 2
        }
      });
    } catch (err) {
      console.error('[wiki-parse-url] å¢åŠ ç»éªŒå€¼å¤±è´¥:', err);
    }
  }
  
  console.log('[wiki-parse-url] è§£æå®Œæˆ');
  return {
    code: 0,
    message: 'è§£ææˆåŠŸ',
    data: parsedData,
    from_cache: false
  };
};

/**
 * éªŒè¯URLæ˜¯å¦ä¸ºæ”¯æŒçš„ç™¾ç§‘ç«™ç‚¹
 */
function validateUrl(url) {
  const supportedSites = [
    {
      pattern: /wiki\.bloodontheclocktower\.com/i,
      type: 'official_wiki',
      name: 'Blood on the Clocktower Official Wiki'
    },
    {
      pattern: /botc\.wiki/i,
      type: 'community_wiki_cn',
      name: 'è¡€æŸ“é’Ÿæ¥¼ä¸­æ–‡Wiki'
    }
  ];
  
  for (const site of supportedSites) {
    if (site.pattern.test(url)) {
      return {
        valid: true,
        site_type: site.type,
        site_name: site.name
      };
    }
  }
  
  return {
    valid: false,
    message: 'ä¸æ”¯æŒçš„ç™¾ç§‘ç«™ç‚¹ï¼Œè¯·ä½¿ç”¨å®˜æ–¹Wikiæˆ–ç¤¾åŒºWikiçš„é“¾æ¥'
  };
}

/**
 * è§£æWikiå†…å®¹
 */
function parseWikiContent(html, url, siteType) {
  const $ = cheerio.load(html);
  
  // æ ¹æ®ä¸åŒç«™ç‚¹ç±»å‹é€‰æ‹©ä¸åŒçš„è§£æå™¨
  if (siteType === 'official_wiki') {
    return parseOfficialWiki($, url);
  } else if (siteType === 'community_wiki_cn') {
    return parseCommunityWikiCN($, url);
  } else {
    return parseGenericWiki($, url);
  }
}

/**
 * è§£æå®˜æ–¹Wikiï¼ˆè‹±æ–‡ï¼‰
 */
function parseOfficialWiki($, url) {
  // æå–æ ‡é¢˜
  const titleEn = $('#firstHeading').text().trim() || $('h1.page-title').text().trim();
  
  // æå–ä¸»è¦å†…å®¹åŒºåŸŸ
  const $content = $('#mw-content-text, .mw-parser-output').first();
  
  // ç§»é™¤ä¸éœ€è¦çš„å…ƒç´ 
  $content.find('.navigation, .printfooter, .catlinks, script, style').remove();
  
  // æå–çº¯æ–‡æœ¬
  const contentText = $content.text().replace(/\s+/g, ' ').trim();
  
  // æå–ç»“æ„åŒ–æ®µè½
  const sections = [];
  $content.children('h2, h3').each((i, elem) => {
    const $heading = $(elem);
    const heading = $heading.text().replace(/\[edit\]/g, '').trim();
    const level = parseInt(elem.name.substring(1)); // h2 -> 2, h3 -> 3
    
    // è·å–è¯¥æ ‡é¢˜ä¸‹çš„å†…å®¹ï¼ˆç›´åˆ°ä¸‹ä¸€ä¸ªæ ‡é¢˜ï¼‰
    const $contentElems = $heading.nextUntil('h2, h3');
    const sectionContent = $contentElems.text().trim();
    
    if (heading && sectionContent) {
      sections.push({
        heading,
        content: sectionContent,
        level
      });
    }
  });
  
  // æå–å›¾ç‰‡
  const images = [];
  $content.find('img').each((i, elem) => {
    const src = $(elem).attr('src') || $(elem).attr('data-src');
    if (src && !src.includes('icon')) {
      const fullSrc = src.startsWith('http') ? src : 'https://wiki.bloodontheclocktower.com' + src;
      images.push(fullSrc);
    }
  });
  
  // æå–ä¿¡æ¯æ¡†æ•°æ®ï¼ˆè§’è‰²ä¸“å±ï¼‰
  const roleInfo = extractRoleInfo($);
  
  // åˆ¤æ–­è¯æ¡ç±»å‹
  const entryType = detectEntryType(titleEn, contentText, roleInfo);
  
  // æå–å…³é”®è¯
  const keywords = extractKeywords(titleEn, contentText);
  
  return {
    entry_type: entryType,
    title: titleEn,
    title_en: titleEn,
    title_zh: '', // å®˜æ–¹Wikiæ— ä¸­æ–‡
    source_url: url,
    source_type: 'official_wiki',
    source_site: 'Blood on the Clocktower Official Wiki',
    content: {
      text: contentText.substring(0, 10000), // é™åˆ¶é•¿åº¦
      html: $content.html(),
      sections: sections.slice(0, 20), // æœ€å¤š20ä¸ªæ®µè½
      summary: contentText.substring(0, 200)
    },
    role_info: roleInfo,
    media: {
      icon_url: extractIconUrl($),
      images: images.slice(0, 10), // æœ€å¤š10å¼ å›¾ç‰‡
      video_url: null
    },
    tags: extractTags($),
    keywords: keywords,
    related_entries: []
  };
}

/**
 * è§£æä¸­æ–‡ç¤¾åŒºWiki
 */
function parseCommunityWikiCN($, url) {
  // ç±»ä¼¼é€»è¾‘ï¼Œä½†é€‚é…ä¸­æ–‡Wikiçš„HTMLç»“æ„
  const titleZh = $('#firstHeading, h1').first().text().trim();
  
  // ... ç±»ä¼¼çš„è§£æé€»è¾‘ï¼Œæ­¤å¤„çœç•¥
  
  return {
    entry_type: 'role',
    title: titleZh,
    title_zh: titleZh,
    title_en: '',
    source_url: url,
    source_type: 'community_wiki_cn',
    source_site: 'è¡€æŸ“é’Ÿæ¥¼ä¸­æ–‡Wiki',
    // ... å…¶ä»–å­—æ®µ
  };
}

/**
 * é€šç”¨Wikiè§£æå™¨ï¼ˆå…œåº•ï¼‰
 */
function parseGenericWiki($, url) {
  const title = $('h1').first().text().trim();
  const content = $('article, .content, #content, main').first().text().trim();
  
  return {
    entry_type: 'term',
    title: title,
    source_url: url,
    content: {
      text: content.substring(0, 10000),
      summary: content.substring(0, 200)
    }
  };
}

/**
 * æå–è§’è‰²ä¿¡æ¯
 */
function extractRoleInfo($) {
  const roleInfo = {
    team: null,
    team_name_zh: null,
    ability: null,
    ability_type: null,
    script_belongs: [],
    is_jinx: false,
    jinx_with: []
  };
  
  // ä»ä¿¡æ¯æ¡†ä¸­æå–
  $('.infobox tr, .character-info tr').each((i, elem) => {
    const key = $(elem).find('th').text().trim().toLowerCase();
    const value = $(elem).find('td').text().trim();
    
    if (key.includes('team') || key.includes('é˜µè¥')) {
      roleInfo.team = detectTeam(value);
      roleInfo.team_name_zh = value;
    }
    
    if (key.includes('ability') || key.includes('èƒ½åŠ›')) {
      roleInfo.ability = value;
    }
    
    if (key.includes('script') || key.includes('å‰§æœ¬')) {
      roleInfo.script_belongs = value.split(/[,ï¼Œã€]/);
    }
  });
  
  // æ£€æµ‹æ˜¯å¦æœ‰ç¦å¿Œ
  const fullText = $('body').text();
  if (fullText.includes('jinx') || fullText.includes('ç¦å¿Œ')) {
    roleInfo.is_jinx = true;
  }
  
  return roleInfo;
}

/**
 * æ£€æµ‹é˜µè¥ç±»å‹
 */
function detectTeam(teamText) {
  const teamLower = teamText.toLowerCase();
  if (teamLower.includes('townsfolk') || teamLower.includes('é•‡æ°‘')) {
    return 'townsfolk';
  } else if (teamLower.includes('outsider') || teamLower.includes('å¤–æ¥è€…')) {
    return 'outsider';
  } else if (teamLower.includes('minion') || teamLower.includes('çˆªç‰™')) {
    return 'minion';
  } else if (teamLower.includes('demon') || teamLower.includes('æ¶é­”')) {
    return 'demon';
  }
  return null;
}

/**
 * åˆ¤æ–­è¯æ¡ç±»å‹
 */
function detectEntryType(title, content, roleInfo) {
  // å¦‚æœæœ‰è§’è‰²ä¿¡æ¯ï¼Œåˆ™ä¸ºè§’è‰²
  if (roleInfo && roleInfo.team) {
    return 'role';
  }
  
  // æ£€æŸ¥æ ‡é¢˜å’Œå†…å®¹å…³é”®è¯
  const combined = (title + ' ' + content).toLowerCase();
  
  if (combined.includes('script') || combined.includes('å‰§æœ¬')) {
    return 'script';
  } else if (combined.includes('rule') || combined.includes('è§„åˆ™')) {
    return 'rule';
  } else {
    return 'term';
  }
}

/**
 * æå–å›¾æ ‡URL
 */
function extractIconUrl($) {
  // æŸ¥æ‰¾è§’è‰²å›¾æ ‡
  const iconSrc = $('.character-icon img, .role-icon img, .infobox img').first().attr('src');
  if (iconSrc) {
    return iconSrc.startsWith('http') ? iconSrc : 'https://wiki.bloodontheclocktower.com' + iconSrc;
  }
  return null;
}

/**
 * æå–æ ‡ç­¾
 */
function extractTags($) {
  const tags = [];
  $('.category, .tag, .label').each((i, elem) => {
    const tag = $(elem).text().trim();
    if (tag) tags.push(tag);
  });
  return tags.slice(0, 10);
}

/**
 * æå–å…³é”®è¯
 */
function extractKeywords(title, content) {
  const keywords = [title];
  
  // ç®€å•çš„å…³é”®è¯æå–ï¼ˆå®é™…åº”ä½¿ç”¨NLPï¼‰
  const words = content.split(/\s+/);
  const wordFreq = {};
  
  words.forEach(word => {
    const cleaned = word.toLowerCase().replace(/[^a-z]/g, '');
    if (cleaned.length > 3) {
      wordFreq[cleaned] = (wordFreq[cleaned] || 0) + 1;
    }
  });
  
  // å–å‡ºç°é¢‘ç‡æœ€é«˜çš„å‰10ä¸ªè¯
  const topWords = Object.entries(wordFreq)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10)
    .map(entry => entry[0]);
  
  return [...keywords, ...topWords];
}

/**
 * ç®€å•çš„å†…å®¹å®¡æ ¸ï¼ˆæ•æ„Ÿè¯è¿‡æ»¤ï¼‰
 */
async function simpleContentAudit(content) {
  // æ•æ„Ÿè¯åˆ—è¡¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
  const sensitiveWords = ['æš´åŠ›', 'è‰²æƒ…', 'ååŠ¨'];
  
  for (const word of sensitiveWords) {
    if (content.includes(word)) {
      return { pass: false };
    }
  }
  
  return { pass: true };
}

/**
 * è®¡ç®—å†…å®¹è´¨é‡åˆ†æ•°
 */
function calculateQualityScore(data) {
  let score = 50; // åŸºç¡€åˆ†
  
  // æœ‰æ ‡é¢˜ +10
  if (data.title && data.title.length > 0) score += 10;
  
  // æœ‰å†…å®¹ +20
  if (data.content.text && data.content.text.length > 100) score += 20;
  
  // æœ‰æ®µè½ç»“æ„ +10
  if (data.content.sections && data.content.sections.length > 0) score += 10;
  
  // æœ‰å›¾ç‰‡ +5
  if (data.media.images && data.media.images.length > 0) score += 5;
  
  // æœ‰è§’è‰²ä¿¡æ¯ +5
  if (data.role_info && data.role_info.team) score += 5;
  
  return Math.min(score, 100);
}
```

#### package.json ä¾èµ–
```json
{
  "name": "wiki-parse-url",
  "version": "1.0.0",
  "dependencies": {
    "cheerio": "^1.0.0-rc.12",
    "got": "^11.8.6"
  }
}
```

---

### äº‘å‡½æ•°2: wiki-search

#### åŠŸèƒ½æè¿°
æœç´¢ç™¾ç§‘è¯æ¡ï¼Œæ”¯æŒæ ‡é¢˜ã€å†…å®¹ã€æ ‡ç­¾æœç´¢ã€‚

#### ä»£ç å®ç°
```javascript
// uniCloud-aliyun/cloudfunctions/wiki-search/index.js

'use strict';

exports.main = async (event, context) => {
  const { 
    keyword, 
    entry_type = null,  // ç­›é€‰ç±»å‹ï¼šrole, script, rule, term
    page = 1, 
    pageSize = 20,
    userId = null 
  } = event;
  
  if (!keyword || keyword.trim().length === 0) {
    return {
      code: 400,
      message: 'æœç´¢å…³é”®è¯ä¸èƒ½ä¸ºç©º'
    };
  }
  
  const db = uniCloud.database();
  const $ = db.command;
  
  // è®°å½•æœç´¢è¡Œä¸º
  try {
    await db.collection('wiki_search_history').add({
      user_id: userId,
      keyword: keyword.trim(),
      result_count: 0, // ç¨åæ›´æ–°
      created_at: new Date()
    });
  } catch (err) {
    console.error('[wiki-search] è®°å½•æœç´¢å¤±è´¥:', err);
  }
  
  // æ„å»ºæŸ¥è¯¢æ¡ä»¶
  const whereCondition = {
    status: 1, // åªæŸ¥è¯¢å·²å‘å¸ƒçš„
    $or: [
      { title: new RegExp(keyword, 'i') },
      { title_zh: new RegExp(keyword, 'i') },
      { title_en: new RegExp(keyword, 'i') },
      { 'content.text': new RegExp(keyword, 'i') },
      { tags: $.in([keyword]) },
      { keywords: $.elemMatch($.eq(keyword.toLowerCase())) }
    ]
  };
  
  // å¦‚æœæŒ‡å®šäº†ç±»å‹ï¼Œæ·»åŠ ç±»å‹ç­›é€‰
  if (entry_type) {
    whereCondition.entry_type = entry_type;
  }
  
  // æ‰§è¡Œæœç´¢
  const searchResult = await db.collection('wiki_entries')
    .where(whereCondition)
    .field({
      _id: true,
      entry_type: true,
      title: true,
      title_zh: true,
      title_en: true,
      'content.summary': true,
      'role_info.team': true,
      'role_info.team_name_zh': true,
      'media.icon_url': true,
      tags: true,
      'stats.view_count': true,
      'stats.favorite_count': true
    })
    .orderBy('stats.view_count', 'desc')
    .skip((page - 1) * pageSize)
    .limit(pageSize)
    .get();
  
  // å¢åŠ æœç´¢è®¡æ•°
  const entryIds = searchResult.data.map(item => item._id);
  if (entryIds.length > 0) {
    await db.collection('wiki_entries')
      .where({
        _id: $.in(entryIds)
      })
      .update({
        'stats.search_count': $.inc(1)
      });
  }
  
  return {
    code: 0,
    message: 'æœç´¢æˆåŠŸ',
    data: {
      list: searchResult.data,
      total: searchResult.data.length,
      page,
      pageSize,
      keyword
    }
  };
};
```

---

### äº‘å‡½æ•°3: wiki-detail

#### åŠŸèƒ½æè¿°
è·å–å•ä¸ªç™¾ç§‘è¯æ¡çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¹¶å¢åŠ æµè§ˆè®¡æ•°ã€‚

#### ä»£ç å®ç°
```javascript
// uniCloud-aliyun/cloudfunctions/wiki-detail/index.js

'use strict';

exports.main = async (event, context) => {
  const { entry_id, userId = null } = event;
  
  if (!entry_id) {
    return {
      code: 400,
      message: 'ç¼ºå°‘è¯æ¡ID'
    };
  }
  
  const db = uniCloud.database();
  const $ = db.command;
  
  // æŸ¥è¯¢è¯æ¡
  const result = await db.collection('wiki_entries')
    .doc(entry_id)
    .get();
  
  if (result.data.length === 0) {
    return {
      code: 404,
      message: 'è¯æ¡ä¸å­˜åœ¨'
    };
  }
  
  const entry = result.data[0];
  
  // å¢åŠ æµè§ˆè®¡æ•°
  await db.collection('wiki_entries')
    .doc(entry_id)
    .update({
      'stats.view_count': $.inc(1)
    });
  
  // å¦‚æœæœ‰ç”¨æˆ·IDï¼Œè®°å½•æµè§ˆå†å²
  if (userId) {
    try {
      await db.collection('wiki_favorites')
        .add({
          user_id: userId,
          entry_id: entry_id,
          created_at: new Date()
        });
    } catch (err) {
      // å¿½ç•¥é‡å¤è®°å½•é”™è¯¯
    }
  }
  
  // æŸ¥è¯¢ç›¸å…³è¯æ¡
  const relatedEntries = await db.collection('wiki_entries')
    .where({
      _id: $.neq(entry_id),
      entry_type: entry.entry_type,
      status: 1
    })
    .field({
      _id: true,
      title: true,
      title_zh: true,
      'content.summary': true,
      'media.icon_url': true
    })
    .orderBy('stats.view_count', 'desc')
    .limit(5)
    .get();
  
  entry.related_entries = relatedEntries.data;
  
  return {
    code: 0,
    message: 'è·å–æˆåŠŸ',
    data: entry
  };
};
```

---

## ğŸ“± å°ç¨‹åºç«¯æ”¹é€ 

### æ–¹æ¡ˆä¸€ï¼šä¿ç•™ç°æœ‰UIï¼Œæ·»åŠ URLè§£æå…¥å£

åœ¨ç°æœ‰ `wiki.vue` é¡µé¢é¡¶éƒ¨æ·»åŠ ä¸€ä¸ª"å¯¼å…¥ç™¾ç§‘"æŒ‰é’®ï¼š

```vue
<template>
  <view class="page">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <view class="header">
      <text class="header-title">è¡€æŸ“ç™¾ç§‘</text>
      <text class="header-subtitle">Blood on the Clocktower Encyclopedia</text>
    </view>

    <!-- æ–°å¢ï¼šURLå¯¼å…¥åŒºåŸŸ -->
    <view class="import-section">
      <button class="import-btn" @click="showImportDialog">
        ğŸ”— å¯¼å…¥ç™¾ç§‘é“¾æ¥
      </button>
    </view>

    <!-- åŸæœ‰çš„æœç´¢æ å’Œå†…å®¹... -->
    <!-- ... -->
  </view>
  
  <!-- URLè¾“å…¥å¼¹çª— -->
  <uni-popup ref="importPopup" type="center">
    <view class="import-dialog">
      <view class="dialog-title">å¯¼å…¥ç™¾ç§‘é“¾æ¥</view>
      <textarea 
        class="url-input"
        v-model="importUrl"
        placeholder="ç²˜è´´ç™¾ç§‘URLï¼Œä¾‹å¦‚ï¼šhttps://wiki.bloodontheclocktower.com/..."
        maxlength="500"
      />
      <view class="dialog-actions">
        <button class="btn-cancel" @click="cancelImport">å–æ¶ˆ</button>
        <button 
          class="btn-confirm" 
          :loading="importing"
          @click="importWiki"
        >
          {{ importing ? 'è§£æä¸­...' : 'å¯¼å…¥' }}
        </button>
      </view>
    </view>
  </uni-popup>
</template>

<script>
export default {
  data() {
    return {
      importUrl: '',
      importing: false,
      // ... åŸæœ‰æ•°æ®
    }
  },
  
  methods: {
    // æ˜¾ç¤ºå¯¼å…¥å¼¹çª—
    showImportDialog() {
      this.$refs.importPopup.open();
    },
    
    // å–æ¶ˆå¯¼å…¥
    cancelImport() {
      this.importUrl = '';
      this.$refs.importPopup.close();
    },
    
    // å¯¼å…¥ç™¾ç§‘
    async importWiki() {
      if (!this.importUrl.trim()) {
        uni.showToast({
          title: 'è¯·è¾“å…¥ç™¾ç§‘é“¾æ¥',
          icon: 'none'
        });
        return;
      }
      
      this.importing = true;
      
      try {
        const res = await uniCloud.callFunction({
          name: 'wiki-parse-url',
          data: {
            url: this.importUrl.trim(),
            userId: this.userId
          }
        });
        
        if (res.result.code === 0) {
          uni.showToast({
            title: res.result.from_cache ? 'å·²åŠ è½½' : 'å¯¼å…¥æˆåŠŸ',
            icon: 'success'
          });
          
          // å…³é—­å¼¹çª—
          this.$refs.importPopup.close();
          this.importUrl = '';
          
          // è·³è½¬åˆ°è¯¦æƒ…é¡µ
          setTimeout(() => {
            this.showWikiDetail(res.result.data);
          }, 500);
        } else {
          uni.showToast({
            title: res.result.message || 'å¯¼å…¥å¤±è´¥',
            icon: 'none',
            duration: 2000
          });
        }
      } catch (error) {
        console.error('å¯¼å…¥å¤±è´¥', error);
        uni.showToast({
          title: 'å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥',
          icon: 'none'
        });
      } finally {
        this.importing = false;
      }
    },
    
    // æ˜¾ç¤ºç™¾ç§‘è¯¦æƒ…
    showWikiDetail(entry) {
      // å¯ä»¥æ˜¾ç¤ºåœ¨å¼¹çª—ä¸­ï¼Œæˆ–è·³è½¬åˆ°æ–°é¡µé¢
      uni.showModal({
        title: entry.title || entry.title_zh,
        content: entry.content.summary || entry.content.text.substring(0, 200),
        confirmText: 'æŸ¥çœ‹å®Œæ•´',
        success: (res) => {
          if (res.confirm) {
            // è·³è½¬åˆ°è¯¦æƒ…é¡µ
            uni.navigateTo({
              url: `/pages/tools/wiki/detail?id=${entry._id}`
            });
          }
        }
      });
    },
    
    // ... åŸæœ‰æ–¹æ³•
  }
}
</script>

<style scoped>
/* å¯¼å…¥åŒºåŸŸ */
.import-section {
  padding: 24rpx;
}

.import-btn {
  width: 100%;
  height: 80rpx;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-size: 28rpx;
  font-weight: 500;
  border-radius: 12rpx;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* å¯¼å…¥å¼¹çª— */
.import-dialog {
  width: 600rpx;
  background: white;
  border-radius: 24rpx;
  padding: 48rpx 32rpx;
}

.dialog-title {
  font-size: 34rpx;
  font-weight: bold;
  color: #1A1A1A;
  text-align: center;
  margin-bottom: 32rpx;
}

.url-input {
  width: 100%;
  min-height: 200rpx;
  padding: 24rpx;
  background: #F5F5F5;
  border-radius: 12rpx;
  font-size: 26rpx;
  line-height: 1.6;
  margin-bottom: 32rpx;
}

.dialog-actions {
  display: flex;
  gap: 16rpx;
}

.btn-cancel, .btn-confirm {
  flex: 1;
  height: 80rpx;
  border-radius: 12rpx;
  font-size: 28rpx;
  border: none;
}

.btn-cancel {
  background: #F5F5F5;
  color: #666;
}

.btn-confirm {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

/* ... åŸæœ‰æ ·å¼ */
</style>
```

---

### æ–¹æ¡ˆäºŒï¼šåˆ›å»ºä¸“é—¨çš„ç™¾ç§‘è¯¦æƒ…é¡µ

åˆ›å»ºæ–°é¡µé¢ `pages/tools/wiki/detail.vue`ï¼š

```vue
<template>
  <view class="detail-page">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view v-if="loading" class="loading">
      <uni-load-more status="loading" />
    </view>
    
    <!-- å†…å®¹åŒºåŸŸ -->
    <view v-else-if="entry" class="content">
      <!-- å¤´éƒ¨ä¿¡æ¯ -->
      <view class="header">
        <image 
          v-if="entry.media.icon_url" 
          class="icon"
          :src="entry.media.icon_url"
          mode="aspectFit"
        />
        <view class="title-area">
          <text class="title">{{ entry.title || entry.title_zh }}</text>
          <text v-if="entry.title_en && entry.title_zh" class="subtitle">
            {{ entry.title_en }}
          </text>
        </view>
      </view>
      
      <!-- è§’è‰²ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯è§’è‰²ï¼‰ -->
      <view v-if="entry.entry_type === 'role' && entry.role_info" class="role-info">
        <view class="info-item">
          <text class="label">é˜µè¥</text>
          <text class="value" :class="'team-' + entry.role_info.team">
            {{ entry.role_info.team_name_zh || entry.role_info.team }}
          </text>
        </view>
        <view class="info-item">
          <text class="label">èƒ½åŠ›</text>
          <text class="value">{{ entry.role_info.ability }}</text>
        </view>
      </view>
      
      <!-- æ–‡ç« å†…å®¹ -->
      <view class="article">
        <!-- æ‘˜è¦ -->
        <view class="summary">
          {{ entry.content.summary }}
        </view>
        
        <!-- åˆ†æ®µå†…å®¹ -->
        <view 
          v-for="(section, index) in entry.content.sections" 
          :key="index"
          class="section"
        >
          <text class="section-heading" :class="'level-' + section.level">
            {{ section.heading }}
          </text>
          <text class="section-content">{{ section.content }}</text>
        </view>
      </view>
      
      <!-- ç›¸å…³å›¾ç‰‡ -->
      <view v-if="entry.media.images.length > 0" class="images">
        <text class="section-title">ç›¸å…³å›¾ç‰‡</text>
        <view class="image-grid">
          <image 
            v-for="(img, index) in entry.media.images" 
            :key="index"
            class="grid-image"
            :src="img"
            mode="aspectFill"
            @click="previewImage(img)"
          />
        </view>
      </view>
      
      <!-- ç›¸å…³è¯æ¡ -->
      <view v-if="entry.related_entries.length > 0" class="related">
        <text class="section-title">ç›¸å…³è¯æ¡</text>
        <view 
          v-for="related in entry.related_entries" 
          :key="related._id"
          class="related-item"
          @click="goToEntry(related._id)"
        >
          <text class="related-title">{{ related.title || related.title_zh }}</text>
          <text class="related-arrow">â€º</text>
        </view>
      </view>
      
      <!-- åº•éƒ¨æ“ä½œæ  -->
      <view class="footer">
        <button class="action-btn" @click="toggleFavorite">
          {{ isFavorite ? 'ğŸ’› å·²æ”¶è—' : 'ğŸ¤ æ”¶è—' }}
        </button>
        <button class="action-btn" @click="shareEntry">
          ğŸ“¤ åˆ†äº«
        </button>
        <button class="action-btn" @click="openSource">
          ğŸ”— æŸ¥çœ‹åŸæ–‡
        </button>
      </view>
    </view>
    
    <!-- é”™è¯¯çŠ¶æ€ -->
    <view v-else class="error">
      <text class="error-text">åŠ è½½å¤±è´¥</text>
      <button class="retry-btn" @click="loadEntry">é‡è¯•</button>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      entryId: '',
      entry: null,
      loading: true,
      isFavorite: false
    }
  },
  
  onLoad(options) {
    this.entryId = options.id;
    this.loadEntry();
  },
  
  methods: {
    // åŠ è½½è¯æ¡
    async loadEntry() {
      this.loading = true;
      
      try {
        const res = await uniCloud.callFunction({
          name: 'wiki-detail',
          data: {
            entry_id: this.entryId,
            userId: this.userId
          }
        });
        
        if (res.result.code === 0) {
          this.entry = res.result.data;
        } else {
          uni.showToast({
            title: 'åŠ è½½å¤±è´¥',
            icon: 'none'
          });
        }
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥', error);
      } finally {
        this.loading = false;
      }
    },
    
    // é¢„è§ˆå›¾ç‰‡
    previewImage(img) {
      uni.previewImage({
        urls: this.entry.media.images,
        current: img
      });
    },
    
    // è·³è½¬åˆ°å…¶ä»–è¯æ¡
    goToEntry(id) {
      uni.navigateTo({
        url: `/pages/tools/wiki/detail?id=${id}`
      });
    },
    
    // æ”¶è—/å–æ¶ˆæ”¶è—
    async toggleFavorite() {
      // TODO: å®ç°æ”¶è—åŠŸèƒ½
      this.isFavorite = !this.isFavorite;
      uni.showToast({
        title: this.isFavorite ? 'å·²æ”¶è—' : 'å·²å–æ¶ˆ',
        icon: 'success'
      });
    },
    
    // åˆ†äº«è¯æ¡
    shareEntry() {
      // TODO: å®ç°åˆ†äº«åŠŸèƒ½
    },
    
    // æ‰“å¼€åŸæ–‡é“¾æ¥
    openSource() {
      // å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
      uni.setClipboardData({
        data: this.entry.source_url,
        success: () => {
          uni.showToast({
            title: 'é“¾æ¥å·²å¤åˆ¶',
            icon: 'success'
          });
        }
      });
    }
  }
}
</script>

<style scoped>
.detail-page {
  min-height: 100vh;
  background: #F5F5F5;
}

.loading, .error {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 80vh;
}

.content {
  padding: 32rpx;
  padding-bottom: 160rpx; /* ä¸ºåº•éƒ¨æ“ä½œæ ç•™ç©ºé—´ */
}

/* å¤´éƒ¨ */
.header {
  display: flex;
  align-items: center;
  margin-bottom: 32rpx;
  padding: 32rpx;
  background: white;
  border-radius: 16rpx;
}

.icon {
  width: 120rpx;
  height: 120rpx;
  margin-right: 24rpx;
  border-radius: 12rpx;
}

.title-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8rpx;
}

.title {
  font-size: 40rpx;
  font-weight: bold;
  color: #1A1A1A;
}

.subtitle {
  font-size: 28rpx;
  color: #666;
}

/* è§’è‰²ä¿¡æ¯ */
.role-info {
  background: white;
  border-radius: 16rpx;
  padding: 32rpx;
  margin-bottom: 32rpx;
}

.info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20rpx 0;
  border-bottom: 1rpx solid #F0F0F0;
}

.info-item:last-child {
  border-bottom: none;
}

.label {
  font-size: 28rpx;
  color: #666;
  font-weight: 500;
}

.value {
  font-size: 28rpx;
  color: #1A1A1A;
}

.team-townsfolk { color: #52c41a; }
.team-outsider { color: #faad14; }
.team-minion { color: #f97316; }
.team-demon { color: #ef4444; }

/* æ–‡ç« å†…å®¹ */
.article {
  background: white;
  border-radius: 16rpx;
  padding: 32rpx;
  margin-bottom: 32rpx;
}

.summary {
  font-size: 30rpx;
  color: #333;
  line-height: 1.8;
  margin-bottom: 32rpx;
  padding-bottom: 32rpx;
  border-bottom: 2rpx solid #F0F0F0;
}

.section {
  margin-bottom: 32rpx;
}

.section-heading {
  display: block;
  font-size: 32rpx;
  font-weight: bold;
  color: #1A1A1A;
  margin-bottom: 16rpx;
}

.section-heading.level-3 {
  font-size: 28rpx;
  font-weight: 500;
}

.section-content {
  display: block;
  font-size: 28rpx;
  color: #666;
  line-height: 1.8;
}

/* å›¾ç‰‡ç½‘æ ¼ */
.images {
  background: white;
  border-radius: 16rpx;
  padding: 32rpx;
  margin-bottom: 32rpx;
}

.section-title {
  display: block;
  font-size: 32rpx;
  font-weight: bold;
  color: #1A1A1A;
  margin-bottom: 24rpx;
}

.image-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16rpx;
}

.grid-image {
  width: 100%;
  height: 200rpx;
  border-radius: 12rpx;
  background: #F5F5F5;
}

/* ç›¸å…³è¯æ¡ */
.related {
  background: white;
  border-radius: 16rpx;
  padding: 32rpx;
  margin-bottom: 32rpx;
}

.related-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 24rpx 0;
  border-bottom: 1rpx solid #F0F0F0;
}

.related-item:last-child {
  border-bottom: none;
}

.related-title {
  font-size: 28rpx;
  color: #333;
}

.related-arrow {
  font-size: 40rpx;
  color: #ccc;
}

/* åº•éƒ¨æ“ä½œæ  */
.footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  gap: 16rpx;
  padding: 24rpx 32rpx;
  padding-bottom: calc(24rpx + env(safe-area-inset-bottom));
  background: white;
  box-shadow: 0 -4rpx 20rpx rgba(0, 0, 0, 0.05);
}

.action-btn {
  flex: 1;
  height: 80rpx;
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  color: white;
  font-size: 26rpx;
  border-radius: 12rpx;
  border: none;
}

.action-btn:nth-child(2) {
  background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.action-btn:nth-child(3) {
  background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
}
</style>
```

---

## âš ï¸ æŠ€æœ¯å¯è¡Œæ€§åˆ†æ

### âœ… å¯è¡Œæ€§
1. **uniCloud äº‘å‡½æ•°æ— è·¨åŸŸé™åˆ¶**
   - å¯ä»¥è®¿é—®ä»»ä½•ç½‘ç«™
   - ä¸å—å°ç¨‹åºåŸŸåç™½åå•é™åˆ¶

2. **HTML è§£ææŠ€æœ¯æˆç†Ÿ**
   - cheerio åº“åŠŸèƒ½å¼ºå¤§
   - ç±»ä¼¼ jQuery çš„è¯­æ³•ï¼Œæ˜“äºä½¿ç”¨

3. **ç¼“å­˜æœºåˆ¶å®Œå–„**
   - äº‘æ•°æ®åº“ç¼“å­˜
   - æœ¬åœ°å­˜å‚¨ç¼“å­˜
   - å‡å°‘é‡å¤æŠ“å–

### âš ï¸ æ³¨æ„äº‹é¡¹

#### 1. æ³•å¾‹åˆè§„
- âœ… **éµå®ˆ robots.txt**ï¼šæ£€æŸ¥ç›®æ ‡ç½‘ç«™çš„çˆ¬è™«åè®®
- âœ… **æ ‡æ³¨æ¥æº**ï¼šæ˜ç¡®æ˜¾ç¤ºå†…å®¹æ¥æº
- âœ… **ä»…ç”¨äºå±•ç¤º**ï¼šä¸åšå•†ä¸šç”¨é€”
- âš ï¸ **è·å–æˆæƒ**ï¼šæœ€å¥½ä¸ç›®æ ‡ç½‘ç«™å–å¾—è”ç³»

#### 2. æŠ€æœ¯é™åˆ¶
- âš ï¸ **åŠ¨æ€å†…å®¹**ï¼šJavaScript æ¸²æŸ“çš„å†…å®¹æ— æ³•è·å–
- âš ï¸ **åçˆ¬è™«**ï¼šå¯èƒ½è¢«ç›®æ ‡ç½‘ç«™å°ç¦
- âš ï¸ **ç½‘ç«™ç»“æ„å˜åŒ–**ï¼šéœ€è¦å®šæœŸæ›´æ–°è§£æè§„åˆ™

#### 3. æ€§èƒ½è€ƒè™‘
- âš ï¸ **æŠ“å–è€—æ—¶**ï¼šé¦–æ¬¡æŠ“å–éœ€è¦ 3-5 ç§’
- âš ï¸ **äº‘å‡½æ•°æˆæœ¬**ï¼šé¢‘ç¹è°ƒç”¨ä¼šäº§ç”Ÿè´¹ç”¨
- âœ… **ç¼“å­˜ä¼˜åŒ–**ï¼šé€šè¿‡ç¼“å­˜é™ä½æˆæœ¬

---

## ğŸ“ˆ å¼€å‘è®¡åˆ’

### é˜¶æ®µä¸€ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆ2å‘¨ï¼‰
- [ ] æ•°æ®åº“è¡¨è®¾è®¡
- [ ] `wiki-parse-url` äº‘å‡½æ•°å¼€å‘
- [ ] `wiki-detail` äº‘å‡½æ•°å¼€å‘
- [ ] å°ç¨‹åºUIæ”¹é€ 
- [ ] åŸºç¡€æµ‹è¯•

### é˜¶æ®µäºŒï¼šæœç´¢ä¸ç¼“å­˜ï¼ˆ1å‘¨ï¼‰
- [ ] `wiki-search` äº‘å‡½æ•°å¼€å‘
- [ ] ç¼“å­˜ç­–ç•¥å®ç°
- [ ] æœç´¢é¡µé¢å¼€å‘
- [ ] æ€§èƒ½ä¼˜åŒ–

### é˜¶æ®µä¸‰ï¼šä¼˜åŒ–ä¸å®Œå–„ï¼ˆ1å‘¨ï¼‰
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- [ ] å®šæ—¶ä»»åŠ¡é…ç½®
- [ ] å…¨é¢æµ‹è¯•

**æ€»å¼€å‘æ—¶é—´**ï¼š4å‘¨ï¼ˆçº¦80-100å°æ—¶ï¼‰

---

## ğŸ’° æˆæœ¬ä¼°ç®—

### uniCloud è´¹ç”¨ï¼ˆå‡è®¾1000ç”¨æˆ·ï¼‰
- **äº‘å‡½æ•°è°ƒç”¨**ï¼šçº¦ 10ä¸‡æ¬¡/æœˆ â†’ Â¥13/æœˆ
- **äº‘æ•°æ®åº“**ï¼šçº¦ 1GB å­˜å‚¨ â†’ å…è´¹é¢åº¦å†…
- **äº‘å­˜å‚¨**ï¼šçº¦ 2GB â†’ å…è´¹é¢åº¦å†…
- **æ€»è®¡**ï¼šçº¦ Â¥150/å¹´

### ç»´æŠ¤æˆæœ¬
- **è§„åˆ™æ›´æ–°**ï¼šæ¯æœˆ 2-4 å°æ—¶
- **å†…å®¹å®¡æ ¸**ï¼šæ¯å‘¨ 1-2 å°æ—¶

---

## ğŸ¯ æ€»ç»“

### âœ… æ¨èæ–¹æ¡ˆ
**äº‘å‡½æ•°åç«¯æŠ“å– + å¤šçº§ç¼“å­˜ + å®šæ—¶æ›´æ–°**

### æ ¸å¿ƒä¼˜åŠ¿
1. âœ… æŠ€æœ¯å¯è¡Œï¼Œç¬¦åˆå°ç¨‹åºè§„èŒƒ
2. âœ… æˆæœ¬å¯æ§ï¼Œæ— éœ€é¢å¤–æœåŠ¡å™¨
3. âœ… å†…å®¹ä¸°å¯Œï¼Œå®æ—¶åŒæ­¥å®˜æ–¹
4. âœ… ç”¨æˆ·ä½“éªŒå¥½ï¼Œå“åº”é€Ÿåº¦å¿«

### é£é™©æç¤º
1. âš ï¸ éœ€è¦éµå®ˆç›®æ ‡ç½‘ç«™çš„çˆ¬è™«åè®®
2. âš ï¸ ç½‘ç«™ç»“æ„å˜åŒ–éœ€è¦æ›´æ–°è§£æè§„åˆ™
3. âš ï¸ å»ºè®®ä¸å®˜æ–¹å–å¾—æˆæƒ

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨
1. **è¯„ä¼°æ³•å¾‹é£é™©**ï¼šè”ç³»ç™¾ç§‘ç½‘ç«™è·å–æˆæƒ
2. **å¼€å‘åŸå‹**ï¼šå…ˆå®ç°æ ¸å¿ƒåŠŸèƒ½éªŒè¯å¯è¡Œæ€§
3. **å°èŒƒå›´æµ‹è¯•**ï¼šé‚€è¯·ç”¨æˆ·è¯•ç”¨å¹¶æ”¶é›†åé¦ˆ
4. **æ­£å¼ä¸Šçº¿**ï¼šå®Œå–„åå‘æ‰€æœ‰ç”¨æˆ·å¼€æ”¾

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**åˆ›å»ºæ—¶é—´**: 2025å¹´10æœˆ17æ—¥  
**ç»´æŠ¤äººå‘˜**: å¼€å‘å›¢é˜Ÿ

