# Wiki v2.2 部署检查清单

## 📋 部署前检查

### 环境检查
- [ ] HBuilderX已安装并更新到最新版本
- [ ] uniCloud账号正常，有足够的云函数调用额度
- [ ] 已备份现有数据库（如有）
- [ ] 网络连接正常

### 代码检查
- [ ] 已拉取最新代码
- [ ] 检查botc-admin项目路径正确
- [ ] 确认uniCloud-aliyun目录存在

---

## 🚀 部署步骤

### 步骤1: 上传数据库Schema ⏱️ 1分钟
- [ ] 打开 `botc-admin/uniCloud-aliyun/database/wiki_role_list.schema.json`
- [ ] 右键 → **上传Schema**
- [ ] 等待上传成功提示
- [ ] 验证：uniCloud控制台 → 数据库 → wiki_role_list集合已创建

**验证命令：**
```javascript
// uniCloud Web控制台执行
db.collection('wiki_role_list').count()
// 应返回：{ total: 0 }
```

---

### 步骤2: 上传云函数 ⏱️ 3分钟

#### 2.1 wiki-role-add
- [ ] 右键 `cloudfunctions/wiki-role-add`
- [ ] 选择 **上传部署**
- [ ] 等待上传成功（绿色对勾）
- [ ] 验证：云函数列表中显示"已部署"

#### 2.2 wiki-role-list
- [ ] 右键 `cloudfunctions/wiki-role-list`
- [ ] 选择 **上传部署**
- [ ] 等待上传成功（绿色对勾）
- [ ] 验证：云函数列表中显示"已部署"

#### 2.3 wiki-role-delete
- [ ] 右键 `cloudfunctions/wiki-role-delete`
- [ ] 选择 **上传部署**
- [ ] 等待上传成功（绿色对勾）
- [ ] 验证：云函数列表中显示"已部署"

#### 2.4 wiki-role-sync
- [ ] 右键 `cloudfunctions/wiki-role-sync`
- [ ] 选择 **上传部署**
- [ ] 等待上传成功（绿色对勾）
- [ ] 验证：云函数列表中显示"已部署"

**批量验证：**
- [ ] uniCloud控制台 → 云函数
- [ ] 确认4个新云函数都显示"已部署"
- [ ] 版本号显示最新

---

### 步骤3: 运行前端 ⏱️ 1分钟
- [ ] 打开botc-admin项目
- [ ] 点击 **运行 → 运行到浏览器 → Chrome**
- [ ] 等待编译完成
- [ ] 浏览器自动打开
- [ ] 登录管理后台
- [ ] 进入"百科同步管理"页面

**验证：**
- [ ] 页面正常显示
- [ ] 没有控制台错误
- [ ] "角色管理"区域显示正常

---

## ✅ 功能测试

### 测试1: 添加角色 ⏱️ 1分钟 ⭐⭐⭐
**操作：**
```
在输入框输入：
图书管理员
哲学家
洗衣妇

点击"保存角色"
```

**预期结果：**
- [ ] 弹出提示"成功添加 3 个角色"
- [ ] 角色列表中显示3个新角色
- [ ] 状态均为"未同步"（灰色）
- [ ] 创建时间显示正确

**数据库验证：**
```javascript
db.collection('wiki_role_list').where({}).get()
// 应返回3条记录
```

---

### 测试2: 搜索功能 ⏱️ 30秒 ⭐⭐⭐
**操作：**
```
在搜索框输入：图书
等待0.5秒
```

**预期结果：**
- [ ] 只显示"图书管理员"
- [ ] 其他角色被过滤
- [ ] 搜索框显示"图书"

**清空测试：**
- [ ] 清空搜索框
- [ ] 显示所有角色

---

### 测试3: 状态筛选 ⏱️ 30秒 ⭐⭐⭐
**操作：**
```
点击筛选下拉框
选择"未同步"
```

**预期结果：**
- [ ] 只显示未同步的角色
- [ ] 筛选按钮文字变为"未同步"
- [ ] 列表正确更新

**切换测试：**
- [ ] 选择"全部状态"
- [ ] 显示所有角色

---

### 测试4: 单个同步 ⏱️ 1分钟 ⭐⭐⭐
**操作：**
```
找到"图书管理员"
点击"同步"按钮
确认同步
等待完成
```

**预期结果：**
- [ ] 显示loading状态
- [ ] 2-5秒后弹出"同步完成"
- [ ] 状态变为"已同步"（绿色）
- [ ] 显示最后同步时间
- [ ] 统计卡片中"角色"数量+1

**数据库验证：**
```javascript
// 验证wiki_role_list
db.collection('wiki_role_list')
  .where({ role_name: '图书管理员' })
  .get()
// is_synced: true, sync_status: 'success'

// 验证wiki_entries
db.collection('wiki_entries')
  .where({ title: '图书管理员' })
  .get()
// 应有完整的角色数据
```

---

### 测试5: 批量同步 ⏱️ 2分钟 ⭐⭐⭐
**操作：**
```
勾选"哲学家"和"洗衣妇"
点击"批量同步（2）"
确认同步
等待完成
```

**预期结果：**
- [ ] 批量同步按钮显示"（2）"
- [ ] 确认弹窗显示"2个角色"
- [ ] 显示loading状态
- [ ] 20-30秒后弹出"同步完成"
- [ ] 内容显示"成功 2 个，失败 0 个"
- [ ] 两个角色状态都变为"已同步"
- [ ] 统计卡片中"角色"数量+2

**数据库验证：**
```javascript
// 验证批量同步
db.collection('wiki_role_list')
  .where({ is_synced: true })
  .count()
// total: 3

db.collection('wiki_entries')
  .where({ entry_type: 'role' })
  .count()
// total: 3
```

---

### 测试6: 批量删除 ⏱️ 1分钟 ⭐⭐
**操作：**
```
勾选任意1个角色
点击"批量删除（1）"
确认删除
```

**预期结果：**
- [ ] 确认弹窗显示"1个角色"
- [ ] 显示"删除后无法恢复"警告
- [ ] 删除成功提示
- [ ] 角色从列表中消失
- [ ] 列表总数-1

**数据库验证：**
```javascript
db.collection('wiki_role_list').count()
// total: 2（从3变为2）
```

---

### 测试7: 重复添加 ⏱️ 30秒 ⭐
**操作：**
```
再次输入"图书管理员"
点击"保存角色"
```

**预期结果：**
- [ ] 提示"成功添加 0 个角色，1 个重复"
- [ ] 弹窗显示"重复角色：图书管理员"
- [ ] 列表中不出现重复记录

---

### 测试8: 全选功能 ⏱️ 30秒 ⭐
**操作：**
```
点击表头复选框
```

**预期结果：**
- [ ] 所有角色被勾选
- [ ] 批量按钮显示正确数量
- [ ] 再次点击全部取消勾选

---

### 测试9: 分页功能 ⏱️ 30秒 ⭐
**前提：** 需要有超过20个角色

**操作：**
```
点击"下一页"
```

**预期结果：**
- [ ] 显示下一页的角色
- [ ] 页码显示正确（2/3）
- [ ] "上一页"按钮可用
- [ ] 选中状态被清空

---

## 🔍 详细验证

### 验证1: 同步数据完整性
**检查角色数据包含：**
- [ ] title（角色名称）
- [ ] entry_type（role）
- [ ] content（能力描述）
- [ ] media.background_story（背景故事）
- [ ] media.character_info（角色信息）
- [ ] media.icon_url（角色图标URL）

**控制台执行：**
```javascript
db.collection('wiki_entries')
  .where({ title: '图书管理员' })
  .get()
  .then(res => {
    console.log('===== 角色数据 =====')
    console.log('标题:', res.data[0].title)
    console.log('类型:', res.data[0].entry_type)
    console.log('能力:', res.data[0].content)
    console.log('背景故事:', res.data[0].media?.background_story)
    console.log('角色信息:', res.data[0].media?.character_info)
    console.log('图标URL:', res.data[0].media?.icon_url)
  })
```

---

### 验证2: 角色状态管理
**检查状态字段：**
- [ ] is_synced（布尔值）
- [ ] sync_status（success/failed/pending）
- [ ] last_sync_time（时间戳）
- [ ] sync_error（失败时有值）

**控制台执行：**
```javascript
db.collection('wiki_role_list')
  .where({ role_name: '图书管理员' })
  .get()
  .then(res => {
    console.log('===== 状态检查 =====')
    console.log('是否已同步:', res.data[0].is_synced)
    console.log('同步状态:', res.data[0].sync_status)
    console.log('最后同步时间:', new Date(res.data[0].last_sync_time))
    console.log('错误信息:', res.data[0].sync_error)
  })
```

---

### 验证3: URL生成正确性
**检查URL格式：**
- [ ] 包含完整域名
- [ ] 包含正确的title参数
- [ ] 中文字符在浏览器中自动编码

**控制台执行：**
```javascript
db.collection('wiki_role_list')
  .where({})
  .get()
  .then(res => {
    res.data.forEach(role => {
      console.log(`${role.role_name}: ${role.role_url}`)
    })
  })

// 示例输出：
// 图书管理员: https://clocktower-wiki.gstonegames.com/index.php?title=图书管理员
```

**手动验证：**
- [ ] 复制URL到浏览器
- [ ] 能正常打开钟楼百科页面

---

## 🚨 错误处理测试

### 测试10: 同步失败处理 ⏱️ 1分钟
**操作：**
```
添加一个不存在的角色名称：
测试角色不存在

保存并同步
```

**预期结果：**
- [ ] 同步失败
- [ ] 状态显示"同步失败"（红色）
- [ ] 显示错误信息
- [ ] sync_error字段有内容

---

### 测试11: 网络错误处理 ⏱️ 1分钟
**操作：**
```
断开网络
尝试添加或同步角色
```

**预期结果：**
- [ ] 显示网络错误提示
- [ ] 不会造成数据损坏
- [ ] 恢复网络后可以重试

---

## 📊 性能测试

### 测试12: 批量添加性能 ⏱️ 2分钟
**操作：**
```
一次性添加30个角色
```

**预期结果：**
- [ ] 2秒内完成
- [ ] 所有角色正确添加
- [ ] 无重复记录

---

### 测试13: 批量同步性能 ⏱️ 5分钟
**操作：**
```
批量同步20个角色
```

**预期结果：**
- [ ] 2-3分钟内完成
- [ ] 同步成功率 > 95%
- [ ] 进度可见

---

## 🎉 部署完成检查

### 最终检查清单
- [ ] ✅ 数据库Schema已创建
- [ ] ✅ 4个云函数已部署
- [ ] ✅ 前端页面正常显示
- [ ] ✅ 添加角色功能正常
- [ ] ✅ 搜索功能正常
- [ ] ✅ 筛选功能正常
- [ ] ✅ 单个同步功能正常
- [ ] ✅ 批量同步功能正常
- [ ] ✅ 删除功能正常
- [ ] ✅ 数据完整性验证通过
- [ ] ✅ 错误处理正常
- [ ] ✅ 性能测试通过

---

## 📝 部署记录

### 部署信息
- **部署日期**: _______________
- **部署人**: _______________
- **环境**: 生产/测试
- **版本**: v2.2

### 测试结果
- **总测试项**: 13
- **通过项**: _____
- **失败项**: _____
- **通过率**: _____%

### 遇到的问题
1. _______________
2. _______________
3. _______________

### 解决方案
1. _______________
2. _______________
3. _______________

---

## 📞 问题反馈

如遇到问题，请记录：
- 问题描述
- 复现步骤
- 错误截图
- 控制台日志
- 数据库状态

---

**部署完成时间**: _______________  
**签名确认**: _______________

---

## 🎊 恭喜！

如果所有检查项都通过，说明Wiki v2.2部署成功！

下一步：
1. 📝 添加常用角色
2. 🔄 执行批量同步
3. 📱 验证小程序前端显示
4. 📊 监控运行状态

**祝使用愉快！** 🚀

