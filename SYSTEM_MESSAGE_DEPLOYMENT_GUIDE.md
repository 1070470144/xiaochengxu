# 系统消息功能部署指南

## 🎯 功能概述

实现了完整的系统消息功能：
- ✅ 管理端警告用户时发送系统消息
- ✅ 用户端"我的"页面显示消息入口和未读红点
- ✅ 系统消息列表页面
- ✅ 系统消息详情页面
- ✅ 未读消息标记和全部已读功能

---

## 📁 文件清单

### 数据库表
```
botc-miniprogram/uniCloud-aliyun/database/
└── botc-system-messages.schema.json  # 系统消息表
```

### 管理端
```
botc-admin/pages/botc/post/
└── audit-list.vue  # 帖子审核页面（已修改）
```

### 用户端
```
botc-miniprogram/pages/
├── user/
│   ├── profile/profile.vue  # 我的页面（已添加消息入口）
│   └── system-messages/
│       ├── list.vue         # 消息列表
│       └── detail.vue       # 消息详情
└── pages.json  # 已注册路由
```

---

## 🚀 部署步骤

### 第一步：上传数据库表

1. 打开 HBuilderX
2. 右键 `botc-miniprogram/uniCloud-aliyun/database/botc-system-messages.schema.json`
3. 选择"上传DB Schema"

**验证**：在 uniCloud web控制台查看是否创建成功

---

### 第二步：测试功能

#### 1. 管理端发送警告

1. 打开管理端小程序
2. 进入"帖子审核管理"
3. 点击某个帖子的"隐藏"按钮
4. 在弹窗中选择"隐藏并警告"
5. 系统会同时：
   - 隐藏该帖子
   - 向发帖用户发送警告消息

#### 2. 用户端查看消息

1. 打开用户端小程序
2. 进入"我的"页面
3. 查看右上角：
   - 🔔 消息按钮
   - 如有未读消息，显示红点数字
4. 点击消息按钮查看消息列表
5. 点击消息查看详情

---

## 📊 数据结构

### 系统消息表（botc-system-messages）

```json
{
  "_id": "xxx",
  "user_id": "接收用户ID",
  "type": "warning",              // warning=警告 notice=通知 system=系统
  "title": "内容违规警告",
  "content": "您发布的帖子因违反社区规范已被隐藏...",
  "related_type": "post",         // 关联类型
  "related_id": "帖子ID",          // 关联对象ID
  "is_read": false,               // 是否已读
  "read_at": 1234567890,          // 阅读时间
  "created_at": 1234567890
}
```

---

## 🎨 UI 效果

### 我的页面

```
┌─────────────────────────────────────┐
│                          🔔 [3] 🖼️  │ ← 右上角消息入口
│  用户头像                           │
│  用户昵称 ⭐                        │
│  等级信息                           │
└─────────────────────────────────────┘
```

### 消息列表

```
┌─────────────────────────────────────┐
│  系统消息              [全部已读]    │
├─────────────────────────────────────┤
│  ⚠️  内容违规警告       10分钟前  ●  │
│      您发布的帖子因违反...           │
├─────────────────────────────────────┤
│  📢  系统通知           1小时前       │
│      欢迎使用血染钟楼平台...         │
└─────────────────────────────────────┘
```

### 消息详情

```
┌─────────────────────────────────────┐
│              ⚠️                      │
│                                     │
│         内容违规警告                 │
│       2024-10-28 14:30              │
├─────────────────────────────────────┤
│  您发布的帖子"这是一个测试..."       │
│  因违反社区规范已被隐藏。请遵守      │
│  社区规则，避免发布违规内容。        │
├─────────────────────────────────────┤
│  相关内容                           │
│  查看详情                         › │
└─────────────────────────────────────┘
```

---

## 🔧 功能说明

### 1. 管理端警告流程

```
管理员点击"隐藏"按钮
    ↓
弹窗选择：
├─ 隐藏并警告 → 隐藏帖子 + 发送警告消息
└─ 仅隐藏 → 只隐藏帖子
    ↓
用户收到系统消息 ✅
```

### 2. 消息类型

| 类型 | 图标 | 用途 |
|------|------|------|
| warning | ⚠️ | 警告消息（内容违规） |
| notice | 📢 | 通知消息（活动、公告） |
| system | ℹ️ | 系统消息（升级、维护） |

### 3. 未读标记

- 消息列表：未读消息显示蓝色背景 + 右侧红点
- 消息详情：打开详情时自动标记为已读
- 全部已读：一键标记所有未读消息为已读
- 红点数字：超过99显示"99+"

---

## 💡 扩展功能

### 可以添加其他场景的系统消息

#### 1. 认证通过通知

```javascript
await db.collection('botc-system-messages').add({
  user_id: userId,
  type: 'notice',
  title: '认证审核通过',
  content: '恭喜您，您的说书人认证已通过！',
  related_type: 'certification',
  related_id: certId,
  is_read: false,
  created_at: Date.now()
})
```

#### 2. 举报处理结果

```javascript
await db.collection('botc-system-messages').add({
  user_id: reporterId,
  type: 'system',
  title: '举报处理结果',
  content: '您举报的内容已被处理，感谢您的反馈。',
  is_read: false,
  created_at: Date.now()
})
```

#### 3. 活动通知

```javascript
await db.collection('botc-system-messages').add({
  user_id: userId,
  type: 'notice',
  title: '新活动上线',
  content: '血染钟楼线下活动开始报名啦！',
  is_read: false,
  created_at: Date.now()
})
```

---

## ✅ 验证清单

- [ ] 数据库表已创建
- [ ] 管理端可以隐藏帖子并发送警告
- [ ] 用户端"我的"页面显示消息入口
- [ ] 有未读消息时显示红点数字
- [ ] 点击消息入口进入列表页
- [ ] 消息列表显示正确
- [ ] 点击消息进入详情页
- [ ] 查看详情后标记为已读
- [ ] 全部已读功能正常
- [ ] 相关内容链接可以跳转

---

## 🎉 部署完成

系统消息功能已完全实现！

**特点**：
- ✅ 完整的消息流转（发送→通知→查看→已读）
- ✅ 美观的UI设计
- ✅ 未读消息红点提示
- ✅ 消息关联跳转
- ✅ 可扩展性强

**下一步**：
1. 测试完整流程
2. 添加更多消息场景
3. 可选：添加消息推送功能

